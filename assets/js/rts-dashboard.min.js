/**
 * RTS Dashboard - Dark Mode Edition (Optimized)
 * Enhanced with performance and reliability features
 * Version: 2.1
 */

(function($) {
    'use strict';

    // Prevent duplicate initialization
    if (window.__RTS_DASHBOARD_INIT) return;
    window.__RTS_DASHBOARD_INIT = true;

    // Simple request tracker to prevent duplicates
    const pendingRequests = new Map();
    
    // Simple debounce utility
    function debounce(func, wait) {
        let timeout;
        return function executedFunction(...args) {
            clearTimeout(timeout);
            timeout = setTimeout(() => func.apply(this, args), wait);
        };
    }

    // Event delegation wrapper for better performance
    function setupEventDelegation() {
        // Single delegated handler for all dashboard actions
        $(document).on('click', handleDashboardClick);
        
        // Single delegated handler for collapsible sections
        $(document).on('click', '.rts-collapsible-header', handleCollapsibleToggle);
    }

    // Consolidated click handler
    function handleDashboardClick(e) {
        const $target = $(e.target);
        const action = $target.data('action');
        
        // Quick navigation actions
        if (action === 'review-inbox' || action === 'view-quarantine') {
            e.preventDefault();
            handleQuickNavigation(action);
            return;
        }
        
        if (action === 'refresh-status') {
            e.preventDefault();
            handleRefreshStatus();
            return;
        }
        
        // Clear import button
        if ($target.is('.rts-btn-clear, #rts-clear-import')) {
            e.preventDefault();
            handleClearImport($target);
            return;
        }
    }

    // Quick navigation handler
    function handleQuickNavigation(action) {
        const urls = {
            'review-inbox': 'edit.php?post_type=letter&post_status=pending',
            'view-quarantine': 'edit.php?post_type=letter&quarantine=1'
        };
        
        if (urls[action]) {
            window.location.href = urls[action];
        }
    }

    // Refresh status (with visual feedback)
    function handleRefreshStatus() {
        const $body = $('body');
        $body.css('cursor', 'wait');
        
        // Add a small delay for visual feedback
        setTimeout(() => {
            location.reload();
        }, 100);
    }

    // Clear import with better error handling
    function handleClearImport($button) {
        if (!confirm('Clear import progress?')) {
            return;
        }
        
        // Prevent duplicate requests
        const requestKey = 'clear-import';
        if (pendingRequests.has(requestKey)) {
            try {
                pendingRequests.get(requestKey).abort();
            } catch (e) {}
        }
        
        const originalText = $button.text();
        $button.prop('disabled', true).text('Clearing...');
        
        const ajaxRequest = $.ajax({
            url: typeof ajaxurl !== 'undefined' ? ajaxurl : '/wp-admin/admin-ajax.php',
            type: 'POST',
            data: {
                action: 'rts_clear_import_progress',
                nonce: getDashboardNonce()
            },
            timeout: 10000 // 10 second timeout
        });
        
        pendingRequests.set(requestKey, ajaxRequest);
        
        ajaxRequest
            .done(function(response) {
                if (response && response.success) {
                    showToast('success', 'Progress cleared', 'The import progress has been cleared.');
                    
                    // Reload after a short delay to show toast
                    setTimeout(() => location.reload(), 1500);
                } else {
                    showToast('error', 'Failed', 
                        response && response.data ? response.data : 'Failed to clear progress');
                }
            })
            .fail(function(xhr) {
                let message = 'Error clearing progress';
                
                if (xhr.statusText === 'abort') return;
                
                if (xhr.status === 0) {
                    message = 'Network error. Check your connection.';
                } else if (xhr.status === 403) {
                    message = 'Permission denied. Refresh the page and try again.';
                }
                
                showToast('error', 'Error', message);
            })
            .always(function() {
                pendingRequests.delete(requestKey);
                $button.prop('disabled', false).text(originalText);
            });
    }

    // Collapsible section handler
    function handleCollapsibleToggle(e) {
        e.stopPropagation();
        
        const $header = $(this);
        const $content = $header.next('.rts-collapsible-content');
        const $toggle = $header.find('.rts-collapsible-toggle');
        
        // Use CSS transitions instead of jQuery toggle
        if ($content.hasClass('expanded')) {
            // Collapse
            $content.css('max-height', '0').removeClass('expanded');
            $toggle.removeClass('expanded');
        } else {
            // Expand
            const contentHeight = $content[0].scrollHeight;
            $content.css('max-height', contentHeight + 'px').addClass('expanded');
            $toggle.addClass('expanded');
        }
    }

    // Simple toast notification system
    function showToast(type, title, message) {
        // Clean up old toasts
        $('.rts-toast').slice(2).remove();
        
        const icons = {
            success: '✓',
            error: '✗',
            warning: '⚠',
            info: 'ℹ'
        };
        
        const toastId = 'toast-' + Date.now();
        const toastHtml = `
            <div id="${toastId}" class="rts-toast rts-toast-${type}">
                <div class="rts-toast-icon">${icons[type] || ''}</div>
                <div class="rts-toast-content">
                    <div class="rts-toast-title">${title}</div>
                    <div class="rts-toast-message">${message}</div>
                </div>
                <button type="button" class="rts-toast-close" aria-label="Close">×</button>
            </div>
        `;
        
        // Ensure container exists
        let $container = $('#rts-toast-container');
        if (!$container.length) {
            $container = $('<div id="rts-toast-container"></div>');
            $('body').append($container);
            
            // Close button handler
            $container.on('click', '.rts-toast-close', function() {
                $(this).closest('.rts-toast').remove();
            });
        }
        
        $container.append(toastHtml);
        
        // Auto-remove after 5 seconds
        setTimeout(() => {
            $('#' + toastId).fadeOut(300, function() {
                $(this).remove();
            });
        }, 5000);
    }

    // Get nonce safely
    function getDashboardNonce() {
        if (typeof rts_dashboard_vars !== 'undefined' && rts_dashboard_vars.nonce) {
            return rts_dashboard_vars.nonce;
        }
        
        // Fallback: try to get from global
        if (typeof window.rtsDashboard !== 'undefined' && window.rtsDashboard.dashboard_nonce) {
            return window.rtsDashboard.dashboard_nonce;
        }
        
        return '';
    }

    // Simple memory cleanup
    function cleanup() {
        $(document).off('click', handleDashboardClick);
        $(document).off('click', '.rts-collapsible-header', handleCollapsibleToggle);
        $('#rts-toast-container').off('click', '.rts-toast-close');
        pendingRequests.forEach(xhr => {
            try { xhr.abort(); } catch(e) {}
        });
        pendingRequests.clear();
    }

    // Initialize
    function initDashboard() {
        setupEventDelegation();
        
        // Auto-expand first collapsible section
        $('.rts-collapsible-header').first().trigger('click');
        
        // Setup cleanup
        $(window).on('beforeunload', cleanup);
        $(document).on('wp-before-menu-redirect', cleanup);
    }

    // Start when ready
    $(document).ready(initDashboard);

})(jQuery);
{
  "success": true,
  "id": "scan_698bf5369fb690.96417011",
  "scan_id": "scan_698bf5369fb690.96417011",
  "summary": {
    "file_count": 50,
    "total_size": "1.38 MB",
    "total_size_raw": 1450481,
    "complexity_score": "High",
    "est_tokens": 362620,
    "class_count": 44,
    "function_count": 612,
    "hook_count": 147,
    "cache_hits": 0,
    "cache_misses": 44,
    "cache_hit_rate": 0
  },
  "context": "",
  "context_preview": "{\n    \"summary\": {\n        \"file_count\": 50,\n        \"total_size\": \"1.38 MB\",\n        \"class_count\": 44,\n        \"function_count\": 612,\n        \"hook_count\": 147,\n        \"complexity_score\": \"High\",\n        \"est_tokens\": 362620\n    },\n    \"scan_plan\": {\n        \"mode\": \"deep\",\n        \"focus\": [\n            \"templates\",\n            \"functionality\",\n            \"hooks\",\n            \"database\",\n            \"api\",\n            \"security\",\n            \"performance\",\n            \"dependencies\"\n        ],\n        \"options\": {\n            \"include_vendor\": true,\n            \"include_assets\": true,\n            \"include_translations\": true,\n            \"include_tests\": true,\n            \"include_minified\": false\n        },\n        \"budgets\": {\n            \"max_file_bytes_full\": 1536000,\n            \"max_full_files\": 400,\n            \"max_total_bytes\": 41943040\n        },\n        \"include_everything\": true\n    },\n    \"policy_stats\": {\n        \"excluded\": 1,\n        \"excluded_by_reason\": {\n            \"Minified asset excluded by policy\": 1\n        },\n        \"downgraded\": 0\n    },\n    \"filtering_report\": {\n        \"filters_applied\": [],\n        \"budgets\": {\n            \"max_file_bytes_full\": 1536000,\n            \"max_full_files\": 400,\n            \"max_total_bytes\": 41943040\n        },\n        \"excluded_total\": 1,\n        \"excluded_by_reason\": {\n            \"Minified asset excluded by policy\": 1\n        },\n        \"omissions_sample\": [\n            {\n                \"path\": \"assets/js/rts-dashboard.min.js\",\n                \"reason\": \"Minified asset excluded by policy\"\n            }\n        ]\n    },\n    \"index\": {\n        \"hooks\": [\n            {\n                \"type\": \"action\",\n                \"name\": \"save_post_rts_subscriber\",\n                \"file\": \"subscribers/includes/class-analytics.php\"\n            },\n            {\n                \"type\": \"action\",\n                \"name\": \"delete_post\",\n                \"file\": \"subscribers/includes/class-analytics.php\"\n            },\n            {\n                \"type\": \"action\",\n                \"name\": \"admin_post_rts_import_csv\",\n                \"file\": \"subscribers/includes/class-csv-importer.php\"\n            },\n            {\n                \"type\": \"action\",\n                \"name\": \"admin_post_rts_export_csv\",\n                \"file\": \"subscribers/includes/class-csv-importer.php\"\n            },\n            {\n                \"type\": \"action\",\n                \"name\": \"rts_process_import_chunk\",\n                \"file\": \"subscribers/includes/class-csv-importer.php\"\n            },\n            {\n                \"type\": \"action\",\n                \"name\": \"rts_cleanup_import_sessions\",\n                \"file\": \"subscribers/includes/class-csv-importer.php\"\n            },\n            {\n                \"type\": \"action\",\n                \"name\": \"rts_send_queued_email\",\n                \"file\": \"subscribers/includes/class-email-engine.php\"\n            },\n            {\n                \"type\": \"action\",\n                \"name\": \"wp_mail_failed\",\n                \"file\": \"subscribers/includes/class-email-engine.php\"\n            },\n            {\n                \"type\": \"action\",\n                \"name\": \"rts_daily_digest\",\n                \"file\": \"subscribers/includes/class-email-engine.php\"\n            },\n            {\n                \"type\": \"action\",\n                \"name\": \"rts_weekly_digest\",\n                \"file\": \"subscribers/includes/class-email-engine.php\"\n            },\n            {\n                \"type\": \"action\",\n                \"name\": \"rts_monthly_digest\",\n                \"file\": \"subscribers/includes/class-email-engine.php\"\n            },\n            {\n                \"type\": \"action\",\n                \"name\": \"init\",\n                \"file\": \"subscribers/includes/class-email-engine.php\"\n            },\n            {\n                \"type\": \"action\",\n                \"name\": \"rts_queue_cleanup\",\n                \"file\": \"subscribers/includes/class-email-queue.php\"\n            },\n            {\n                \"type\": \"action\",\n                \"name\": \"rts_process_email_queue\",\n                \"file\": \"subscribers/includes/class-email-queue.php\"\n            },\n            {\n                \"type\": \"action\",\n                \"name\": \"init\",\n                \"file\": \"subscribers/includes/class-newsletter-cpt.php\"\n            },\n            {\n                \"type\": \"action\",\n                \"name\": \"add_meta_boxes\",\n                \"file\": \"subscribers/includes/class-newsletter-cpt.php\"\n            },\n            {\n                \"type\": \"action\",\n                \"name\": \"save_post_\",\n                \"file\": \"subscribers/includes/class-newsletter-cpt.php\"\n            },\n            {\n                \"type\": \"action\",\n                \"name\": \"rts_queue_newsletter_batch\",\n                \"file\": \"subscribers/includes/class-newsletter-cpt.php\"\n            },\n            {\n                \"type\": \"action\",\n                \"name\": \"admin_enqueue_scripts\",\n                \"file\": \"subscribers/includes/class-newsletter-cpt.php\"\n            },\n            {\n                \"type\": \"action\",\n                \"name\": \"admin_menu\",\n                \"file\": \"subscribers/includes/class-smtp-settings.php\"\n            },\n            {\n                \"type\": \"action\",\n                \"name\": \"admin_init\",\n                \"file\": \"subscribers/includes/class-smtp-settings.php\"\n            },\n            {\n                \"type\": \"action\",\n                \"name\": \"admin_enqueue_scripts\",\n                \"file\": \"subscribers/includes/class-smtp-settings.php\"\n            },\n            {\n                \"type\": \"filter\",\n                \"name\": \"plugin_action_links_\",\n                \"file\": \"subscribers/includes/class-smtp-settings.php\"\n            },\n            {\n                \"type\": \"filter\",\n                \"name\": \"allowed_options\",\n                \"file\": \"subscribers/includes/class-smtp-settings.php\"\n            },\n            {\n                \"type\": \"action\",\n                \"name\": \"phpmailer_init\",\n                \"file\": \"subscribers/includes/class-smtp-settings.php\"\n            },\n            {\n                \"type\": \"action\",\n                \"name\": \"init\",\n                \"file\": \"subscribers/includes/class-subscriber-cpt.php\"\n            },\n            {\n                \"type\": \"filter\",\n                \"name\": \"manage_rts_subscriber_posts_columns\",\n                \"file\": \"subscribers/includes/class-subscriber-cpt.php\"\n            },\n            {\n                \"type\": \"action\",\n                \"name\": \"manage_rts_subscriber_posts_custom_column\",\n                \"file\": \"subscribers/includes/class-subscriber-cpt.php\"\n            },\n            {\n                \"type\": \"filter\",\n                \"name\": \"manage_edit-rts_subscriber_sortable_columns\",\n                \"file\": \"subscribers/includes/class-subscriber-cpt.php\"\n            },\n            {\n                \"type\": \"action\",\n                \"name\": \"restrict_manage_posts\",\n                \"file\": \"subscribers/includes/class-subscriber-cpt.php\"\n            },\n            {\n                \"type\": \"filter\",\n                \"name\": \"parse_query\",\n                \"file\": \"subscribers/includes/class-subscriber-cpt.php\"\n            },\n            {\n                \"type\": \"filter\",\n                \"name\": \"bulk_actions-edit-rts_subscriber\",\n                \"file\": \"subscribers/includes/class-subscriber-cpt.php\"\n            },\n            {\n                \"type\": \"filter\",\n                \"name\": \"handle_bulk_actions-edit-rts_subscriber\",\n                \"file\": \"subscribers/includes/class-subscriber-cpt.php\"\n            },\n            {\n                \"type\": \"action\",\n                \"name\": \"admin_notices\",\n                \"file\": \"subscribers/includes/class-subscriber-cpt.php\"\n            },\n            {\n                \"type\": \"filter\",\n                \"name\": \"enter_title_here\",\n                \"file\": \"subscribers/includes/class-subscriber-cpt.php\"\n            },\n            {\n                \"type\": \"action\",\n                \"name\": \"add_meta_boxes\",\n                \"file\": \"subscribers/includes/class-subscriber-cpt.php\"\n            },\n            {\n                \"type\": \"action\",\n                \"name\": \"save_post_rts_subscriber\",\n                \"file\": \"subscribers/includes/class-subscriber-cpt.php\"\n            },\n            {\n                \"type\": \"action\",\n                \"name\": \"admin_enqueue_scripts\",\n                \"file\": \"subscribers/includes/class-subscriber-cpt.php\"\n            },\n            {\n                \"type\": \"action\",\n                \"name\": \"admin_head\",\n                \"file\": \"subscribers/includes/class-subscriber-cpt.php\"\n            },\n            {\n                \"type\": \"action\",\n                \"name\": \"init\",\n                \"file\": \"subscribers/includes/class-unsubscribe.php\"\n            },\n            {\n                \"type\": \"action\",\n                \"name\": \"admin_post_rts_toggle_pause_sending\",\n                \"file\": \"subscribers/admin/class-admin-menu.php\"\n            },\n            {\n                \"type\": \"action\",\n                \"name\": \"admin_menu\",\n                \"file\": \"subscribers/admin/class-admin-menu.php\"\n            },\n            {\n                \"type\": \"action\",\n                \"name\": \"admin_init\",\n                \"file\": \"subscribers/admin/class-admin-menu.php\"\n            },\n            {\n                \"type\": \"action\",\n                \"name\": \"admin_notices\",\n                \"file\": \"subscribers/admin/class-admin-menu.php\"\n            },\n            {\n                \"type\": \"action\",\n                \"name\": \"admin_post_rts_save_template\",\n                \"file\": \"subscribers/admin/class-admin-menu.php\"\n            },\n            {\n                \"type\": \"action\",\n                \"name\": \"admin_post_rts_test_template\",\n                \"file\": \"subscribers/admin/class-admin-menu.php\"\n            },\n            {\n                \"type\": \"action\",\n                \"name\": \"admin_post_rts_add_subscriber\",\n                \"file\": \"subscribers/admin/class-admin-menu.php\"\n            },\n            {\n                \"type\": \"action\",\n                \"name\": \"admin_enqueue_scripts\",\n                \"file\": \"subscribers/admin/class-admin-menu.php\"\n            },\n            {\n                \"type\": \"action\",\n                \"name\": \"after_switch_theme\",\n                \"file\": \"subscribers/class-rts-subscriber-system.php\"\n            },\n            {\n                \"type\": \"action\",\n                \"name\": \"init\",\n                \"file\": \"subscribers/class-rts-subscriber-system.php\"\n            },\n            {\n                \"type\": \"action\",\n                \"name\": \"admin_init\",\n                \"file\": \"subscribers/class-rts-subscriber-system.php\"\n            },\n            {\n                \"type\": \"action\",\n                \"name\": \"rts_cron_health_check\",\n                \"file\": \"subscribers/class-rts-subscriber-system.php\"\n            },\n            {\n                \"type\": \"action\",\n                \"name\": \"admin_post_rts_send_reconsent\",\n                \"file\": \"subscribers/class-rts-subscriber-system.php\"\n            },\n            {\n                \"type\": \"action\",\n                \"name\": \"rts_send_reconsent_batch\",\n                \"file\": \"subscribers/class-rts-subscriber-system.php\"\n            },\n            {\n                \"type\": \"action\",\n                \"name\": \"rts_automated_drip\",\n                \"file\": \"subscribers/class-rts-subscriber-system.php\"\n            },\n            {\n                \"type\": \"action\",\n                \"name\": \"updated_post_meta\",\n                \"file\": \"subscribers/class-rts-subscriber-system.php\"\n            },\n            {\n                \"type\": \"action\",\n                \"name\": \"added_post_meta\",\n                \"file\": \"subscribers/class-rts-subscriber-system.php\"\n            },\n            {\n                \"type\": \"action\",\n                \"name\": \"wp_enqueue_scripts\",\n                \"file\": \"subscribers/class-rts-subscriber-system.php\"\n            },\n            {\n                \"type\": \"action\",\n                \"name\": \"admin_enqueue_scripts\",\n                \"file\": \"subscribers/class-rts-subscriber-system.php\"\n            },\n            {\n                \"type\": \"filter\",\n                \"name\": \"cron_schedules\",\n                \"file\": \"subscribers/class-rts-subscriber-system.php\"\n            },\n            {\n                \"type\": \"action\",\n                \"name\": \"publish_letter\",\n                \"file\": \"subscribers/class-rts-subscriber-system.php\"\n            },\n            {\n                \"type\": \"filter\",\n                \"name\": \"site_status_tests\",\n                \"file\": \"subscribers/class-rts-subscriber-system.php\"\n            },\n            {\n                \"type\": \"action\",\n                \"name\": \"admin_menu\",\n                \"file\": \"inc/rts-admin-manual.php\"\n            },\n            {\n                \"type\": \"filter\",\n                \"name\": \"menu_order\",\n                \"file\": \"inc/rts-admin-manual.php\"\n            },\n            {\n                \"type\": \"action\",\n                \"name\": \"rts_bulk_rescan\",\n                \"file\": \"inc/rts-bulk-jobs.php\"\n            },\n            {\n                \"type\": \"action\",\n                \"name\": \"rts_bulk_admin_action\",\n                \"file\": \"inc/rts-bulk-jobs.php\"\n            },\n            {\n                \"type\": \"action\",\n                \"name\": \"rts_bulk_refine_job\",\n                \"file\": \"inc/rts-bulk-jobs.php\"\n            },\n            {\n                \"type\": \"action\",\n                \"name\": \"rts_rescan_quarantine_loop\",\n                \"file\": \"inc/rts-bulk-jobs.php\"\n            },\n            {\n                \"type\": \"action\",\n                \"name\": \"rts_daily_maintenance\",\n                \"file\": \"inc/rts-bulk-jobs.php\"\n            },\n            {\n                \"type\": \"action\",\n                \"name\": \"init\",\n                \"file\": \"inc/rts-bulk-jobs.php\"\n            },\n            {\n                \"type\": \"action\",\n                \"name\": \"wp_enqueue_scripts\",\n                \"file\": \"inc/rts-embed-shortcodes.php\"\n            },\n            {\n                \"type\": \"action\",\n                \"name\": \"wp_dashboard_setup\",\n                \"file\": \"inc/rts-learning-dashboard.php\"\n            },\n            {\n                \"type\": \"action\",\n                \"name\": \"admin_init\",\n                \"file\": \"inc/rts-learning-engine.php\"\n            },\n            {\n                \"type\": \"action\",\n                \"name\": \"transition_post_status\",\n                \"file\": \"inc/rts-learning-engine.php\"\n            },\n            {\n                \"type\": \"action\",\n                \"name\": \"rts_daily_learning_cleanup\",\n                \"file\": \"inc/rts-learning-engine.php\"\n            },\n            {\n                \"type\": \"action\",\n                \"name\": \"init\",\n                \"file\": \"inc/rts-learning-engine.php\"\n            },\n            {\n                \"type\": \"action\",\n                \"name\": \"rts_process_letter\",\n                \"file\": \"inc/rts-moderation-engine.php\"\n            },\n            {\n                \"type\": \"action\",\n                \"name\": \"rts_process_import_batch\",\n                \"file\": \"inc/rts-moderation-engine.php\"\n            },\n            {\n                \"type\": \"action\",\n                \"name\": \"rts_aggregate_analytics\",\n                \"file\": \"inc/rts-moderation-engine.php\"\n            },\n            {\n                \"type\": \"filter\",\n                \"name\": \"cron_schedules\",\n                \"file\": \"inc/rts-moderation-engine.php\"\n            },\n            {\n                \"type\": \"action\",\n                \"name\": \"rts_pump_queue\",\n                \"file\": \"inc/rts-moderation-engine.php\"\n            },\n            {\n                \"type\": \"action\",\n                \"name\": \"rts_wpcron_process_letter\",\n                \"file\": \"inc/rts-moderation-engine.php\"\n            },\n            {\n                \"type\": \"action\",\n                \"name\": \"rts_scan_pump\",\n                \"file\": \"inc/rts-moderation-engine.php\"\n            },\n            {\n                \"type\": \"action\",\n                \"name\": \"rts_auto_process_tick\",\n                \"file\": \"inc/rts-moderation-engine.php\"\n            },\n            {\n                \"type\": \"action\",\n                \"name\": \"save_post_letter\",\n                \"file\": \"inc/rts-moderation-engine.php\"\n            },\n            {\n                \"type\": \"action\",\n                \"name\": \"save_post_rts_feedback\",\n                \"file\": \"inc/rts-moderation-engine.php\"\n            },\n            {\n                \"type\": \"action\",\n                \"name\": \"pre_get_posts\",\n                \"file\": \"inc/rts-moderation-engine.php\"\n            },\n            {\n                \"type\": \"action\",\n                \"name\": \"init\",\n                \"file\": \"inc/rts-moderation-engine.php\"\n            },\n            {\n                \"type\": \"action\",\n                \"name\": \"save_post_letter\",\n                \"file\": \"inc/rts-moderation-learning.php\"\n            },\n            {\n                \"type\": \"action\",\n                \"name\": \"admin_post_rts_record_feedback\",\n                \"file\": \"inc/rts-moderation-learning.php\"\n            },\n            {\n                \"type\": \"action\",\n                \"name\": \"rts_daily_maintenance\",\n                \"file\": \"inc/rts-moderation-learning.php\"\n            },\n            {\n                \"type\": \"action\",\n                \"name\": \"wp_footer\",\n                \"file\": \"inc/rts-quick-exit.php\"\n            },\n            {\n                \"type\": \"action\",\n                \"name\": \"rest_api_init\",\n                \"file\": \"inc/rts-rest-api.php\"\n            },\n            {\n                \"type\": \"action\",\n                \"name\": \"admin_menu\",\n                \"file\": \"inc/rts-workflow-admin.php\"\n            },\n            {\n                \"type\": \"action\",\n                \"name\": \"admin_notices\",\n                \"file\": \"inc/rts-workflow-admin.php\"\n            },\n            {\n                \"type\": \"action\",\n                \"name\": \"pre_get_posts\",\n                \"file\": \"inc/rts-workflow-admin.php\"\n            },\n            {\n                \"type\": \"filter\",\n                \"name\": \"views_edit-letter\",\n                \"file\": \"inc/rts-workflow-admin.php\"\n            },\n            {\n                \"type\": \"action\",\n                \"name\": \"admin_post_rts_start_workflow_backfill\",\n                \"file\": \"inc/rts-workflow-admin.php\"\n            },\n            {\n                \"type\": \"action\",\n                \"name\": \"admin_post_rts_review_console_save\",\n                \"file\": \"inc/rts-workflow-admin.php\"\n            },\n            {\n                \"type\": \"action\",\n                \"name\": \"init\",\n                \"file\": \"inc/rts-workflow-admin.php\"\n            },\n            {\n                \"type\": \"action\",\n                \"name\": \"admin_init\",\n                \"file\": \"inc/rts-workflow.php\"\n            },\n            {\n                \"type\": \"action\",\n                \"name\": \"wp_insert_post\",\n                \"file\": \"inc/rts-workflow.php\"\n            },\n            {\n                \"type\": \"action\",\n                \"name\": \"transition_post_status\",\n                \"file\": \"inc/rts-workflow.php\"\n            },\n            {\n                \"type\": \"action\",\n                \"name\": \"rts_workflow_mark_learned\",\n                \"file\": \"inc/rts-workflow.php\"\n            },\n            {\n                \"type\": \"action\",\n                \"name\": \"init\",\n                \"file\": \"inc/rts-workflow.php\"\n            },\n            {\n                \"type\": \"action\",\n                \"name\": \"rest_api_init\",\n                \"file\": \"inc/shortcodes.php\"\n            },\n            {\n                \"type\": \"action\",\n                \"name\": \"save_post_letter\",\n                \"file\": \"inc/shortcodes.php\"\n            },\n            {\n                \"type\": \"action\",\n                \"name\": \"delete_post\",\n                \"file\": \"inc/shortcodes.php\"\n            }\n        ],\n        \"ajax\": [\n            {\n                \"action\": \"rts_import_progress\",\n                \"hook\": \"wp_ajax_rts_import_progress\",\n                \"file\": \"subscribers/includes/class-csv-importer.php\"\n            },\n            {\n                \"action\": \"rts_cancel_import\",\n                \"hook\": \"wp_ajax_rts_cancel_import\",\n                \"file\": \"subscribers/includes/class-csv-importer.php\"\n            },\n            {\n                \"action\": \"rts_newsletter_test_send\",\n                \"hook\": \"wp_ajax_rts_newsletter_test_send\",\n                \"file\": \"subscribers/includes/class-newsletter-cpt.php\"\n            },\n            {\n                \"action\": \"rts_newsletter_send_all\",\n                \"hook\": \"wp_ajax_rts_newsletter_send_all\",\n                \"file\": \"subscribers/includes/class-newsletter-cpt.php\"\n            },\n            {\n                \"action\": \"rts_newsletter_progress\",\n                \"hook\": \"wp_ajax_rts_newsletter_progress\",\n                \"file\": \"subscribers/includes/class-newsletter-cpt.php\"\n            },\n            {\n                \"action\": \"rts_insert_random_letter\",\n                \"hook\": \"wp_ajax_rts_insert_random_letter\",\n                \"file\": \"subscribers/includes/class-newsletter-cpt.php\"\n            },\n            {\n                \"action\": \"rts_test_smtp\",\n                \"hook\": \"wp_ajax_rts_test_smtp\",\n                \"file\": \"subscribers/includes/class-smtp-settings.php\"\n            },\n            {\n                \"action\": \"rts_handle_subscription\",\n                \"hook\": \"wp_ajax_rts_handle_subscription\",\n                \"file\": \"subscribers/class-rts-subscriber-system.php\"\n            },\n            {\n                \"action\": \"nopriv_rts_handle_subscription\",\n                \"hook\": \"wp_ajax_nopriv_rts_handle_subscription\",\n                \"file\": \"subscribers/class-rts-subscriber-system.php\"\n            },\n            {\n                \"action\": \"rts_track_share\",\n                \"hook\": \"wp_ajax_rts_track_share\",\n                \"file\": \"inc/rts-moderation-engine.php\"\n            },\n            {\n                \"action\": \"nopriv_rts_track_share\",\n                \"hook\": \"wp_ajax_nopriv_rts_track_share\",\n                \"file\": \"inc/rts-moderation-engine.php\"\n            },\n            {\n                \"action\": \"rts_record_feedback_ajax\",\n                \"hook\": \"wp_ajax_rts_record_feedback_ajax\",\n                \"file\": \"inc/rts-moderation-learning.php\"\n            },\n            {\n                \"action\": \"rts_random_letter\",\n                \"hook\": \"wp_ajax_rts_random_letter\",\n                \"file\": \"inc/rts-rest-api.php\"\n            },\n            {\n                \"action\": \"nopriv_rts_random_letter\",\n                \"hook\": \"wp_ajax_nopriv_rts_random_letter\",\n                \"file\": \"inc/rts-rest-api.php\"\n            },\n            {\n                \"action\": \"nopriv_rts_submit_letter\",\n                \"hook\": \"wp_ajax_nopriv_rts_submit_letter\",\n                \"file\": \"inc/shortcodes.php\"\n            },\n            {\n                \"action\": \"rts_submit_letter\",\n                \"hook\": \"wp_ajax_rts_submit_letter\",\n                \"file\": \"inc/shortcodes.php\"\n            }\n        ],\n        \"shortcodes\": [\n            {\n                \"tag\": \"rts_subscribe_form\",\n                \"file\": \"subscribers/includes/class-subscription-form.php\"\n            },\n            {\n                \"tag\": \"rts_subscribe\",\n                \"file\": \"subscribers/class-rts-subscriber-system.php\"\n            },\n            {\n                \"tag\": \"rts_share_buttons\",\n                \"file\": \"inc/shortcodes.php\"\n            },\n            {\n                \"tag\": \"rts_letter_viewer\",\n                \"file\": \"inc/shortcodes.php\"\n            },\n            {\n                \"tag\": \"rts_onboarding\",\n                \"file\": \"inc/shortcodes.php\"\n            },\n            {\n                \"tag\": \"rts_submit_form\",\n                \"file\": \"inc/shortcodes.php\"\n            },\n            {\n                \"tag\": \"rts_site_stats_row\",\n                \"file\": \"inc/shortcodes.php\"\n            }\n        ],\n        \"options\": [\n            {\n                \"op\": \"write\",\n                \"name\": \"rts_analytics_last_reset\",\n                \"file\": \"subscribers/includes/class-analytics.php\"\n            },\n            {\n                \"op\": \"read\",\n                \"name\": \"_transient_timeout_\",\n                \"file\": \"subscribers/includes/class-analytics.php\"\n            },\n            {\n                \"op\": \"read\",\n                \"name\": \"rts_centralized_tables\",\n                \"file\": \"subscribers/includes/class-email-engine.php\"\n            },\n            {\n                \"op\": \"read\",\n                \"name\": \"rts_email_engine_db_version\",\n                \"file\": \"subscribers/includes/class-email-engine.php\"\n            },\n            {\n                \"op\": \"write\",\n                \"name\": \"rts_email_engine_db_version\",\n                \"file\": \"subscribers/includes/class-email-engine.php\"\n            },\n            {\n                \"op\": \"read\",\n                \"name\": \"rts_email_sending_enabled\",\n                \"file\": \"subscribers/includes/class-email-engine.php\"\n            },\n            {\n                \"op\": \"read\",\n                \"name\": \"rts_pause_all_sending\",\n                \"file\": \"subscribers/includes/class-email-engine.php\"\n            },\n            {\n                \"op\": \"read\",\n                \"name\": \"rts_email_demo_mode\",\n                \"file\": \"subscribers/includes/class-email-engine.php\"\n            },\n            {\n                \"op\": \"read\",\n                \"name\": \"rts_email_tracking_enabled\",\n                \"file\": \"subscribers/includes/class-email-engine.php\",\n                \"default_type\": \"bool\",\n                \"default\": \"true\"\n            },\n            {\n                \"op\": \"read\",\n                \"name\": \"rts_click_tracking_enabled\",\n                \"file\": \"subscribers/includes/class-email-engine.php\",\n                \"default_type\": \"bool\",\n                \"default\": \"true\"\n            },\n            {\n                \"op\": \"read\",\n                \"name\": \"rts_max_bounce_count\",\n                \"file\": \"subscribers/includes/class-email-engine.php\",\n                \"default_type\": \"number\",\n                \"default\": \"3\"\n            },\n            {\n                \"op\": \"read\",\n                \"name\": \"rts_email_reconsent_required\",\n                \"file\": \"subscribers/includes/class-email-engine.php\",\n                \"default_type\": \"bool\",\n                \"default\": \"true\"\n            },\n            {\n                \"op\": \"read\",\n                \"name\": \"rts_email_batch_size\",\n                \"file\": \"subscribers/includes/class-email-queue.php\",\n                \"default_type\": \"number\",\n                \"default\": \"100\"\n            },\n            {\n                \"op\": \"write\",\n                \"name\": \"rts_last_queue_run\",\n                \"file\": \"subscribers/includes/class-email-queue.php\"\n            },\n            {\n                \"op\": \"read\",\n                \"name\": \"rts_email_retry_attempts\",\n                \"file\": \"subscribers/includes/class-email-queue.php\",\n                \"default_type\": \"number\",\n                \"default\": \"3\"\n            },\n            {\n                \"op\": \"write\",\n                \"name\": \"rts_email_queue_paused\",\n                \"file\": \"subscribers/includes/class-email-queue.php\"\n            },\n            {\n                \"op\": \"read\",\n                \"name\": \"rts_email_queue_paused\",\n                \"file\": \"subscribers/includes/class-email-queue.php\",\n                \"default_type\": \"bool\",\n                \"default\": \"false\"\n            },\n            {\n                \"op\": \"read\",\n                \"name\": \"rts_email_subject_\",\n                \"file\": \"subscribers/includes/class-email-templates.php\",\n                \"default_type\": \"string\",\n                \"default\": \"\"\n            },\n            {\n                \"op\": \"read\",\n                \"name\": \"rts_email_body_\",\n                \"file\": \"subscribers/includes/class-email-templates.php\",\n                \"default_type\": \"string\",\n                \"default\": \"\"\n            },\n            {\n                \"op\": \"read\",\n                \"name\": \"rts_email_bg_color\",\n                \"file\": \"subscribers/includes/class-email-templates.php\",\n                \"default_type\": \"string\",\n                \"default\": \"#ffffff\"\n            },\n            {\n                \"op\": \"read\",\n                \"name\": \"rts_email_text_color\",\n                \"file\": \"subscribers/includes/class-email-templates.php\",\n                \"default_type\": \"string\",\n                \"default\": \"#111111\"\n            },\n            {\n                \"op\": \"read\",\n                \"name\": \"rts_email_muted_color\",\n                \"file\": \"subscribers/includes/class-email-templates.php\",\n                \"default_type\": \"string\",\n                \"default\": \"#666666\"\n            },\n            {\n                \"op\": \"read\",\n                \"name\": \"rts_email_link_color\",\n                \"file\": \"subscribers/includes/class-email-templates.php\",\n                \"default_type\": \"string\",\n                \"default\": \"#DF157C\"\n            },\n            {\n                \"op\": \"read\",\n                \"name\": \"admin_email\",\n                \"file\": \"subscribers/includes/class-newsletter-cpt.php\"\n            },\n            {\n                \"op\": \"read\",\n                \"name\": \"rts_email_reconsent_required\",\n                \"file\": \"subscribers/includes/class-newsletter-cpt.php\"\n            },\n            {\n                \"op\": \"read\",\n                \"name\": \"admin_email\",\n                \"file\": \"subscribers/includes/class-smtp-settings.php\"\n            },\n            {\n                \"op\": \"read\",\n                \"name\": \"rts_smtp_pass\",\n                \"file\": \"subscribers/includes/class-smtp-settings.php\"\n            },\n            {\n                \"op\": \"read\",\n                \"name\": \"rts_smtp_enabled\",\n                \"file\": \"subscribers/includes/class-smtp-settings.php\",\n                \"default_type\": \"bool\",\n                \"default\": \"false\"\n            },\n            {\n                \"op\": \"read\",\n                \"name\": \"rts_smtp_from_email\",\n                \"file\": \"subscribers/includes/class-smtp-settings.php\"\n            },\n            {\n                \"op\": \"read\",\n                \"name\": \"rts_smtp_from_name\",\n                \"file\": \"subscribers/includes/class-smtp-settings.php\"\n            },\n            {\n                \"op\": \"read\",\n                \"name\": \"rts_smtp_reply_to\",\n                \"file\": \"subscribers/includes/class-smtp-settings.php\"\n            },\n            {\n                \"op\": \"read\",\n                \"name\": \"rts_smtp_cc_email\",\n                \"file\": \"subscribers/includes/class-smtp-settings.php\"\n            },\n            {\n                \"op\": \"read\",\n                \"name\": \"rts_smtp_host\",\n                \"file\": \"subscribers/includes/class-smtp-settings.php\",\n                \"default_type\": \"string\",\n                \"default\": \"mail.smtp2go.com\"\n            },\n            {\n                \"op\": \"read\",\n                \"name\": \"rts_smtp_port\",\n                \"file\": \"subscribers/includes/class-smtp-settings.php\",\n                \"default_type\": \"number\",\n                \"default\": \"2525\"\n            },\n            {\n                \"op\": \"read\",\n                \"name\": \"rts_smtp_encryption\",\n                \"file\": \"subscribers/includes/class-smtp-settings.php\",\n                \"default_type\": \"string\",\n                \"default\": \"tls\"\n            },\n            {\n                \"op\": \"read\",\n                \"name\": \"rts_smtp_auth\",\n                \"file\": \"subscribers/includes/class-smtp-settings.php\",\n                \"default_type\": \"bool\",\n                \"default\": \"true\"\n            },\n            {\n                \"op\": \"read\",\n                \"name\": \"rts_smtp_user\",\n                \"file\": \"subscribers/includes/class-smtp-settings.php\"\n            },\n            {\n                \"op\": \"read\",\n                \"name\": \"rts_smtp_debug\",\n                \"file\": \"subscribers/includes/class-smtp-settings.php\"\n            },\n            {\n                \"op\": \"read\",\n                \"name\": \"rts_require_email_verification\",\n                \"file\": \"subscribers/includes/class-subscriber-cpt.php\",\n                \"default_type\": \"bool\",\n                \"default\": \"true\"\n            },\n            {\n                \"op\": \"read\",\n                \"name\": \"rts_email_reconsent_required\",\n                \"file\": \"subscribers/admin/class-admin-menu.php\",\n                \"default_type\": \"bool\",\n                \"default\": \"true\"\n            },\n            {\n                \"op\": \"read\",\n                \"name\": \"rts_smtp_enabled\",\n                \"file\": \"subscribers/admin/class-admin-menu.php\",\n                \"default_type\": \"bool\",\n                \"default\": \"false\"\n            },\n            {\n                \"op\": \"read\",\n                \"name\": \"rts_email_sending_enabled\",\n                \"file\": \"subscribers/admin/class-admin-menu.php\",\n                \"default_type\": \"bool\",\n                \"default\": \"false\"\n            },\n            {\n                \"op\": \"read\",\n                \"name\": \"rts_email_demo_mode\",\n                \"file\": \"subscribers/admin/class-admin-menu.php\",\n                \"default_type\": \"bool\",\n                \"default\": \"false\"\n            },\n            {\n                \"op\": \"read\",\n                \"name\": \"admin_email\",\n                \"file\": \"subscribers/admin/class-admin-menu.php\"\n            },\n            {\n                \"op\": \"read\",\n                \"name\": \"rts_smtp_host\",\n                \"file\": \"subscribers/admin/class-admin-menu.php\",\n                \"default_type\": \"string\",\n                \"default\": \"\"\n            },\n            {\n                \"op\": \"read\",\n                \"name\": \"rts_smtp_user\",\n                \"file\": \"subscribers/admin/class-admin-menu.php\",\n                \"default_type\": \"string\",\n                \"default\": \"\"\n            },\n            {\n                \"op\": \"read\",\n                \"name\": \"rts_smtp_host\",\n                \"file\": \"subscribers/admin/class-admin-menu.php\",\n                \"default_type\": \"string\",\n                \"default\": \"mail.smtp2go.com\"\n            },\n            {\n                \"op\": \"read\",\n                \"name\": \"rts_smtp_port\",\n                \"file\": \"subscribers/admin/class-admin-menu.php\",\n                \"default_type\": \"number\",\n                \"default\": \"2525\"\n            },\n            {\n                \"op\": \"read\",\n                \"name\": \"rts_smtp_encryption\",\n                \"file\": \"subscribers/admin/class-admin-menu.php\",\n                \"default_type\": \"string\",\n                \"default\": \"tls\"\n            },\n            {\n                \"op\": \"read\",\n                \"name\": \"rts_smtp_auth\",\n                \"file\": \"subscribers/admin/class-admin-menu.php\",\n                \"default_type\": \"bool\",\n                \"default\": \"true\"\n            },\n            {\n                \"op\": \"read\",\n                \"name\": \"rts_smtp_debug\",\n                \"file\": \"subscribers/admin/class-admin-menu.php\",\n                \"default_type\": \"bool\",\n                \"default\": \"false\"\n            },\n            {\n                \"op\": \"read\",\n                \"name\": \"rts_smtp_from_email\",\n                \"file\": \"subscribers/admin/class-admin-menu.php\"\n            },\n            {\n                \"op\": \"read\",\n                \"name\": \"rts_smtp_from_name\",\n                \"file\": \"subscribers/admin/class-admin-menu.php\"\n            },\n            {\n                \"op\": \"read\",\n                \"name\": \"rts_smtp_reply_to\",\n                \"file\": \"subscribers/admin/class-admin-menu.php\"\n            },\n            {\n                \"op\": \"read\",\n                \"name\": \"rts_smtp_cc_email\",\n                \"file\": \"subscribers/admin/class-admin-menu.php\"\n            },\n            {\n                \"op\": \"read\",\n                \"name\": \"rts_email_sending_enabled\",\n                \"file\": \"subscribers/admin/class-admin-menu.php\"\n            },\n            {\n                \"op\": \"read\",\n                \"name\": \"rts_email_demo_mode\",\n                \"file\": \"subscribers/admin/class-admin-menu.php\"\n            },\n            {\n                \"op\": \"read\",\n                \"name\": \"rts_email_reconsent_required\",\n                \"file\": \"subscribers/admin/class-admin-menu.php\"\n            },\n            {\n                \"op\": \"read\",\n                \"name\": \"rts_email_daily_time\",\n                \"file\": \"subscribers/admin/class-admin-menu.php\",\n                \"default_type\": \"string\",\n                \"default\": \"09:00\"\n            },\n            {\n                \"op\": \"read\",\n                \"name\": \"rts_email_batch_size\",\n                \"file\": \"subscribers/admin/class-admin-menu.php\",\n                \"default_type\": \"number\",\n                \"default\": \"100\"\n            },\n            {\n                \"op\": \"read\",\n                \"name\": \"rts_social_facebook\",\n                \"file\": \"subscribers/admin/class-admin-menu.php\"\n            },\n            {\n                \"op\": \"read\",\n                \"name\": \"rts_social_instagram\",\n                \"file\": \"subscribers/admin/class-admin-menu.php\"\n            },\n            {\n                \"op\": \"read\",\n                \"name\": \"rts_social_linkedin\",\n                \"file\": \"subscribers/admin/class-admin-menu.php\"\n            },\n            {\n                \"op\": \"read\",\n                \"name\": \"rts_social_linktree\",\n                \"file\": \"subscribers/admin/class-admin-menu.php\"\n            },\n            {\n                \"op\": \"read\",\n                \"name\": \"rts_email_logo_url\",\n                \"file\": \"subscribers/admin/class-admin-menu.php\"\n            },\n            {\n                \"op\": \"read\",\n                \"name\": \"rts_privacy_url\",\n                \"file\": \"subscribers/admin/class-admin-menu.php\"\n            },\n            {\n                \"op\": \"read\",\n                \"name\": \"rts_onboarder_enabled\",\n                \"file\": \"subscribers/admin/class-admin-menu.php\",\n                \"default_type\": \"number\",\n                \"default\": \"1\"\n            },\n            {\n                \"op\": \"read\",\n                \"name\": \"rts_email_template_\",\n                \"file\": \"subscribers/admin/class-admin-menu.php\"\n            },\n            {\n                \"op\": \"write\",\n                \"name\": \"rts_email_template_\",\n                \"file\": \"subscribers/admin/class-admin-menu.php\"\n            },\n            {\n                \"op\": \"read\",\n                \"name\": \"rts_email_template_\",\n                \"file\": \"subscribers/admin/class-admin-menu.php\",\n                \"default_type\": \"string\",\n                \"default\": \"Test Email\"\n            },\n            {\n                \"op\": \"read\",\n                \"name\": \"rts_email_template_\",\n                \"file\": \"subscribers/admin/class-admin-menu.php\",\n                \"default_type\": \"string\",\n                \"default\": \"<p>Test</p>\"\n            },\n            {\n                \"op\": \"read\",\n                \"name\": \"rts_pause_all_sending\",\n                \"file\": \"subscribers/admin/class-admin-menu.php\",\n                \"default_type\": \"number\",\n                \"default\": \"0\"\n            },\n            {\n                \"op\": \"write\",\n                \"name\": \"rts_pause_all_sending\",\n                \"file\": \"subscribers/admin/class-admin-menu.php\"\n            },\n            {\n                \"op\": \"write\",\n                \"name\": \"rts_database_version\",\n                \"file\": \"subscribers/class-database-installer.php\"\n            },\n            {\n                \"op\": \"write\",\n                \"name\": \"rts_centralized_tables\",\n                \"file\": \"subscribers/class-database-installer.php\"\n            },\n            {\n                \"op\": \"write\",\n                \"name\": \"rts_subscriber_db_version\",\n                \"file\": \"subscribers/class-rts-subscriber-system.php\"\n            },\n            {\n                \"op\": \"read\",\n                \"name\": \"rts_subscriber_db_version\",\n                \"file\": \"subscribers/class-rts-subscriber-system.php\",\n                \"default_type\": \"string\",\n                \"default\": \"0\"\n            },\n            {\n                \"op\": \"read\",\n                \"name\": \"admin_email\",\n                \"file\": \"subscribers/class-rts-subscriber-system.php\"\n            },\n            {\n                \"op\": \"write\",\n                \"name\": \"rts_last_cron_health_check\",\n                \"file\": \"subscribers/class-rts-subscriber-system.php\"\n            },\n            {\n                \"op\": \"read\",\n                \"name\": \"rts_smtp_from_email\",\n                \"file\": \"subscribers/class-rts-subscriber-system.php\"\n            },\n            {\n                \"op\": \"read\",\n                \"name\": \"rts_subscriber_meta_migrated_v1_2\",\n                \"file\": \"subscribers/class-rts-subscriber-system.php\"\n            },\n            {\n                \"op\": \"write\",\n                \"name\": \"rts_subscriber_meta_migrated_v1_2\",\n                \"file\": \"subscribers/class-rts-subscriber-system.php\"\n            },\n            {\n                \"op\": \"read\",\n                \"name\": \"rts_require_email_verification\",\n                \"file\": \"subscribers/class-rts-subscriber-system.php\",\n                \"default_type\": \"bool\",\n                \"default\": \"true\"\n            },\n            {\n                \"op\": \"read\",\n                \"name\": \"rts_import_job_status\",\n                \"file\": \"inc/rts-moderation-engine.php\",\n                \"default_type\": \"array\",\n                \"default\": \"[]\"\n            },\n            {\n                \"op\": \"read\",\n                \"name\": \"rts_aggregated_stats\",\n                \"file\": \"inc/rts-moderation-engine.php\",\n                \"default_type\": \"array\",\n                \"default\": \"[]\"\n            },\n            {\n                \"op\": \"write\",\n                \"name\": \"rts_import_job_status\",\n                \"file\": \"inc/rts-moderation-engine.php\"\n            },\n            {\n                \"op\": \"read\",\n                \"name\": \"rts_db_version\",\n                \"file\": \"inc/rts-moderation-learning.php\"\n            },\n            {\n                \"op\": \"write\",\n                \"name\": \"rts_db_version\",\n                \"file\": \"inc/rts-moderation-learning.php\"\n            },\n            {\n                \"op\": \"write\",\n                \"name\": \"rts_import_job_status_\",\n                \"file\": \"inc/rts-streaming-importer.php\"\n            },\n            {\n                \"op\": \"read\",\n                \"name\": \"rts_import_job_status_\",\n                \"file\": \"inc/rts-streaming-importer.php\",\n                \"default_type\": \"array\",\n                \"default\": \"[]\"\n            }\n        ],\n        \"security\": [\n            {\n                \"type\": \"capability\",\n                \"cap\": \"manage_options\",\n                \"file\": \"subscribers/includes/class-analytics.php\"\n            },\n            {\n                \"type\": \"capability\",\n                \"cap\": \"manage_options\",\n                \"file\": \"subscribers/includes/class-csv-importer.php\"\n            },\n            {\n                \"type\": \"nonce\",\n                \"check\": \"check_admin_referer\",\n                \"action\": \"rts_import_csv\",\n                \"file\": \"subscribers/includes/class-csv-importer.php\"\n            },\n            {\n                \"type\": \"nonce\",\n                \"check\": \"check_admin_referer\",\n                \"action\": \"rts_export_csv\",\n                \"file\": \"subscribers/includes/class-csv-importer.php\"\n            },\n            {\n                \"type\": \"nonce\",\n                \"check\": \"check_ajax_referer\",\n                \"action\": \"rts_import_progress\",\n                \"file\": \"subscribers/includes/class-csv-importer.php\"\n            },\n            {\n                \"type\": \"nonce\",\n                \"check\": \"wp_create_nonce\",\n                \"action\": \"rts_newsletter_action\",\n                \"file\": \"subscribers/includes/class-newsletter-cpt.php\"\n            },\n            {\n                \"type\": \"nonce\",\n                \"check\": \"wp_verify_nonce\",\n                \"file\": \"subscribers/includes/class-newsletter-cpt.php\"\n            },\n            {\n                \"type\": \"capability\",\n                \"cap\": \"manage_options\",\n                \"file\": \"subscribers/includes/class-newsletter-cpt.php\"\n            },\n            {\n                \"type\": \"nonce\",\n                \"check\": \"check_ajax_referer\",\n                \"action\": \"rts_newsletter_action\",\n                \"file\": \"subscribers/includes/class-newsletter-cpt.php\"\n            },\n            {\n                \"type\": \"capability\",\n                \"cap\": \"manage_options\",\n                \"file\": \"subscribers/includes/class-smtp-settings.php\"\n            },\n            {\n                \"type\": \"nonce\",\n                \"check\": \"wp_create_nonce\",\n                \"action\": \"rts_test_smtp\",\n                \"file\": \"subscribers/includes/class-smtp-settings.php\"\n            },\n            {\n                \"type\": \"nonce\",\n                \"check\": \"check_ajax_referer\",\n                \"action\": \"rts_test_smtp\",\n                \"file\": \"subscribers/includes/class-smtp-settings.php\"\n            },\n            {\n                \"type\": \"nonce\",\n                \"check\": \"wp_create_nonce\",\n                \"action\": \"rts_subscriber_admin\",\n                \"file\": \"subscribers/includes/class-subscriber-cpt.php\"\n            },\n            {\n                \"type\": \"nonce\",\n                \"check\": \"wp_verify_nonce\",\n                \"file\": \"subscribers/includes/class-subscriber-cpt.php\"\n            },\n            {\n                \"type\": \"capability\",\n                \"cap\": \"edit_post\",\n                \"file\": \"subscribers/includes/class-subscriber-cpt.php\"\n            },\n            {\n                \"type\": \"nonce\",\n                \"check\": \"wp_create_nonce\",\n                \"action\": \"rts_subscribe_nonce\",\n                \"file\": \"subscribers/includes/class-subscription-form.php\"\n            },\n            {\n                \"type\": \"nonce\",\n                \"check\": \"wp_verify_nonce\",\n                \"file\": \"subscribers/includes/class-unsubscribe.php\"\n            },\n            {\n                \"type\": \"capability\",\n                \"cap\": \"manage_options\",\n                \"file\": \"subscribers/admin/class-admin-menu.php\"\n            },\n            {\n                \"type\": \"nonce\",\n                \"check\": \"wp_create_nonce\",\n                \"action\": \"rts_import_progress\",\n                \"file\": \"subscribers/admin/class-admin-menu.php\"\n            },\n            {\n                \"type\": \"nonce\",\n                \"check\": \"wp_create_nonce\",\n                \"action\": \"rts_test_smtp\",\n                \"file\": \"subscribers/admin/class-admin-menu.php\"\n            },\n            {\n                \"type\": \"nonce\",\n                \"check\": \"check_admin_referer\",\n                \"action\": \"rts_save_template\",\n                \"file\": \"subscribers/admin/class-admin-menu.php\"\n            },\n            {\n                \"type\": \"nonce\",\n                \"check\": \"check_admin_referer\",\n                \"action\": \"rts_test_template\",\n                \"file\": \"subscribers/admin/class-admin-menu.php\"\n            },\n            {\n                \"type\": \"nonce\",\n                \"check\": \"check_admin_referer\",\n                \"action\": \"rts_add_subscriber\",\n                \"file\": \"subscribers/admin/class-admin-menu.php\"\n            },\n            {\n                \"type\": \"nonce\",\n                \"check\": \"check_admin_referer\",\n                \"action\": \"rts_toggle_pause_sending\",\n                \"file\": \"subscribers/admin/class-admin-menu.php\"\n            },\n            {\n                \"type\": \"nonce\",\n                \"check\": \"wp_verify_nonce\",\n                \"file\": \"subscribers/admin/class-admin-menu.php\"\n            },\n            {\n                \"type\": \"nonce\",\n                \"check\": \"wp_create_nonce\",\n                \"action\": \"rts_admin_nonce\",\n                \"file\": \"subscribers/class-rts-subscriber-system.php\"\n            },\n            {\n                \"type\": \"capability\",\n                \"cap\": \"manage_options\",\n                \"file\": \"subscribers/class-rts-subscriber-system.php\"\n            },\n            {\n                \"type\": \"nonce\",\n                \"check\": \"check_ajax_referer\",\n                \"action\": \"rts_subscribe_nonce\",\n                \"file\": \"subscribers/class-rts-subscriber-system.php\"\n            },\n            {\n                \"type\": \"nonce\",\n                \"check\": \"check_ajax_referer\",\n                \"action\": \"rts_dashboard_nonce\",\n                \"file\": \"inc/rts-moderation-engine.php\"\n            },\n            {\n                \"type\": \"capability\",\n                \"cap\": \"manage_options\",\n                \"file\": \"inc/rts-moderation-engine.php\"\n            },\n            {\n                \"type\": \"capability\",\n                \"cap\": \"manage_options\",\n                \"file\": \"inc/rts-zombie-queue-hard-reset.php\"\n            }\n        ],\n        \"endpoints\": [],\n        \"rest_routes\": [],\n        \"post_types\": [\n            {\n                \"type\": \"rts_subscriber\",\n                \"file\": \"subscribers/includes/class-subscriber-cpt.php\"\n            },\n            {\n                \"type\": \"rts_subscriber\",\n                \"file\": \"subscribers/class-rts-subscriber-system.php\"\n            },\n            {\n                \"type\": \"rts_newsletter\",\n                \"file\": \"subscribers/class-rts-subscriber-system.php\"\n            },\n            {\n                \"type\": \"letter\",\n                \"file\": \"subscribers/class-rts-subscriber-system.php\"\n            }\n        ],\n        \"taxonomies\": [],\n        \"assets\": [\n            {\n                \"type\": \"script\",\n                \"handle\": \"rts-newsletter-admin\",\n                \"file\": \"subscribers/includes/class-newsletter-cpt.php\"\n            },\n            {\n                \"type\": \"script\",\n                \"handle\": \"rts-smtp-admin\",\n                \"file\": \"subscribers/includes/class-smtp-settings.php\"\n            },\n            {\n                \"type\": \"script\",\n                \"handle\": \"rts-subscriber-admin\",\n                \"file\": \"subscribers/includes/class-subscriber-cpt.php\"\n            },\n            {\n                \"type\": \"style\",\n                \"handle\": \"rts-frontend-css\",\n                \"file\": \"subscribers/includes/class-subscription-form.php\"\n            },\n            {\n                \"type\": \"script\",\n                \"handle\": \"rts-subscription-js\",\n                \"file\": \"subscribers/includes/class-subscription-form.php\"\n            },\n            {\n                \"type\": \"style\",\n                \"handle\": \"rts-admin-master\",\n                \"file\": \"subscribers/admin/class-admin-menu.php\"\n            },\n            {\n                \"type\": \"script\",\n                \"handle\": \"rts-subscriber-admin\",\n                \"file\": \"subscribers/admin/class-admin-menu.php\"\n            },\n            {\n                \"type\": \"style\",\n                \"handle\": \"rts-admin-master\",\n                \"file\": \"subscribers/class-rts-subscriber-system.php\"\n            },\n            {\n                \"type\": \"script\",\n                \"handle\": \"rts-subscriber-admin\",\n                \"file\": \"subscribers/class-rts-subscriber-system.php\"\n            }\n        ],\n        \"settings\": []\n    },\n    \"structure\": {\n        \"classes\": [\n            \"RTS_Admin_Menu\",\n            \"RTS_Subscriber_List_Table\",\n            \"RTS_Database_Installer\",\n            \"RTS_Subscriber_System\",\n            \"RTS_Analytics\",\n            \"RTS_CSV_Importer\",\n            \"RTS_Email_Engine\",\n            \"RTS_Email_Queue\",\n            \"RTS_Email_Renderer\",\n            \"RTS_Email_Templates\",\n            \"RTS_Newsletter_CPT\",\n            \"RTS_SMTP_Settings\",\n            \"RTS_Subscriber_CPT\",\n            \"RTS_Subscription_Form\",\n            \"RTS_Unsubscribe\",\n            \"RTS_Admin_Preview\",\n            \"RTS_Accessibility_Toolkit\",\n            \"RTS_CPT_Letters_System\",\n            \"RTS_Feedback_System\",\n            \"RTS_Content_Refiner\",\n            \"RTS_Context_Aware_Safety\",\n            \"RTS_Google_Translate\",\n            \"RTS_Learning_Dashboard\",\n            \"RTS_Learning_Engine\",\n            \"RTS_Learning_Cache\",\n            \"RTS_Scan_Diagnostics\",\n            \"RTS_IP_Utils\",\n            \"RTS_Moderation_Engine\",\n            \"RTS_Import_Orchestrator\",\n            \"RTS_Analytics_Aggregator\",\n            \"RTS_Share_Tracker\",\n            \"RTS_Engine_Dashboard\",\n            \"RTS_Cron_Processing\",\n            \"RTS_Engine_Settings\",\n            \"RTS_Auto_Processor\",\n            \"RTS_Moderation_Bootstrap\",\n            \"RTS_Moderation_Learning\",\n            \"RTS_Multilingual\",\n            \"RTSStreamingImporter\",\n            \"RTS_Workflow_Admin\",\n            \"RTS_Workflow\",\n            \"RTS_Zombie_Queue_Hard_Reset\",\n            \"RTS_Security\",\n            \"RTS_Shortcodes\"\n        ],\n        \"functions\": [\n            \"__construct\",\n            \"add_menus\",\n            \"enqueue_admin_assets\",\n            \"reorder_subscriber_submenu\",\n            \"render_add_subscriber_card\",\n            \"render_add_subscriber_above_list\",\n            \"render_dashboard\",\n            \"WP_Query\",\n            \"get_new_signups_week\",\n            \"get_open_rate\",\n            \"render_recent_activity_table\",\n            \"get_letter_email_sent_counts\",\n            \"get_subscriber_flow_current_month\",\n            \"render_import_inner\",\n            \"render_smtp_and_sending_inner\",\n            \"render_settings\",\n            \"render_templates\",\n            \"render_template_editor\",\n            \"get_email_templates\",\n            \"handle_save_template\",\n            \"handle_test_template\",\n            \"redirect_subscriber_post_new\",\n            \"render_add_subscriber\",\n            \"handle_add_subscriber\",\n            \"handle_toggle_pause_sending\",\n            \"render_command_center\",\n            \"obfuscate_email\",\n            \"get_columns\",\n            \"column_default\",\n            \"column_email\",\n            \"column_status\",\n            \"column_frequency\",\n            \"column_subscriptions\",\n            \"column_total_sent\",\n            \"prepare_items\",\n            \"install\",\n            \"get_table_schemas\",\n            \"tables_exist\",\n            \"migrate_from_individual\",\n            \"maybe_upgrade_schema\",\n            \"get_instance\",\n            \"load_dependencies\",\n            \"init_components\",\n            \"setup_hooks\",\n            \"register_subscriber_cpt\",\n            \"register_newsletter_cpt\",\n            \"register_letter_cpt\",\n            \"activate\",\n            \"check_database_version\",\n            \"create_database_tables\",\n            \"schedule_cron_jobs\",\n            \"set_default_options\",\n            \"add_cron_schedules\",\n            \"enqueue_frontend_assets\",\n            \"on_letter_published\",\n            \"handle_send_reconsent\",\n            \"process_reconsent_batch\",\n            \"cron_health_check\",\n            \"validate_configuration\",\n            \"register_health_checks\",\n            \"health_check_tables\",\n            \"migrate_legacy_subscriber_meta\",\n            \"render_subscribe_form_compat\",\n            \"handle_subscription\",\n            \"process_automated_emails\",\n            \"sync_subscriber_to_table\",\n            \"sync_subscriber_meta_change\",\n            \"calculate_next_send_date\",\n            \"generate_unsubscribe_url\",\n            \"get_client_ip\",\n            \"RTS_Subscriber_System\",\n            \"__clone\",\n            \"__wakeup\",\n            \"maybe_clear_caches\",\n            \"get_subscriber_stats\",\n            \"get_summary\",\n            \"get_status_breakdown\",\n            \"clear_cache\",\n            \"clear_all_caches\",\n            \"flush\",\n            \"reset_stats\",\n            \"health_check\",\n            \"are_stats_fresh\",\n            \"get_stats_last_updated\",\n            \"get_growth_stats\",\n            \"generate_date_range\",\n            \"validate_stats\",\n            \"debug_cache_status\",\n            \"handle_import\",\n            \"handle_export\",\n            \"process_import_chunk\",\n            \"ajax_get_import_progress\",\n            \"ajax_cancel_import\",\n            \"cleanup_expired_sessions\",\n            \"count_csv_rows\",\n            \"build_column_map\",\n            \"get_col\",\n            \"normalize_email\",\n            \"sanitize_header_cell\",\n            \"sanitize_csv_cell\"\n        ],\n        \"hooks\": [\n            \"admin_post_rts_toggle_pause_sending\",\n            \"admin_menu\",\n            \"admin_init\",\n            \"admin_notices\",\n            \"admin_post_rts_save_template\",\n            \"admin_post_rts_test_template\",\n            \"admin_post_rts_add_subscriber\",\n            \"admin_enqueue_scripts\",\n            \"after_switch_theme\",\n            \"init\",\n            \"rts_cron_health_check\",\n            \"admin_post_rts_send_reconsent\",\n            \"rts_send_reconsent_batch\",\n            \"wp_ajax_rts_handle_subscription\",\n            \"wp_ajax_nopriv_rts_handle_subscription\",\n            \"rts_automated_drip\",\n            \"updated_post_meta\",\n            \"added_post_meta\",\n            \"wp_enqueue_scripts\",\n            \"cron_schedules\",\n            \"publish_letter\",\n            \"site_status_tests\",\n            \"save_post_rts_subscriber\",\n            \"delete_post\",\n            \"admin_post_rts_import_csv\",\n            \"admin_post_rts_export_csv\",\n            \"wp_ajax_rts_import_progress\",\n            \"wp_ajax_rts_cancel_import\",\n            \"rts_process_import_chunk\",\n            \"rts_cleanup_import_sessions\",\n            \"rts_send_queued_email\",\n            \"wp_mail_failed\",\n            \"rts_daily_digest\",\n            \"rts_weekly_digest\",\n            \"rts_monthly_digest\",\n            \"rts_queue_cleanup\",\n            \"rts_process_email_queue\",\n            \"add_meta_boxes\",\n            \"save_post_\",\n            \"wp_ajax_rts_newsletter_test_send\",\n            \"wp_ajax_rts_newsletter_send_all\",\n            \"wp_ajax_rts_newsletter_progress\",\n            \"wp_ajax_rts_insert_random_letter\",\n            \"rts_queue_newsletter_batch\",\n            \"wp_ajax_rts_test_smtp\",\n            \"plugin_action_links_\",\n            \"allowed_options\",\n            \"phpmailer_init\",\n            \"manage_rts_subscriber_posts_columns\",\n            \"manage_rts_subscriber_posts_custom_column\"\n        ]\n    },\n    \"files\": [\n        {\n            \"path\": \"subscribers/includes/class-analytics.php\",\n            \"size\": 18642,\n            \"ext\": \"php\",\n            \"content\": \"<?php\\n/**\\n * RTS Analytics\\n *\\n * Tracks and reports subscriber statistics and analytics.\\n *\\n * @package    RTS_Subscriber_System\\n * @subpackage Analytics\\n * @version    1.0.6\\n */\\n\\nif (!defined('ABSPATH')) {\\n    exit; // Exit if accessed directly\\n}\\n\\nclass RTS_Analytics {\\n\\n    /**\\n     * Cache key for subscriber stats\\n     */\\n    const STATS_CACHE_KEY = 'rts_subscriber_stats';\\n\\n    /**\\n     * Cache expiration in seconds.\\n     *\\n     * Hotfix: Reduced from 1 hour to 5 minutes so stats stay fresh\\n     * without hammering the database.\\n     */\\n    const CACHE_EXPIRATION = 300; // 5 minutes\\n\\n    /**\\n     * Singleton instance\\n     *\\n     * @var RTS_Analytics|null\\n     */\\n    private static $instance = null;\\n\\n    /**\\n     * Get singleton instance\\n     *\\n     * @return RTS_Analytics\\n     */\\n    public static function get_instance() {\\n        if (null === self::$instance) {\\n            self::$instance = new self();\\n        }\\n        return self::$instance;\\n    }\\n\\n    /**\\n     * Prevent cloning\\n     */\\n    private function __clone() {}\\n\\n    /**\\n     * Prevent unserialization\\n     *\\n     * @throws Exception If unserialization is attempted.\\n     */\\n    public function __wakeup() {\\n        throw new Exception('Cannot unserialize singleton');\\n    }\\n\\n    /**\\n     * Constructor.\\n     */\\n    private function __construct() {\\n        $this->setup_hooks();\\n    }\\n\\n    /**\\n     * Setup hooks.\\n     */\\n    private function setup_hooks() {\\n        // Clear cache when subscriber posts are modified\\n        add_action('save_post_rts_subscriber', [$this, 'clear_all_caches']);\\n        add_action('delete_post', [$this, 'maybe_clear_caches']);\\n    }\\n\\n    /**\\n     * Maybe clear caches on post delete.\\n     *\\n     * @param int $post_id Post ID.\\n     */\\n    public function maybe_clear_caches($post_id) {\\n        if (get_post_type($post_id) === 'rts_subscriber') {\\n            $this->clear_all_caches();\\n        }\\n    }\\n\\n    /**\\n     * Get comprehensive subscriber statistics\\n     *\\n     * @return array Array of subscriber statistics\\n     */\\n    public function get_subscriber_stats($force = false): array {\\n        // Back-compat: allow array args e.g. ['force' => true]\\n        if (is_array($force)) {\\n            $force = !empty($force['force']);\\n        }\\n\\n        // Admins (or explicit force) bypass cache.\\n        $is_admin_user = is_user_logged_in() && current_user_can('manage_options');\\n        $bypass_cache  = ($force === true) || $is_admin_user;\\n\\n        // Check cache first unless bypassing\\n        if (!$bypass_cache) {\\n            $cached_stats = get_transient(self::STATS_CACHE_KEY);\\n            if (false !== $cached_stats) {\\n                return $cached_stats;\\n            }\\n        }\\n\\n        global $wpdb;\\n\\n        $stats = array(\\n            'total'      => 0,\\n            'active'     => 0,\\n            'verified'   => 0,\\n            'unverified' => 0,\\n            'digest_frequency' => array(\\n                'daily'   => 0,\\n                'weekly'  => 0,\\n                'monthly' => 0,\\n            ),\\n            'by_status' => array(),\\n        );\\n\\n        try {\\n            // Total subscribers (published posts only)\\n            $total = $wpdb->get_var($wpdb->prepare(\\n                \\\"SELECT COUNT(*) FROM {$wpdb->posts} \\n                WHERE post_type = %s \\n                AND post_status = %s\\\",\\n                'rts_subscriber',\\n                'publish'\\n            ));\\n            \\n            $stats['total'] = absint($total);\\n\\n            // Active subscribers\\n            $active = $wpdb->get_var($wpdb->prepare(\\n                \\\"SELECT COUNT(DISTINCT p.ID) \\n                FROM {$wpdb->posts} p \\n                INNER JOIN {$wpdb->postmeta} pm ON p.ID = pm.post_id \\n                WHERE p.post_type = %s \\n                AND p.post_status = %s \\n                AND pm.meta_key = '_rts_subscriber_status' \\n                AND pm.meta_value = %s\\\",\\n                'rts_subscriber',\\n                'publish',\\n                'active'\\n            ));\\n            \\n            $stats['active'] = absint($active);\\n\\n            // Verified vs Unverified\\n            $verified = $wpdb->get_var($wpdb->prepare(\\n                \\\"SELECT COUNT(DISTINCT p.ID) \\n                FROM {$wpdb->posts} p \\n                INNER JOIN {$wpdb->postmeta} pm ON p.ID = pm.post_id \\n                WHERE p.post_type = %s \\n                AND p.post_status = %s \\n                AND pm.meta_key = '_rts_subscriber_verified' \\n                AND pm.meta_value = %s\\\",\\n                'rts_subscriber',\\n                'publish',\\n                '1'\\n            ));\\n            \\n            $stats['verified'] = absint($verified);\\n            $stats['unverified'] = $stats['total'] - $stats['verified'];\\n\\n            // Digest frequency breakdown\\n            $frequencies = array('daily', 'weekly', 'monthly');\\n            foreach ($frequencies as $freq) {\\n                $count = $wpdb->get_var($wpdb->prepare(\\n                    \\\"SELECT COUNT(DISTINCT p.ID) \\n                    FROM {$wpdb->posts} p \\n                    INNER JOIN {$wpdb->postmeta} pm ON p.ID = pm.post_id \\n                    WHERE p.post_type = %s \\n                    AND p.post_status = %s \\n                    AND pm.meta_key = '_rts_digest_frequency' \\n                    AND pm.meta_value = %s\\\",\\n                    'rts_subscriber',\\n                    'publish',\\n                    $freq\\n                ));\\n                \\n                $stats['digest_frequency'][$freq] = absint($count);\\n            }\\n\\n            // Status Breakdown\\n            $stats['by_status'] = $this->get_status_breakdown();\\n\\n            // Validate structure and fill missing keys if needed\\n            if (!$this->validate_stats($stats)) {\\n                 if (!isset($stats['digest_frequency'])) {\\n                     $stats['digest_frequency'] = array('daily' => 0, 'weekly' => 0, 'monthly' => 0);\\n                 }\\n                 $required = ['total', 'active', 'verified', 'unverified', 'digest_frequency', 'by_status'];\\n                 foreach ($required as $key) {\\n                    if (!isset($stats[$key])) {\\n                        $stats[$key] = ($key === 'by_status' || $key === 'digest_frequency') ? [] : 0;\\n                    }\\n                 }\\n            }\\n\\n            // Cache the results\\n            set_transient(self::STATS_CACHE_KEY, $stats, self::CACHE_EXPIRATION);\\n\\n        } catch (Exception $e) {\\n            if (defined('WP_DEBUG') && WP_DEBUG) {\\n                error_log('RTS Analytics Error: ' . $e->getMessage());\\n            }\\n            \\n            // Return at least the basic structure with error flag\\n            $stats['error'] = true;\\n            // Ensure text domain is loaded or use generic message if unsure\\n            $stats['error_message'] = __('Unable to retrieve statistics', 'rts');\\n        }\\n\\n        return $stats;\\n    }\\n\\n    /**\\n     * Get high-level summary metrics\\n     *\\n     * @return array Calculated rates and top metrics\\n     */\\n    public function get_summary(): array {\\n        $stats = $this->get_subscriber_stats();\\n\\n        // If error or total is null (should be 0 if valid but empty db), return defaults.\\n        // We allow 0 total subscribers as valid state to return 0 rates.\\n        if (isset($stats['error']) || !isset($stats['total'])) {\\n            return array(\\n                'total_subscribers'      => 0,\\n                'active_rate'            => 0,\\n                'verification_rate'      => 0,\\n                'most_popular_frequency' => 'weekly', // Default\\n            );\\n        }\\n\\n        $total = $stats['total'];\\n        \\n        if ($total === 0) {\\n             return array(\\n                'total_subscribers'      => 0,\\n                'active_rate'            => 0,\\n                'verification_rate'      => 0,\\n                'most_popular_frequency' => 'weekly',\\n            );\\n        }\\n\\n        // Calculate most popular frequency\\n        $freqs = $stats['digest_frequency'];\\n        if (array_sum($freqs) === 0) {\\n            $popular_freq = 'weekly';\\n        } else {\\n            $popular_freq = array_search(max($freqs), $freqs);\\n            if ($popular_freq === false) {\\n                $popular_freq = 'weekly';\\n            }\\n        }\\n\\n        return array(\\n            'total_subscribers'      => $stats['total'],\\n            'active_rate'            => round(($stats['active'] / $total) * 100, 1),\\n            'verification_rate'      => round(($stats['verified'] / $total) * 100, 1),\\n            'most_popular_frequency' => $popular_freq,\\n        );\\n    }\\n\\n    /**\\n     * Get breakdown of subscribers by status\\n     *\\n     * @return array Status counts\\n     */\\n    private function get_status_breakdown(): array {\\n        global $wpdb;\\n        \\n        $results = $wpdb->get_results($wpdb->prepare(\\n            \\\"SELECT pm.meta_value as status, COUNT(DISTINCT p.ID) as count \\n            FROM {$wpdb->posts} p \\n            INNER JOIN {$wpdb->postmeta} pm ON p.ID = pm.post_id \\n            WHERE p.post_type = %s \\n            AND p.post_status = %s \\n            AND pm.meta_key = '_rts_subscriber_status'\\n            GROUP BY pm.meta_value\\\",\\n            'rts_subscriber',\\n            'publish'\\n        ), ARRAY_A);\\n        \\n        $breakdown = array();\\n        if (!empty($results)) {\\n            foreach ($results as $row) {\\n                $breakdown[$row['status']] = absint($row['count']);\\n            }\\n        }\\n        \\n        return $breakdown;\\n    }\\n\\n    /**\\n     * Clear analytics cache (Main stats only)\\n     *\\n     * @return bool True if cache was cleared\\n     */\\n    public function clear_cache() {\\n        return delete_transient(self::STATS_CACHE_KEY);\\n    }\\n\\n    /**\\n     * Clear ALL analytics caches including growth stats\\n     * Uses a wildcard deletion to remove main stats and all dynamic growth keys.\\n     *\\n     * @return bool True on success\\n     */\\n    public function clear_all_caches() {\\n        global $wpdb;\\n\\n        $this->clear_cache(); // Clear main key\\n\\n        // Get all transient names efficiently\\n        // We trim the '_transient_' prefix to get the actual transient name for delete_transient()\\n        $keys = $wpdb->get_col($wpdb->prepare(\\n            \\\"SELECT DISTINCT \\n                CASE \\n                    WHEN option_name LIKE '_transient_timeout_%%' \\n                    THEN SUBSTRING(option_name, 20) \\n                    ELSE SUBSTRING(option_name, 12) \\n                END as transient_name\\n            FROM {$wpdb->options} \\n            WHERE option_name LIKE %s \\n            OR option_name LIKE %s\\\",\\n            '_transient_' . self::STATS_CACHE_KEY . '%',\\n            '_transient_timeout_' . self::STATS_CACHE_KEY . '%'\\n        ));\\n        \\n        if (!empty($keys)) {\\n            foreach ($keys as $transient_name) {\\n                delete_transient($transient_name);\\n            }\\n        }\\n\\n        return true;\\n    }\\n\\n    /**\\n     * Flush all analytics data and cache.\\n     * Use with caution - for debugging/reset purposes.\\n     */\\n    public function flush() {\\n        $this->clear_all_caches();\\n        // Hook for other components to clear their stats if needed\\n        do_action('rts_analytics_flushed');\\n    }\\n\\n    /**\\n     * Reset all stats (for testing purposes only)\\n     * * @internal\\n     */\\n    public function reset_stats() {\\n        $this->flush();\\n        // Could also reset any cumulative counters if you have them\\n        update_option('rts_analytics_last_reset', time());\\n    }\\n\\n    /**\\n     * Check if analytics system is working.\\n     *\\n     * @return array Health status.\\n     */\\n    public function health_check() {\\n        $stats = $this->get_subscriber_stats();\\n        $growth = $this->get_growth_stats(7); // Last 7 days\\n        \\n        return [\\n            'stats_available'       => !isset($stats['error']),\\n            'growth_data_available' => !empty($growth),\\n            'cache_fresh'           => $this->are_stats_fresh(),\\n            'last_updated'          => $this->get_stats_last_updated(),\\n            'total_subscribers'     => $stats['total'] ?? 0,\\n        ];\\n    }\\n\\n    /**\\n     * Check if stats are fresh enough\\n     *\\n     * @return bool True if stats are fresh (less than 5 minutes old)\\n     */\\n    public function are_stats_fresh() {\\n        $cache_time = get_option('_transient_timeout_' . self::STATS_CACHE_KEY);\\n        \\n        if (!$cache_time) {\\n            return false;\\n        }\\n        \\n        // Fresh if the transient timeout is still in the future.\\n        return ($cache_time - time()) > 0;\\n    }\\n\\n    /**\\n     * Get when stats were last updated\\n     *\\n     * @return string|false Formatted date or false if not cached\\n     */\\n    public function get_stats_last_updated() {\\n        $timestamp = get_option('_transient_timeout_' . self::STATS_CACHE_KEY);\\n        \\n        if (!$timestamp) {\\n            return false;\\n        }\\n        \\n        // Return human-readable time\\n        return human_time_diff($timestamp - self::CACHE_EXPIRATION);\\n    }\\n\\n    /**\\n     * Get subscriber growth over time (last 30 days)\\n     *\\n     * @param int $days Number of days to look back\\n     * @return array Daily subscriber growth data (Date => Count)\\n     */\\n    public function get_growth_stats(int $days = 30): array {\\n        $days = absint($days);\\n        \\n        // Limit to reasonable range to prevent memory issues\\n        if ($days < 1) {\\n            $days = 1;\\n        }\\n        if ($days > 365) {\\n            $days = 365;\\n        }\\n\\n        $cache_key = self::STATS_CACHE_KEY . '_growth_' . $days;\\n        \\n        // Check cache first\\n        $cached_stats = get_transient($cache_key);\\n        if (false !== $cached_stats) {\\n            return $cached_stats;\\n        }\\n\\n        global $wpdb;\\n        $growth = array();\\n        \\n        try {\\n            // Using simpler query without CONVERT_TZ dependency if possible, \\n            // relying on PHP date functions for range generation.\\n            // Using WordPress offset for day boundary calculation is safer.\\n            \\n            $end_date_str = date_i18n('Y-m-d 23:59:59');\\n            // If days is small, ensure we catch any from 'today' properly if logic is last X days\\n            $start_date_str = date_i18n('Y-m-d 00:00:00', strtotime(\\\"-$days days\\\", current_time('timestamp')));\\n\\n            $results = $wpdb->get_results($wpdb->prepare(\\n                \\\"SELECT DATE(post_date) as signup_date, COUNT(*) as count \\n                FROM {$wpdb->posts} \\n                WHERE post_type = %s \\n                AND post_status = %s \\n                AND post_date >= %s \\n                AND post_date <= %s\\n                GROUP BY DATE(post_date) \\n                ORDER BY signup_date ASC\\\",\\n                'rts_subscriber',\\n                'publish',\\n                $start_date_str,\\n                $end_date_str\\n            ), ARRAY_A);\\n            \\n            // 1. Populate raw data\\n            $raw_data = array();\\n            if (!empty($results)) {\\n                foreach ($results as $row) {\\n                    $raw_data[$row['signup_date']] = absint($row['count']);\\n                }\\n            }\\n\\n            // 2. Fill in missing dates with 0 (essential for charting)\\n            // Use current_time for end date to match WP settings\\n            $end_date = current_time('Y-m-d');\\n            $start_date = date('Y-m-d', strtotime(\\\"-$days days\\\", current_time('timestamp')));\\n            \\n            $date_range = $this->generate_date_range($start_date, $end_date);\\n            $growth = array_fill_keys($date_range, 0);\\n\\n            // Then merge with actual data\\n            foreach ($raw_data as $date => $count) {\\n                if (isset($growth[$date])) {\\n                    $growth[$date] = $count;\\n                }\\n            }\\n\\n            // Cache the results\\n            set_transient($cache_key, $growth, self::CACHE_EXPIRATION);\\n\\n        } catch (Exception $e) {\\n            if (defined('WP_DEBUG') && WP_DEBUG) {\\n                error_log('RTS Analytics Growth Error: ' . $e->getMessage());\\n            }\\n        }\\n        \\n        return $growth;\\n    }\\n\\n    /**\\n     * Helper to generate date range\\n     *\\n     * @param string $start Start date (Y-m-d)\\n     * @param string $end End date (Y-m-d)\\n     * @return array Array of dates\\n     */\\n    private function generate_date_range(string $start, string $end): array {\\n        $dates = [];\\n        try {\\n            $start_dt = new DateTime($start);\\n            $end_dt = new DateTime($end);\\n            $end_dt->modify('+1 day'); // Include end date\\n            \\n            $interval = new DateInterval('P1D');\\n            $date_range = new DatePeriod($start_dt, $interval, $end_dt);\\n            \\n            foreach ($date_range as $date) {\\n                $dates[] = $date->format('Y-m-d');\\n            }\\n        } catch (Exception $e) {\\n            // Fallback if DateTime fails\\n            $current = strtotime($start);\\n            $end_ts = strtotime($end);\\n            while ($current <= $end_ts) {\\n                $dates[] = date('Y-m-d', $current);\\n                $current = strtotime('+1 day', $current);\\n            }\\n        }\\n        \\n        return $dates;\\n    }\\n\\n    /**\\n     * Validate stats structure\\n     *\\n     * @param array $stats Stats array to validate.\\n     * @return bool True if valid.\\n     */\\n    private function validate_stats(array $stats): bool {\\n        $required_keys = ['total', 'active', 'verified', 'unverified', 'digest_frequency', 'by_status'];\\n        \\n        foreach ($required_keys as $key) {\\n            if (!array_key_exists($key, $stats)) {\\n                return false;\\n            }\\n        }\\n        \\n        // Check frequencies\\n        if (isset($stats['digest_frequency'])) {\\n            foreach (['daily', 'weekly', 'monthly'] as $freq) {\\n                if (!isset($stats['digest_frequency'][$freq])) {\\n                    return false;\\n                }\\n            }\\n        }\\n        \\n        return true;\\n    }\\n\\n    /**\\n     * Debug method to see cache status\\n     */\\n    public function debug_cache_status() {\\n        if (!defined('WP_DEBUG') || !WP_DEBUG) {\\n            return;\\n        }\\n        \\n        $stats = $this->get_subscriber_stats();\\n        $fresh = $this->are_stats_fresh();\\n        $updated = $this->get_stats_last_updated();\\n        \\n        error_log('RTS Analytics Debug:');\\n        error_log('- Total subscribers: ' . (isset($stats['total']) ? $stats['total'] : 'N/A'));\\n        error_log('- Cache fresh: ' . ($fresh ? 'Yes' : 'No'));\\n        error_log('- Last updated: ' . ($updated ? $updated . ' ago' : 'Never'));\\n        error_log('- Has error: ' . (isset($stats['error']) ? 'Yes' : 'No'));\\n    }\\n}\"\n        },\n        {\n            \"path\": \"subscribers/includes/class-csv-importer.php\",\n            \"size\": 20912,\n            \"ext\": \"php\",\n            \"content\": \"<?php\\n/**\\n * RTS CSV Importer\\n *\\n * Handles bulk import of subscribers via CSV with background processing.\\n *\\n * @package    RTS_Subscriber_System\\n * @subpackage Import\\n * @version    1.0.3\\n */\\n\\nif (!defined('ABSPATH')) {\\n    exit;\\n}\\n\\nclass RTS_CSV_Importer {\\n\\n    const BATCH_SIZE = 500; // Reduced batch size for reliability\\n    const SESSION_TTL = 21600; // 6 hours (6 * HOUR_IN_SECONDS)\\n    const MAX_FILE_SIZE = 10485760; // 10MB\\n    const LOCK_TIMEOUT = 300; // 5 minutes\\n    const MAX_ROWS = 50000; // Hard limit to prevent abuse\\n\\n    public function __construct() {\\n        if (is_admin()) {\\n\\t\\t\\tadd_action('admin_post_rts_import_csv', array($this, 'handle_import'));\\n\\t\\t\\tadd_action('admin_post_rts_export_csv', array($this, 'handle_export'));\\n            add_action('wp_ajax_rts_import_progress', array($this, 'ajax_get_import_progress'));\\n            add_action('wp_ajax_rts_cancel_import', array($this, 'ajax_cancel_import'));\\n        }\\n\\n        // Background processing hook (WP-Cron single events)\\n        add_action('rts_process_import_chunk', array($this, 'process_import_chunk'));\\n        \\n        // Cleanup hook\\n        add_action('rts_cleanup_import_sessions', array($this, 'cleanup_expired_sessions'));\\n\\n        // Schedule cleanup if not exists\\n        if (!wp_next_scheduled('rts_cleanup_import_sessions')) {\\n            wp_schedule_event(time(), 'hourly', 'rts_cleanup_import_sessions');\\n        }\\n    }\\n\\n    /**\\n     * Handle CSV upload and start a background import session.\\n     */\\n    public function handle_import() {\\n        if (!current_user_can('manage_options')) {\\n            wp_die(__('Unauthorized action.', 'rts-subscriber-system'));\\n        }\\n\\n        check_admin_referer('rts_import_csv');\\n\\n        // Attempt to raise memory limit for the upload handling phase\\n        @ini_set('memory_limit', '256M');\\n\\n        if (empty($_FILES['csv_file']) || empty($_FILES['csv_file']['tmp_name'])) {\\n            wp_die(__('No file uploaded.', 'rts-subscriber-system'));\\n        }\\n\\n        $file = $_FILES['csv_file'];\\n\\n        // 1. Validate File Size\\n        if ($file['size'] > self::MAX_FILE_SIZE) {\\n            wp_die(__('File too large. Maximum size is 10MB.', 'rts-subscriber-system'));\\n        }\\n\\n        // 2. Validate MIME Type\\n        $allowed_mimes = array('text/csv', 'application/vnd.ms-excel', 'text/plain', 'application/csv');\\n        $file_mime = '';\\n        \\n        if (function_exists('mime_content_type')) {\\n            $file_mime = mime_content_type($file['tmp_name']) ?: '';\\n        }\\n        \\n        // Fallback check: if mime detection fails or returns generic text/plain, ensure extension is csv\\n        $file_ext = strtolower(pathinfo($file['name'], PATHINFO_EXTENSION));\\n        \\n        // If we found a mime type but it's not in our list, AND it's not just a generic text file which CSVs often are\\n        if ($file_mime && !in_array($file_mime, $allowed_mimes, true)) {\\n             wp_die(__('Invalid file type. Please upload a CSV file.', 'rts-subscriber-system'));\\n        }\\n        \\n        // Strict extension check as final guard\\n        if ($file_ext !== 'csv') {\\n            wp_die(__('Invalid file type. Please upload a CSV file.', 'rts-subscriber-system'));\\n        }\\n\\n        $default_frequency = isset($_POST['default_frequency']) ? sanitize_text_field($_POST['default_frequency']) : 'weekly';\\n        if (!in_array($default_frequency, array('daily','weekly','monthly'), true)) {\\n            $default_frequency = 'weekly';\\n        }\\n\\n        // 3. Handle Upload Securely\\n        require_once ABSPATH . 'wp-admin/includes/file.php';\\n        $overrides = array(\\n            'test_form' => false, \\n            'mimes' => array('csv' => 'text/csv')\\n        );\\n        \\n        $uploaded = wp_handle_upload($file, $overrides);\\n\\n        if (isset($uploaded['error'])) {\\n            error_log('RTS Import Upload Error: ' . $uploaded['error']);\\n            wp_die(__('Upload failed. Please try again.', 'rts-subscriber-system'));\\n        }\\n\\n        $file_path = $uploaded['file'];\\n        \\n        // 4. Generate Secure Session ID\\n        $session_id = $this->generate_session_id();\\n\\n        // Count rows efficiently (memory safe)\\n        $total_rows = $this->count_csv_rows($file_path);\\n\\n        if ($total_rows > self::MAX_ROWS) {\\n             @unlink($file_path);\\n             wp_die(sprintf(__('File contains too many rows. Limit is %d.', 'rts-subscriber-system'), self::MAX_ROWS));\\n        }\\n\\n        $session = array(\\n            'session_id'        => $session_id,\\n            'file_path'         => $file_path,\\n            'byte_offset'       => 0,\\n            'total_rows'        => max(0, $total_rows - 1), // exclude header\\n            'processed'         => 0,\\n            'imported'          => 0,\\n            'skipped_duplicate' => 0,\\n            'skipped_invalid'   => 0,\\n            'skipped_other'     => 0,\\n            'default_frequency' => $default_frequency,\\n            'status'            => 'processing',\\n            'started_at'        => current_time('mysql'),\\n            'updated_at'        => current_time('mysql'),\\n            'lock_ts'           => 0, // For race condition handling\\n            'last_error'        => '',\\n            'summary'           => array(),\\n        );\\n\\n        set_transient('rts_import_session_' . $session_id, $session, self::SESSION_TTL);\\n\\n        // Kick off background job immediately\\n        wp_schedule_single_event(time(), 'rts_process_import_chunk', array($session_id));\\n\\n        // Redirect back to the consolidated Subscribers Dashboard (shows progress card).\\n        wp_redirect(add_query_arg(array(\\n            'post_type'  => 'rts_subscriber',\\n            'page'       => 'rts-subscribers-dashboard',\\n            'session'    => $session_id,\\n            'processing' => 1,\\n        ), admin_url('edit.php')));\\n        exit;\\n    }\\n\\n    /**\\n     * Export subscribers to CSV.\\n     * Streams output for large lists.\\n     */\\n    public function handle_export() {\\n        if (!current_user_can('manage_options')) {\\n            wp_die(__('Unauthorized action.', 'rts-subscriber-system'));\\n        }\\n        check_admin_referer('rts_export_csv');\\n\\n        $scope = isset($_POST['export_scope']) ? sanitize_key(wp_unslash($_POST['export_scope'])) : 'all';\\n        if (!in_array($scope, array('all','active','bounced','unsubscribed'), true)) {\\n            $scope = 'all';\\n        }\\n\\n        @ini_set('memory_limit', '256M');\\n        @set_time_limit(0);\\n\\n        nocache_headers();\\n        header('Content-Type: text/csv; charset=utf-8');\\n        header('Content-Disposition: attachment; filename=rts-subscribers-' . $scope . '-' . gmdate('Y-m-d-His') . '.csv');\\n\\n        $out = fopen('php://output', 'w');\\n        if (!$out) {\\n            wp_die(__('Unable to open output stream.', 'rts-subscriber-system'));\\n        }\\n\\n        // Header\\n        fputcsv($out, array('email','status','frequency','pref_letters','pref_newsletters'));\\n\\n        $paged = 1;\\n        $per_page = 500;\\n\\n        // Filter by status via meta.\\n        $meta_query = array();\\n        if ($scope !== 'all') {\\n            $meta_query[] = array(\\n                'key'   => '_rts_subscriber_status',\\n                'value' => $scope,\\n            );\\n        }\\n\\n        do {\\n            $q = new WP_Query(array(\\n                'post_type'              => 'rts_subscriber',\\n                'post_status'            => 'publish',\\n                'posts_per_page'         => $per_page,\\n                'paged'                  => $paged,\\n                'fields'                 => 'ids',\\n                'orderby'                => 'ID',\\n                'order'                  => 'ASC',\\n                'no_found_rows'          => false,\\n                'update_post_meta_cache' => true,\\n                'update_post_term_cache' => false,\\n                'meta_query'             => $meta_query,\\n            ));\\n\\n            if (empty($q->posts)) {\\n                break;\\n            }\\n\\n            foreach ($q->posts as $subscriber_id) {\\n                $email = get_post_field('post_title', $subscriber_id);\\n                $status = get_post_meta($subscriber_id, '_rts_subscriber_status', true);\\n                $frequency = get_post_meta($subscriber_id, '_rts_subscriber_frequency', true);\\n                $pref_letters = (int) get_post_meta($subscriber_id, '_rts_pref_letters', true);\\n                $pref_newsletters = (int) get_post_meta($subscriber_id, '_rts_pref_newsletters', true);\\n\\n                fputcsv($out, array($email, $status, $frequency, $pref_letters, $pref_newsletters));\\n            }\\n\\n            $paged++;\\n\\n            // Flush each page for huge exports.\\n            if (function_exists('flush')) {\\n                flush();\\n            }\\n        } while ($paged <= (int) $q->max_num_pages);\\n\\n        fclose($out);\\n        exit;\\n    }\\n\\n    /**\\n     * Process one chunk for a given import session.\\n     *\\n     * @param string $session_id\\n     */\\n    public function process_import_chunk($session_id) {\\n        // Raise memory limit for processing\\n        @ini_set('memory_limit', '256M');\\n\\n        $session_id = sanitize_text_field($session_id);\\n        $transient_key = 'rts_import_session_' . $session_id;\\n        $session = get_transient($transient_key);\\n\\n        // Basic Validation\\n        if (!$session || empty($session['file_path']) || !file_exists($session['file_path'])) {\\n            return;\\n        }\\n\\n        if ($session['status'] !== 'processing') {\\n            return;\\n        }\\n\\n        // Check Lock (Prevent Race Conditions)\\n        if (!empty($session['lock_ts']) && (time() - $session['lock_ts']) < self::LOCK_TIMEOUT) {\\n            return; // Another process is running this chunk\\n        }\\n\\n        // Set Lock\\n        $session['lock_ts'] = time();\\n        set_transient($transient_key, $session, self::SESSION_TTL);\\n\\n        // Open File (supress warnings)\\n        $handle = @fopen($session['file_path'], 'rb');\\n        if ($handle === false) {\\n            $session['status'] = 'error';\\n            $session['last_error'] = 'Could not open CSV file.';\\n            $session['lock_ts'] = 0; // Release lock so we don't block forever\\n            set_transient($transient_key, $session, self::SESSION_TTL);\\n            return;\\n        }\\n\\n        // Initialize or Seek\\n        if (empty($session['column_map'])) {\\n            $header = fgetcsv($handle);\\n            if ($header) {\\n                // Sanitize header keys and handle potential encoding issues\\n                $header = array_map(array($this, 'sanitize_header_cell'), $header);\\n                $session['column_map'] = $this->build_column_map($header);\\n            } else {\\n                 $session['status'] = 'error';\\n                 $session['last_error'] = 'Empty CSV file.';\\n                 $session['lock_ts'] = 0;\\n                 set_transient($transient_key, $session, self::SESSION_TTL);\\n                 fclose($handle);\\n                 return;\\n            }\\n            $session['byte_offset'] = ftell($handle);\\n        } else {\\n            fseek($handle, intval($session['byte_offset']));\\n        }\\n\\n        // Dependency Check & Load\\n        if (!class_exists('RTS_Subscriber_CPT')) {\\n            // Assume it's in the same directory\\n            if (file_exists(plugin_dir_path(__FILE__) . 'class-subscriber-cpt.php')) {\\n                require_once plugin_dir_path(__FILE__) . 'class-subscriber-cpt.php';\\n            }\\n        }\\n        \\n        if (!class_exists('RTS_Subscriber_CPT')) {\\n             $session['status'] = 'error';\\n             $session['last_error'] = 'Subscriber CPT class missing.';\\n             $session['lock_ts'] = 0;\\n             set_transient($transient_key, $session, self::SESSION_TTL);\\n             fclose($handle);\\n             return;\\n        }\\n\\n        $cpt = new RTS_Subscriber_CPT();\\n        $map = $session['column_map'];\\n        $rows_processed = 0;\\n\\n        // Process Rows\\n        while ($rows_processed < self::BATCH_SIZE && ($row = fgetcsv($handle)) !== false) {\\n            $rows_processed++;\\n            $session['processed']++;\\n\\n            // Sanitize Row Data (Prevent CSV Injection)\\n            $row = array_map(array($this, 'sanitize_csv_cell'), $row);\\n\\n            $email_raw = $this->get_col($row, $map, 'email');\\n            $email = $this->normalize_email($email_raw);\\n\\n            if (!$email || !is_email($email)) {\\n                $session['skipped_invalid']++;\\n                continue;\\n            }\\n\\n            // Frequency\\n            $freq = $this->get_col($row, $map, 'frequency');\\n            $freq = $freq ? sanitize_text_field($freq) : $session['default_frequency'];\\n            if (!in_array($freq, array('daily','weekly','monthly'), true)) {\\n                $freq = $session['default_frequency'];\\n            }\\n\\n            // Source\\n            $source = $this->get_col($row, $map, 'source');\\n            $source = $source ? sanitize_text_field($source) : 'import';\\n\\n            // Meta\\n            $created = $this->get_col($row, $map, 'created_date');\\n            $status_col = $this->get_col($row, $map, 'status');\\n\\n            $args = array(\\n                'ip_address' => '', \\n                'user_agent' => 'Import'\\n            );\\n            \\n            if ($created) {\\n                // Parse date - strtotime handles most CSV formats nicely\\n                $ts = strtotime($created);\\n                if ($ts) {\\n                    $args['subscribed_date'] = gmdate('Y-m-d H:i:s', $ts);\\n                }\\n            }\\n\\n            // Create Subscriber\\n            $result = $cpt->create_subscriber($email, $freq, $source, $args);\\n\\n            if (is_wp_error($result)) {\\n                if ($result->get_error_code() === 'duplicate_email') {\\n                    $session['skipped_duplicate']++;\\n                } else {\\n                    $session['skipped_other']++;\\n                }\\n            } else {\\n                $session['imported']++;\\n                \\n                // Handle Status\\n                $verified = true; \\n                if ($status_col) {\\n                     $s = strtoupper(trim($status_col));\\n                     if (in_array($s, array('UNCONFIRMED', 'PENDING', 'UNVERIFIED'), true)) {\\n                         $verified = false;\\n                     }\\n                }\\n                update_post_meta($result, '_rts_subscriber_verified', $verified ? 1 : 0);\\n                \\n                if (!empty($args['subscribed_date'])) {\\n                    update_post_meta($result, '_rts_subscriber_subscribed_date', $args['subscribed_date']);\\n                }\\n            }\\n        }\\n\\n        // Update Session State\\n        $session['byte_offset'] = ftell($handle);\\n        $session['updated_at'] = current_time('mysql');\\n        $session['lock_ts'] = 0; // Release lock\\n\\n        fclose($handle);\\n\\n        // Check Completion\\n        if ($rows_processed < self::BATCH_SIZE) {\\n            $session['status'] = 'complete';\\n            \\n            // Generate Summary Stats\\n            $session['summary'] = array(\\n                'success_rate' => $session['total_rows'] > 0 ? \\n                    round(($session['imported'] / $session['total_rows']) * 100, 1) : 0,\\n                'duration' => human_time_diff(\\n                    strtotime($session['started_at']), \\n                    current_time('timestamp')\\n                ),\\n            );\\n\\n            // Cleanup file\\n            if (file_exists($session['file_path'])) {\\n                @unlink($session['file_path']);\\n            }\\n        } else {\\n             // Schedule next chunk immediately\\n             wp_schedule_single_event(time(), 'rts_process_import_chunk', array($session_id));\\n        }\\n\\n        set_transient($transient_key, $session, self::SESSION_TTL);\\n    }\\n\\n    /**\\n     * AJAX: Get Progress\\n     */\\n    public function ajax_get_import_progress() {\\n        if (!current_user_can('manage_options')) {\\n            wp_send_json_error(array('message' => 'Unauthorized'));\\n        }\\n        check_ajax_referer('rts_import_progress', 'nonce');\\n\\n        $session_id = isset($_POST['session_id']) ? sanitize_text_field($_POST['session_id']) : '';\\n        if (!$session_id) wp_send_json_error(array('message' => 'Missing ID'));\\n\\n        $session = get_transient('rts_import_session_' . $session_id);\\n        if (!$session) wp_send_json_error(array('message' => 'Session not found'));\\n\\n        wp_send_json_success($session);\\n    }\\n\\n    /**\\n     * AJAX: Cancel Import\\n     */\\n    public function ajax_cancel_import() {\\n        if (!current_user_can('manage_options')) {\\n            wp_send_json_error(array('message' => 'Unauthorized'));\\n        }\\n        check_ajax_referer('rts_import_progress', 'nonce');\\n\\n        $session_id = isset($_POST['session_id']) ? sanitize_text_field($_POST['session_id']) : '';\\n        $transient_key = 'rts_import_session_' . $session_id;\\n        $session = get_transient($transient_key);\\n\\n        if ($session) {\\n            $session['status'] = 'cancelled';\\n            if (!empty($session['file_path']) && file_exists($session['file_path'])) {\\n                @unlink($session['file_path']);\\n            }\\n            delete_transient($transient_key);\\n        }\\n        \\n        wp_send_json_success();\\n    }\\n\\n    /**\\n     * Cron: Cleanup hook place holder.\\n     * Most cleanup is handled by completion/cancellation or transient expiration.\\n     */\\n    public function cleanup_expired_sessions() {\\n        // Fallback: Could iterate options table for stale transients if needed, \\n        // but WP transients handle self-expiration.\\n    }\\n\\n    /**\\n     * Helper: Count rows memory-efficiently.\\n     */\\n    private function count_csv_rows($file_path) {\\n        $count = 0;\\n        $handle = @fopen($file_path, 'rb');\\n        if ($handle === false) return 0;\\n        while (!feof($handle)) {\\n            if (fgets($handle) !== false) $count++; \\n        }\\n        fclose($handle);\\n        return $count;\\n    }\\n\\n    /**\\n     * Helper: Map column headers to keys.\\n     */\\n    private function build_column_map($header) {\\n        $map = array();\\n        if (!is_array($header)) return $map;\\n\\n        $lower = array();\\n        foreach ($header as $i => $name) {\\n            $key = strtolower($name);\\n            $lower[$key] = $i;\\n        }\\n\\n        // Mapping logic\\n        $aliases = array(\\n            'email' => array('email', 'e-mail', 'mail', 'email address'),\\n            'created_date' => array('created_date', 'created date', 'joined', 'subscribed'),\\n            'status' => array('status', 'state'),\\n            'frequency' => array('frequency', 'freq'),\\n            'source' => array('source', 'origin')\\n        );\\n\\n        foreach ($aliases as $target => $possible_names) {\\n            foreach ($possible_names as $name) {\\n                if (isset($lower[$name])) {\\n                    $map[$target] = $lower[$name];\\n                    break;\\n                }\\n            }\\n        }\\n\\n        return $map;\\n    }\\n\\n    private function get_col($row, $map, $key) {\\n        if (!isset($map[$key])) return '';\\n        $idx = intval($map[$key]);\\n        return isset($row[$idx]) ? (string)$row[$idx] : '';\\n    }\\n\\n    private function normalize_email($value) {\\n        $email = trim((string)$value);\\n        if ($email === '') return '';\\n\\n        if (preg_match('/<([^>]+)>/', $email, $m)) {\\n            $email = $m[1];\\n        }\\n        $email = trim($email, \\\" \\\\t\\\\n\\\\r\\\\0\\\\x0B\\\\\\\"\\\\'\\\");\\n        $email = str_replace(' ', '', $email);\\n        return strtolower($email);\\n    }\\n\\n    /**\\n     * Sanitize header cell (BOM removal + Trimming)\\n     */\\n    private function sanitize_header_cell($value) {\\n        // Remove BOM if present\\n        $value = preg_replace('/\\\\x{FEFF}/u', '', (string)$value);\\n        return trim($value);\\n    }\\n\\n    /**\\n     * Prevent CSV Injection (Formula Injection) + Encoding Check\\n     * Triggers when cell starts with =, +, -, or @\\n     */\\n    private function sanitize_csv_cell($value) {\\n        $value = (string)$value;\\n        \\n        // Basic encoding check - ensure UTF-8\\n        if (function_exists('mb_check_encoding') && !mb_check_encoding($value, 'UTF-8')) {\\n            if (function_exists('mb_convert_encoding')) {\\n                $value = mb_convert_encoding($value, 'UTF-8', 'ISO-8859-1, WINDOWS-1252, AUTO');\\n            }\\n        }\\n        \\n        $value = trim($value);\\n        if ($value === '') return '';\\n        \\n        // If it starts with a formula trigger, escape it with a single quote\\n        if (in_array($value[0], array('=', '+', '-', '@'), true)) {\\n            return \\\"'\\\" . $value;\\n        }\\n        return $value;\\n    }\\n\\n    /**\\n     * Secure Session ID Generation\\n     */\\n    private function generate_session_id() {\\n        if (function_exists('wp_generate_uuid4')) {\\n            return 'rtsimport_' . str_replace('-', '', wp_generate_uuid4());\\n        }\\n        return 'rtsimport_' . bin2hex(random_bytes(16));\\n    }\\n}\"\n        },\n        {\n            \"path\": \"subscribers/includes/class-email-engine.php\",\n            \"size\": 28616,\n            \"ext\": \"php\",\n            \"content\": \"<?php\\n/**\\n * RTS Email Engine\\n *\\n * Builds emails, queues them, sends queued items, logs, tracking, and bounces.\\n *\\n * @package    RTS_Subscriber_System\\n * @subpackage Engine\\n * @version    1.0.5\\n */\\n\\nif (!defined('ABSPATH')) {\\n    exit;\\n}\\n\\nclass RTS_Email_Engine {\\n\\n    /**\\n     * Cache for subscriber validation results to reduce DB hits in loops.\\n     * @var array\\n     */\\n    private $subscriber_status_cache = array();\\n\\n    public function __construct() {\\n        // Queue processing hooks\\n        add_action('rts_send_queued_email', array($this, 'send_queued_email'), 10, 1);\\n        \\n        // Error handling\\n        add_action('wp_mail_failed', array($this, 'handle_wp_mail_failed'), 10, 1);\\n        \\n        // Digest scheduling\\n        add_action('rts_daily_digest', array($this, 'run_daily_digest'));\\n        add_action('rts_weekly_digest', array($this, 'run_weekly_digest'));\\n        add_action('rts_monthly_digest', array($this, 'run_monthly_digest'));\\n\\n        // Table initialization (runs once per version update)\\n        // Table creation is centralized in RTS_Database_Installer.\\n// Tracking Handler (Listens for pixel/link clicks)\\n        add_action('init', array($this, 'handle_tracking_request'));\\n    }\\n\\n    /**\\n     * Handle incoming tracking requests (Opens and Clicks).\\n     * This was the missing method causing the fatal error.\\n     */\\n    public function handle_tracking_request() {\\n        if (!isset($_GET['rts_track']) || !isset($_GET['id'])) {\\n            return;\\n        }\\n\\n        $type = sanitize_key($_GET['rts_track']); // 'open' or 'click'\\n        $id   = sanitize_text_field($_GET['id']);\\n\\n        global $wpdb;\\n        $table = $wpdb->prefix . 'rts_email_tracking';\\n\\n        // 1. Verify existence in DB (The ID is an HMAC, so existence implies validity)\\n        // Using prepare to prevent SQL injection\\n        $row = $wpdb->get_row($wpdb->prepare(\\n            \\\"SELECT * FROM {$table} WHERE track_id = %s LIMIT 1\\\", \\n            $id\\n        ));\\n\\n        if (!$row) {\\n            // Invalid tracking ID - fail silently or redirect home\\n            if ($type === 'click') {\\n                wp_redirect(home_url());\\n                exit;\\n            }\\n            return;\\n        }\\n\\n        // 2. Handle 'Open' -> Serve 1x1 Pixel\\n        if ($type === 'open') {\\n            // Record open if not already recorded (or unique opens logic)\\n            // Ideally we update the 'opened' column here if using the new schema\\n            if (isset($row->opened) && $row->opened == 0) {\\n                $wpdb->update(\\n                    $table,\\n                    array('opened' => 1, 'opened_at' => current_time('mysql')),\\n                    array('id' => $row->id),\\n                    array('%d', '%s'),\\n                    array('%d')\\n                );\\n            }\\n\\n            // Send headers to prevent caching\\n            if (!headers_sent()) {\\n                header('Content-Type: image/gif');\\n                header('Cache-Control: no-store, no-cache, must-revalidate, max-age=0');\\n                header('Pragma: no-cache');\\n            }\\n            \\n            // Output 1x1 transparent GIF\\n            echo base64_decode('R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7');\\n            exit;\\n        }\\n\\n        // 3. Handle 'Click' -> Redirect\\n        if ($type === 'click') {\\n            // Record click\\n            if (isset($row->clicked) && $row->clicked == 0) {\\n                $wpdb->update(\\n                    $table,\\n                    array('clicked' => 1, 'clicked_at' => current_time('mysql')),\\n                    array('id' => $row->id),\\n                    array('%d', '%s'),\\n                    array('%d')\\n                );\\n            }\\n\\n            // Prefer URL from DB (Security: Prevents open redirects)\\n            $url = !empty($row->url) ? $row->url : '';\\n\\n            // Fallback to GET param if DB is empty (legacy support), but sanitizing heavily\\n            if (empty($url) && isset($_GET['url'])) {\\n                $url = esc_url_raw(urldecode($_GET['url']));\\n            }\\n\\n            // Validation: Ensure valid URL structure\\n            if ($url && wp_http_validate_url($url)) {\\n                wp_redirect($url);\\n                exit;\\n            } else {\\n                wp_redirect(home_url());\\n                exit;\\n            }\\n        }\\n    }\\n\\n    /**\\n     * Ensure required database tables exist.\\n     */\\n    public function maybe_create_tables() {\\n        // Deprecated: table creation is centralized in RTS_Database_Installer.\\n        return;\\n\\n        // Skip if centralized installer is handling tables\\n        if (get_option('rts_centralized_tables') || class_exists('RTS_Database_Installer')) {\\n            return;\\n        }\\n\\n        $db_version = get_option('rts_email_engine_db_version');\\n        $current_version = '1.0.3'; \\n\\n        if ($db_version !== $current_version) {\\n            $this->create_tables();\\n            update_option('rts_email_engine_db_version', $current_version);\\n        }\\n    }\\n\\n    // Fallback table creation (only runs if centralized installer is missing)\\n    private function create_tables() {\\n        // Deprecated: table creation is centralized in RTS_Database_Installer.\\n        return;\\n\\n        global $wpdb;\\n        $charset_collate = $wpdb->get_charset_collate();\\n        require_once(ABSPATH . 'wp-admin/includes/upgrade.php');\\n\\n        // Tracking Table (Simplified fallback)\\n        $sql_tracking = \\\"CREATE TABLE {$wpdb->prefix}rts_email_tracking (\\n            id bigint(20) unsigned NOT NULL AUTO_INCREMENT,\\n            queue_id bigint(20) unsigned NOT NULL,\\n            subscriber_id bigint(20) unsigned NOT NULL,\\n            template varchar(50) NOT NULL,\\n            track_id varchar(64) NOT NULL,\\n            type varchar(20) NOT NULL,\\n            url text,\\n            created_at datetime NOT NULL,\\n            PRIMARY KEY  (id),\\n            UNIQUE KEY track_id (track_id),\\n            KEY queue_id (queue_id),\\n            KEY subscriber_id (subscriber_id)\\n        ) $charset_collate;\\\";\\n\\n        dbDelta($sql_tracking);\\n    }\\n\\n    /**\\n     * Send queued email item.\\n     *\\n     * @param object $queue_item Database row object from queue table.\\n     * @return bool|void\\n     */\\n    public function send_queued_email($queue_item) {\\n        if (empty($queue_item) || empty($queue_item->id) || empty($queue_item->subscriber_id)) {\\n            return;\\n        }\\n\\n        if (!$this->load_dependencies()) return;\\n\\n        $queue = new RTS_Email_Queue();\\n\\n        // Global kill switch\\n        if (!get_option('rts_email_sending_enabled')) {\\n            $queue->mark_cancelled(intval($queue_item->id), 'Email sending disabled via settings');\\n            return false;\\n        }\\n\\n        // Pause switch (Command Center)\\n        if (get_option('rts_pause_all_sending')) {\\n            return false;\\n        }\\n\\n\\n        $subscriber_id = intval($queue_item->subscriber_id);\\n\\n        // Validation: Require active. For most templates require verified as well.\\n        // Verification emails must be allowed for unverified subscribers.\\n        $template_key = sanitize_key($queue_item->template);\\n\\n        if (!isset($this->subscriber_status_cache[$subscriber_id])) {\\n            $verified = (bool) get_post_meta($subscriber_id, '_rts_subscriber_verified', true);\\n            $status   = (string) get_post_meta($subscriber_id, '_rts_subscriber_status', true);\\n\\n            // Cache as an array so different templates can make safe decisions.\\n            $this->subscriber_status_cache[$subscriber_id] = array(\\n                'verified' => $verified,\\n                'status'   => $status,\\n                'active'   => ($status === 'active'),\\n            );\\n        }\\n\\n        $state = $this->subscriber_status_cache[$subscriber_id];\\n\\n        // Status gate: verification emails are allowed for pending_verification.\\n        if ($template_key === 'verification') {\\n            if (empty($state['status']) || !in_array($state['status'], array('active', 'pending_verification'), true)) {\\n                $queue->mark_failed(intval($queue_item->id), 'Subscriber not eligible for verification email');\\n                return;\\n            }\\n        } else {\\n            if (empty($state['active'])) {\\n                $queue->mark_failed(intval($queue_item->id), 'Subscriber not active');\\n                return;\\n            }\\n        }\\n\\n        if ($template_key !== 'verification' && empty($state['verified'])) {\\n            $queue->mark_failed(intval($queue_item->id), 'Subscriber not verified');\\n            return;\\n        }\\n\\n        // Get email safely\\n        $email_meta = get_post_meta($subscriber_id, '_rts_subscriber_email', true);\\n        if ($email_meta && is_email($email_meta)) {\\n            $to = $email_meta;\\n        } else {\\n            $title = get_the_title($subscriber_id);\\n            $to = is_email($title) ? $title : '';\\n        }\\n\\n        if (!$to) {\\n            $queue->mark_failed(intval($queue_item->id), 'Invalid or missing subscriber email address');\\n            return;\\n        }\\n\\n        $subject = $queue_item->subject;\\n        $body    = $queue_item->body;\\n\\n        // Apply Tracking\\n        $body = $this->apply_tracking($body, $queue_item);\\n\\n        $headers = array('Content-Type: text/html; charset=UTF-8');\\n\\n        // Demo mode\\n        if (get_option('rts_email_demo_mode')) {\\n            $queue->mark_cancelled(intval($queue_item->id), 'Demo mode enabled - email not sent');\\n            $this->log_email($subscriber_id, $to, $queue_item->template, $subject, 'cancelled', 'Demo mode enabled', array('queue_id' => intval($queue_item->id)), intval($queue_item->letter_id));\\n            return true;\\n        }\\n\\n        // Send\\n        $sent = wp_mail($to, $subject, $body, $headers);\\n\\n        if ($sent) {\\n            $queue->mark_sent(intval($queue_item->id));\\n            $this->log_email_granular($subscriber_id, $to, $queue_item->template, $subject, 'sent', null, array('queue_id' => intval($queue_item->id)), $body, intval($queue_item->letter_id));\\n            do_action('rts_email_sent', intval($queue_item->id), 'sent');\\n            return true;\\n        } else {\\n            $queue->mark_failed(intval($queue_item->id), 'wp_mail failed');\\n            $this->log_email($subscriber_id, $to, $queue_item->template, $subject, 'failed', 'wp_mail returned false', array('queue_id' => intval($queue_item->id)));\\n            do_action('rts_email_sent', intval($queue_item->id), 'failed');\\n            return false;\\n        }\\n    }\\n\\n    /**\\n     * Send a verification email for a newly created subscriber.\\n     *\\n     * This is used by the frontend subscription form when email verification is enabled.\\n     * It enqueues an email into the RTS queue and schedules near-term processing.\\n     *\\n     * @param int $subscriber_id\\n     * @return int|WP_Error Queue ID or error\\n     */\\n    public function send_verification_email($subscriber_id) {\\n        $subscriber_id = intval($subscriber_id);\\n        if ($subscriber_id <= 0) {\\n            return new WP_Error('invalid_subscriber', 'Invalid subscriber id');\\n        }\\n\\n        if (!$this->load_dependencies()) {\\n            return new WP_Error('missing_dependencies', 'Email engine dependencies missing');\\n        }\\n\\n        $templates = new RTS_Email_Templates();\\n        $rendered  = $templates->render('verification', $subscriber_id);\\n\\n        $queue = new RTS_Email_Queue();\\n        $queued_id = $queue->enqueue_email($subscriber_id, 'verification', $rendered['subject'], $rendered['body'], null, 10);\\n\\n        // Ensure queue runner kicks in quickly (without requiring a full cron wait).\\n        if (!wp_next_scheduled('rts_process_email_queue')) {\\n            wp_schedule_single_event(time() + 30, 'rts_process_email_queue');\\n        }\\n\\n        // On some hosts WP-Cron is slow to spawn (or disabled). For transactional\\n        // emails like verification/welcome we want best-effort immediate delivery.\\n        // Process a small batch right now when we're not already inside cron.\\n        if (!defined('DOING_CRON') || !DOING_CRON) {\\n            /**\\n             * Process queue immediately to avoid \\\"stuck pending verification\\\".\\n             * Safe because it only sends pending items and has its own time guard.\\n             */\\n            do_action('rts_process_email_queue');\\n\\n            // Nudge WP-Cron as well for any follow-up items.\\n            if (function_exists('spawn_cron')) {\\n                @spawn_cron(time());\\n            }\\n        }\\n\\n        return $queued_id;\\n    }\\n\\n    /**\\n     * Send a welcome email for a subscriber.\\n     *\\n     * @param int $subscriber_id\\n     * @return int|WP_Error Queue ID or error\\n     */\\n    public function send_welcome_email($subscriber_id) {\\n        $subscriber_id = intval($subscriber_id);\\n        if ($subscriber_id <= 0) {\\n            return new WP_Error('invalid_subscriber', 'Invalid subscriber id');\\n        }\\n\\n        if (!$this->load_dependencies()) {\\n            return new WP_Error('missing_dependencies', 'Email engine dependencies missing');\\n        }\\n\\n        $templates = new RTS_Email_Templates();\\n        $rendered  = $templates->render('welcome', $subscriber_id);\\n\\n        $queue = new RTS_Email_Queue();\\n        $queued_id = $queue->enqueue_email($subscriber_id, 'welcome', $rendered['subject'], $rendered['body'], null, 9);\\n\\n        if (!wp_next_scheduled('rts_process_email_queue')) {\\n            wp_schedule_single_event(time() + 30, 'rts_process_email_queue');\\n        }\\n\\n        // Same best-effort immediate delivery approach as verification.\\n        if (!defined('DOING_CRON') || !DOING_CRON) {\\n            do_action('rts_process_email_queue');\\n            if (function_exists('spawn_cron')) {\\n                @spawn_cron(time());\\n            }\\n        }\\n\\n        return $queued_id;\\n    }\\n\\n    /**\\n     * Inject open pixel and wrap links for click tracking.\\n     */\\n    private function apply_tracking($body, $queue_item) {\\n        if (!get_option('rts_email_tracking_enabled', true)) {\\n            return $body;\\n        }\\n\\n        $queue_id      = intval($queue_item->id);\\n        $subscriber_id = intval($queue_item->subscriber_id);\\n        $template      = sanitize_key($queue_item->template);\\n\\n        // Open Tracking\\n        $open_id = hash_hmac('sha256', 'open|' . $queue_id . '|' . $subscriber_id, wp_salt('auth'));\\n        \\n        $track_url = add_query_arg(array(\\n            'rts_track' => 'open',\\n            'id'        => $open_id\\n        ), home_url('/'));\\n\\n        $pixel = '<img src=\\\"' . esc_url($track_url) . '\\\" width=\\\"1\\\" height=\\\"1\\\" style=\\\"display:none;\\\" alt=\\\"\\\" />';\\n\\n        if (stripos($body, '</body>') !== false) {\\n            $body = str_ireplace('</body>', $pixel . '</body>', $body);\\n        } else {\\n            $body .= $pixel;\\n        }\\n\\n        // Store Open Row\\n        $this->store_tracking_row($queue_id, $subscriber_id, $template, $open_id, 'open', null);\\n\\n        // Click Tracking\\n        if (get_option('rts_click_tracking_enabled', true)) {\\n            $body = preg_replace_callback(\\n                '/href=(\\\"|\\\\')(.*?)\\\\1/i',\\n                function($matches) use ($queue_id, $subscriber_id, $template) {\\n                    $quote = $matches[1];\\n                    $url   = $matches[2];\\n\\n                    if (preg_match('/^(mailto:|#|tel:|sms:)/i', $url)) return $matches[0];\\n                    if (stripos($url, 'unsubscribe') !== false || stripos($url, 'manage') !== false) return $matches[0];\\n\\n                    $click_id = hash_hmac('sha256', 'click|' . $queue_id . '|' . $subscriber_id . '|' . $url, wp_salt('auth'));\\n                    \\n                    $track_url = add_query_arg(array(\\n                        'rts_track' => 'click',\\n                        'id'        => $click_id\\n                    ), home_url('/'));\\n\\n                    $this->store_tracking_row($queue_id, $subscriber_id, $template, $click_id, 'click', $url);\\n\\n                    return 'href=' . $quote . esc_url($track_url) . $quote;\\n                },\\n                $body\\n            );\\n        }\\n\\n        return $body;\\n    }\\n\\n    /**\\n     * Store tracking row.\\n     */\\n    private function store_tracking_row($queue_id, $subscriber_id, $template, $track_id, $type, $url = null) {\\n        global $wpdb;\\n        $table = $wpdb->prefix . 'rts_email_tracking';\\n\\n        $exists = $wpdb->get_var($wpdb->prepare(\\\"SELECT id FROM {$table} WHERE track_id = %s\\\", $track_id));\\n        if ($exists) {\\n            return;\\n        }\\n\\n        if ($url && strlen($url) > 2000) {\\n            $url = substr($url, 0, 2000);\\n        }\\n\\n        $data = array(\\n            'queue_id'      => intval($queue_id),\\n            'subscriber_id' => intval($subscriber_id),\\n            'template'      => sanitize_key($template),\\n            'track_id'      => sanitize_text_field($track_id),\\n            'type'          => $type === 'click' ? 'click' : 'open',\\n            'url'           => $url ? esc_url_raw($url) : null,\\n            'created_at'    => current_time('mysql'),\\n        );\\n\\n        // Add extra columns if centralized installer tables are present\\n        if (get_option('rts_centralized_tables')) {\\n            $data['opened'] = 0;\\n            $data['clicked'] = 0;\\n        }\\n\\n        $wpdb->insert($table, $data);\\n    }\\n\\n    /**\\n     * Granular log helper.\\n     *\\n     * Digests may contain multiple letters. To support \\\"no duplicates\\\" we log each\\n     * letter ID that was actually included in the email.\\n     *\\n     * The body may include a marker like: <!--RTS_LETTER_IDS:123,456-->\\n     */\\n    private function log_email_granular($subscriber_id, $email, $template, $subject, $status = 'sent', $error = null, $metadata = array(), $body = '', $fallback_letter_id = null) {\\n        $ids = array();\\n\\n        if ($fallback_letter_id) {\\n            $ids[] = intval($fallback_letter_id);\\n        }\\n\\n        if (is_string($body) && $body) {\\n            if (preg_match('/RTS_LETTER_IDS:([0-9,]+)/', $body, $m)) {\\n                $parts = array_filter(array_map('trim', explode(',', $m[1])));\\n                foreach ($parts as $p) {\\n                    $p = intval($p);\\n                    if ($p > 0) {\\n                        $ids[] = $p;\\n                    }\\n                }\\n            }\\n        }\\n\\n        $ids = array_values(array_unique(array_filter($ids)));\\n\\n        if (empty($ids)) {\\n            $this->log_email($subscriber_id, $email, $template, $subject, $status, $error, $metadata, null);\\n            return;\\n        }\\n\\n        foreach ($ids as $letter_id) {\\n            $this->log_email($subscriber_id, $email, $template, $subject, $status, $error, $metadata, $letter_id);\\n        }\\n    }\\n\\n    private function log_email($subscriber_id, $email, $template, $subject, $status = 'sent', $error = null, $metadata = array(), $letter_id = null) {\\n        global $wpdb;\\n        $table = $wpdb->prefix . 'rts_email_logs';\\n\\n        $wpdb->insert(\\n            $table,\\n            array(\\n                'subscriber_id' => intval($subscriber_id),\\n                'email'         => sanitize_email($email),\\n                'template'      => sanitize_key($template),\\n                'letter_id'     => $letter_id ? intval($letter_id) : null,\\n                'subject'       => sanitize_text_field($subject),\\n                'status'        => $status,\\n                'sent_at'       => current_time('mysql'),\\n                'error'         => $error ? sanitize_textarea_field($error) : null,\\n                'metadata'      => !empty($metadata) ? wp_json_encode($metadata) : null,\\n            ),\\n            array('%d', '%s', '%s', '%d', '%s', '%s', '%s', '%s', '%s')\\n        );\\n\\n        if ($status === 'sent') {\\n            $total_sent = intval(get_post_meta($subscriber_id, '_rts_subscriber_total_sent', true));\\n            update_post_meta($subscriber_id, '_rts_subscriber_total_sent', $total_sent + 1);\\n            update_post_meta($subscriber_id, '_rts_subscriber_last_sent', current_time('mysql'));\\n        }\\n    }\\n\\n    public function handle_wp_mail_failed($wp_error) {\\n        if (!($wp_error instanceof WP_Error)) return;\\n\\n        $data = $wp_error->get_error_data();\\n        if (empty($data) || (empty($data['to']) && empty($data['headers']))) return;\\n\\n        $recipients = array();\\n        if (!empty($data['to'])) {\\n            $recipients = is_array($data['to']) ? $data['to'] : array($data['to']);\\n        }\\n\\n        $error_msg = $wp_error->get_error_message();\\n\\n        foreach ($recipients as $email) {\\n            $email = sanitize_email($email);\\n            if ($email) {\\n                $this->handle_bounce($email, $error_msg);\\n            }\\n        }\\n    }\\n\\n    public function handle_bounce($email, $error) {\\n        if (!$this->load_dependencies()) return false;\\n\\n        $subscriber_cpt = new RTS_Subscriber_CPT();\\n        $subscriber_id = $subscriber_cpt->get_subscriber_by_email($email);\\n\\n        if (!$subscriber_id) return false;\\n\\n        $bounce_count = intval(get_post_meta($subscriber_id, '_rts_subscriber_bounce_count', true));\\n        $bounce_count++;\\n        update_post_meta($subscriber_id, '_rts_subscriber_bounce_count', $bounce_count);\\n\\n        global $wpdb;\\n        $table = $wpdb->prefix . 'rts_email_bounces';\\n\\n        $wpdb->insert(\\n            $table,\\n            array(\\n                'subscriber_id' => intval($subscriber_id),\\n                'email'         => sanitize_email($email),\\n                'error'         => wp_strip_all_tags($error),\\n                'bounced_at'    => current_time('mysql'),\\n            ),\\n            array('%d', '%s', '%s', '%s')\\n        );\\n\\n        $max_bounces = intval(get_option('rts_max_bounce_count', 3));\\n        if ($bounce_count >= $max_bounces) {\\n            update_post_meta($subscriber_id, '_rts_subscriber_status', 'bounced');\\n            update_post_meta($subscriber_id, '_rts_subscriber_bounced_at', current_time('mysql'));\\n            return true;\\n        }\\n\\n        return false;\\n    }\\n\\n    public function run_daily_digest() {\\n        $this->queue_digest('daily');\\n    }\\n\\n    public function run_weekly_digest() {\\n        $this->queue_digest('weekly');\\n    }\\n\\n    public function run_monthly_digest() {\\n        $this->queue_digest('monthly');\\n    }\\n\\n    /**\\n     * Queue digest emails efficiently.\\n     */\\n    private function queue_digest($frequency) {\\n        if (!$this->load_dependencies()) return;\\n\\n        $frequency = sanitize_key($frequency);\\n        $template_slug = $frequency . '_digest';\\n\\n        $require_consent = (bool) get_option('rts_email_reconsent_required', true);\\n\\n        $meta_query = array(\\n            array('key' => '_rts_pref_letters', 'value' => '1'),\\n            array('key' => '_rts_subscriber_status', 'value' => 'active'),\\n            array('key' => '_rts_subscriber_verified', 'value' => 1),\\n            array('key' => '_rts_subscriber_frequency', 'value' => $frequency),\\n        );\\n        if ($require_consent) {\\n            $meta_query[] = array(\\n                'key'     => '_rts_subscriber_consent_confirmed',\\n                'compare' => 'EXISTS',\\n            );\\n        }\\n\\n        $templates = new RTS_Email_Templates();\\n        $queue     = new RTS_Email_Queue();\\n\\n        $paged = 1;\\n        do {\\n            $subscriber_query = new WP_Query(array(\\n                'post_type'      => 'rts_subscriber',\\n                'posts_per_page' => 500,\\n                'paged'          => $paged,\\n                'fields'         => 'ids',\\n                'no_found_rows'  => true,\\n                'update_post_meta_cache' => false,\\n                'update_post_term_cache' => false,\\n                'meta_query'     => $meta_query,\\n            ));\\n\\n            if (!empty($subscriber_query->posts)) {\\n                foreach ($subscriber_query->posts as $subscriber_id) {\\n                    $subscriber_id = intval($subscriber_id);\\n\\n                    $letters = $this->get_letters_for_subscriber($subscriber_id, $frequency);\\n\\n                    // If subscriber has seen everything, send the \\\"all caught up\\\" template.\\n                    if (empty($letters)) {\\n                        $tpl = $templates->render('all_caught_up', $subscriber_id);\\n                        $queue->enqueue_email($subscriber_id, 'all_caught_up', $tpl['subject'], $tpl['body'], current_time('mysql'), 5, null);\\n                        continue;\\n                    }\\n\\n                    $tpl = $templates->render($template_slug, $subscriber_id, $letters);\\n\\n                    // Embed letter ids for granular logging after send.\\n                    $ids = array();\\n                    foreach ($letters as $p) {\\n                        if ($p instanceof WP_Post) {\\n                            $ids[] = intval($p->ID);\\n                        }\\n                    }\\n                    $ids = array_values(array_unique(array_filter($ids)));\\n                    $marker = !empty($ids) ? '<!--RTS_LETTER_IDS:' . implode(',', $ids) . '-->' : '';\\n                    $body_with_marker = $tpl['body'] . $marker;\\n\\n                    // Store first id in queue. Full list remains in marker for logs.\\n                    $queue_letter_id = !empty($ids) ? intval($ids[0]) : null;\\n\\n                    $queue->enqueue_email($subscriber_id, $template_slug, $tpl['subject'], $body_with_marker, current_time('mysql'), 5, $queue_letter_id);\\n                }\\n            }\\n\\n            $paged++;\\n        } while (!empty($subscriber_query->posts));\\n        \\n        wp_reset_postdata();\\n    }\\n\\n    private function get_letters_for_digest($frequency) {\\n        $limit = $frequency === 'daily' ? 1 : ($frequency === 'weekly' ? 5 : 10);\\n\\n        $args = array(\\n            'post_type'      => 'letter',\\n            'post_status'    => 'publish',\\n            'posts_per_page' => $limit,\\n            'orderby'        => 'date',\\n            'order'          => 'DESC',\\n            'no_found_rows'  => true,\\n            'meta_query'     => array(\\n                array(\\n                    'key'   => '_rts_email_ready',\\n                    'value' => 1\\n                )\\n            )\\n        );\\n\\n        $posts = get_posts($args);\\n        return $posts ?: array();\\n    }\\n\\n    /**\\n     * Per-subscriber letter selection with \\\"no duplicates\\\" logic.\\n     *\\n     * Pulls already-sent letter IDs from rts_email_logs and excludes them.\\n     * Returns an array of WP_Post objects.\\n     */\\n    private function get_letters_for_subscriber($subscriber_id, $frequency) {\\n        $subscriber_id = intval($subscriber_id);\\n        $limit = ($frequency === 'daily') ? 1 : (($frequency === 'weekly') ? 5 : 10);\\n\\n        global $wpdb;\\n        $log_table = $wpdb->prefix . 'rts_email_logs';\\n\\n        $sent_ids = $wpdb->get_col($wpdb->prepare(\\n            \\\"SELECT DISTINCT letter_id FROM {$log_table} WHERE subscriber_id = %d AND status = 'sent' AND letter_id IS NOT NULL\\\",\\n            $subscriber_id\\n        ));\\n\\n        $sent_ids = array_values(array_unique(array_filter(array_map('intval', (array) $sent_ids))));\\n\\n        $args = array(\\n            'post_type'      => 'letter',\\n            'post_status'    => 'publish',\\n            'posts_per_page' => $limit,\\n            'orderby'        => 'date',\\n            'order'          => 'DESC',\\n            'no_found_rows'  => true,\\n            'post__not_in'   => $sent_ids,\\n            'meta_query'     => array(\\n                array(\\n                    'key'   => '_rts_email_ready',\\n                    'value' => 1,\\n                ),\\n            ),\\n        );\\n\\n        $posts = get_posts($args);\\n        if (!empty($posts)) {\\n            return $posts;\\n        }\\n\\n        // Fallback: subscriber has read everything \\\"email ready\\\".\\n        // Return empty to allow caller to use the all_caught_up template.\\n        return array();\\n    }\\n\\n    /**\\n     * Dependency Check Helper\\n     */\\n    private function load_dependencies() {\\n        // Assume includes path is standard\\n        $includes_path = RTS_PLUGIN_DIR . 'includes/';\\n        \\n        if (!class_exists('RTS_Email_Templates') && file_exists($includes_path . 'class-email-templates.php')) {\\n            require_once $includes_path . 'class-email-templates.php';\\n        }\\n        \\n        if (!class_exists('RTS_Email_Queue') && file_exists($includes_path . 'class-email-queue.php')) {\\n            require_once $includes_path . 'class-email-queue.php';\\n        }\\n\\n        if (!class_exists('RTS_Subscriber_CPT') && file_exists($includes_path . 'class-subscriber-cpt.php')) {\\n            require_once $includes_path . 'class-subscriber-cpt.php';\\n        }\\n\\n        return class_exists('RTS_Email_Templates') && class_exists('RTS_Email_Queue') && class_exists('RTS_Subscriber_CPT');\\n    }\\n}\"\n        },\n        {\n            \"path\": \"subscribers/includes/class-email-queue.php\",\n            \"size\": 15930,\n            \"ext\": \"php\",\n            \"content\": \"<?php\\n/**\\n * RTS Email Queue Management\\n *\\n * Handles queue operations, cleanup, retry logic, prioritization,\\n * and dead-letter escalation.\\n *\\n * @package    RTS_Subscriber_System\\n * @subpackage Queue\\n * @version    1.0.4\\n */\\n\\nif (!defined('ABSPATH')) {\\n    exit;\\n}\\n\\nclass RTS_Email_Queue {\\n\\n    const QUEUE_TABLE = 'rts_email_queue';\\n    const DLQ_TABLE   = 'rts_dead_letter_queue';\\n\\n    /**\\n     * Prevent duplicate hook wiring if this class is instantiated more than once.\\n     * (Some components may construct queue helpers for utility purposes.)\\n     */\\n    private static $hooks_wired = false;\\n\\n    public function __construct() {\\n        if (self::$hooks_wired) {\\n            return;\\n        }\\n        self::$hooks_wired = true;\\n        $this->init_hooks();\\n    }\\n\\n    // Hooks separated so class can be instantiated for utility\\n    public function init_hooks() {\\n        add_action('rts_queue_cleanup', array($this, 'cleanup_old_queue_items'));\\n        add_action('rts_process_email_queue', array($this, 'process_queue_batch'));\\n    }\\n\\n    /**\\n     * Enqueue an email for sending.\\n     *\\n     * @param int         $subscriber_id\\n     * @param string      $template\\n     * @param string      $subject\\n     * @param string      $body\\n     * @param string|null $scheduled_at MySQL datetime (GMT) or null for now.\\n     * @param int         $priority     1 (Low) to 10 (High).\\n     * @param int|null    $letter_id\\n     * @return int|WP_Error\\n     */\\n    public function enqueue_email($subscriber_id, $template, $subject, $body, $scheduled_at = null, $priority = 5, $letter_id = null) {\\n        global $wpdb;\\n\\n        // Template Validation\\n        $valid_templates = array('welcome', 'verification', 'daily_digest', 'weekly_digest', 'monthly_digest', 'reconsent', 'newsletter_custom', 'all_caught_up', 'automated_letter');\\n        if (!in_array($template, $valid_templates, true)) {\\n            return new WP_Error('invalid_template', 'Invalid email template: ' . esc_html($template));\\n        }\\n\\n        $subscriber_id = intval($subscriber_id);\\n        if ($subscriber_id <= 0) {\\n            return new WP_Error('invalid_subscriber', 'Invalid subscriber id');\\n        }\\n\\n        // Use GMT for consistent internal scheduling\\n        $scheduled_at = $scheduled_at ? $scheduled_at : current_time('mysql', true);\\n        $created_at   = current_time('mysql', true);\\n\\n        $table = $wpdb->prefix . self::QUEUE_TABLE;\\n\\n        $inserted = $wpdb->insert(\\n            $table,\\n            array(\\n                'subscriber_id' => $subscriber_id,\\n                'letter_id'     => $letter_id ? intval($letter_id) : null,\\n                'template'      => sanitize_key($template),\\n                'subject'       => sanitize_text_field($subject),\\n                'body'          => wp_kses_post($body),\\n                'status'        => 'pending',\\n                'attempts'      => 0,\\n                'priority'      => max(1, min(10, intval($priority))),\\n                'scheduled_at'  => $scheduled_at,\\n                'created_at'    => $created_at,\\n            ),\\n            array('%d', '%d', '%s', '%s', '%s', '%s', '%d', '%d', '%s', '%s')\\n        );\\n\\n        if (!$inserted) {\\n            // Log the specific DB error for debugging\\n            error_log('RTS Queue Insert Error: ' . $wpdb->last_error);\\n            return new WP_Error('queue_insert_failed', 'Failed to enqueue email');\\n        }\\n\\n        $queue_id = intval($wpdb->insert_id);\\n\\n        do_action('rts_email_queued', $queue_id, $template);\\n\\n        return $queue_id;\\n    }\\n\\n    /**\\n     * Fetch pending items for processing.\\n     * Used internally and by the Email Engine.\\n     *\\n     * @param int $limit\\n     * @return array\\n     */\\n    public function get_pending_items($limit = 100) {\\n        global $wpdb;\\n        $table = $wpdb->prefix . self::QUEUE_TABLE;\\n\\n        // Prioritize: High Priority > Oldest Schedule\\n        // Using GMT for comparison\\n        $now = current_time('mysql', true);\\n\\n        // Using the composite index (status, scheduled_at) implicitly via the WHERE clause\\n        $sql = $wpdb->prepare(\\n            \\\"SELECT * FROM {$table}\\n             WHERE status = 'pending'\\n             AND scheduled_at <= %s\\n             ORDER BY priority DESC, scheduled_at ASC\\n             LIMIT %d\\\",\\n            $now,\\n            intval($limit)\\n        );\\n\\n        return $wpdb->get_results($sql);\\n    }\\n\\n    /**\\n     * Mark an item as processing safely to avoid races.\\n     * Uses atomic UPDATE to ensure only one process claims the row.\\n     *\\n     * @param int $queue_id\\n     * @return bool True if claimed, False if already claimed/processed.\\n     */\\n    private function claim_item($queue_id) {\\n        global $wpdb;\\n        $table = $wpdb->prefix . self::QUEUE_TABLE;\\n\\n        // Atomic update: Returns number of rows affected. \\n        // If 0, someone else claimed it or it's not pending.\\n        $updated = $wpdb->query($wpdb->prepare(\\n            \\\"UPDATE {$table} SET status = 'processing' \\n             WHERE id = %d AND status = 'pending'\\\",\\n            intval($queue_id)\\n        ));\\n\\n        return $updated === 1;\\n    }\\n\\n    /**\\n     * Process queue batch.\\n     *\\n     * @param int|null $limit\\n     * @return void\\n     */\\n    public function process_queue_batch($limit = null) {\\n        $start_time = time();\\n\\n        // Check pause state first\\n        if ($this->is_paused()) {\\n            return;\\n        }\\n\\n        $limit = $limit ? intval($limit) : intval(get_option('rts_email_batch_size', 100));\\n        if ($limit <= 0) {\\n            $limit = 50;\\n        }\\n\\n        update_option('rts_last_queue_run', current_time('mysql', true));\\n\\n        $items = $this->get_pending_items($limit);\\n        if (empty($items)) {\\n            return;\\n        }\\n\\n        foreach ($items as $item) {\\n            if (time() - $start_time > 45) { break; }\\n\\n            // Claim item to avoid double-sends (Atomicity check)\\n            if (!$this->claim_item($item->id)) {\\n                continue;\\n            }\\n\\n            /**\\n             * Let Email Engine send it.\\n             * The engine should call mark_sent / mark_failed.\\n             */\\n            do_action('rts_send_queued_email', $item);\\n        }\\n    }\\n\\n    /**\\n     * Mark item sent.\\n     *\\n     * @param int $queue_id\\n     * @return void\\n     */\\n    public function mark_sent($queue_id) {\\n        global $wpdb;\\n        $table = $wpdb->prefix . self::QUEUE_TABLE;\\n\\n        $wpdb->update(\\n            $table,\\n            array(\\n                'status'  => 'sent',\\n                'sent_at' => current_time('mysql', true),\\n            ),\\n            array('id' => intval($queue_id)),\\n            array('%s', '%s'),\\n            array('%d')\\n        );\\n    }\\n\\n    /**\\n     * Mark item failed and retry or dead-letter.\\n     *\\n     * @param int    $queue_id\\n     * @param string $error\\n     * @return void\\n     */\\n    public function mark_failed($queue_id, $error) {\\n        global $wpdb;\\n        $table = $wpdb->prefix . self::QUEUE_TABLE;\\n\\n        $queue_id = intval($queue_id);\\n        $max_attempts = intval(get_option('rts_email_retry_attempts', 3));\\n\\n        $item = $wpdb->get_row($wpdb->prepare(\\\"SELECT attempts, created_at FROM {$table} WHERE id = %d\\\", $queue_id));\\n        if (!$item) {\\n            return;\\n        }\\n\\n        $attempts = intval($item->attempts) + 1;\\n\\n        if ($attempts >= $max_attempts) {\\n            $this->move_to_dead_letter($queue_id, $error);\\n            return;\\n        }\\n\\n        // Exponential backoff: 5, 15, 45, 135 minutes...\\n        $delay_minutes = pow(3, $attempts) * 5; \\n        \\n        // Cap retry delay at 3 hours (180 minutes) to avoid waiting too long\\n        $delay_minutes = min($delay_minutes, 180);\\n        \\n        /**\\n         * Filter retry delay in minutes.\\n         *\\n         * @param int $delay_minutes Calculated delay.\\n         * @param int $attempts      Current attempt count.\\n         * @param int $queue_id      The queue item ID.\\n         */\\n        $delay_minutes = apply_filters('rts_email_retry_delay', $delay_minutes, $attempts, $queue_id);\\n\\n        $next_schedule = gmdate('Y-m-d H:i:s', time() + ($delay_minutes * 60));\\n\\n        // Single update to reschedule\\n        $wpdb->update(\\n            $table,\\n            array(\\n                'status'       => 'pending', // Set back to pending so it gets picked up\\n                'attempts'     => $attempts,\\n                'error_log'    => wp_strip_all_tags($error), // Safe storage\\n                'scheduled_at' => $next_schedule,\\n            ),\\n            array('id' => $queue_id),\\n            array('%s', '%d', '%s', '%s'),\\n            array('%d')\\n        );\\n    }\\n\\n    /**\\n     * Mark item cancelled (e.g. demo mode or unsubscribed).\\n     *\\n     * @param int    $queue_id\\n     * @param string $reason\\n     * @return void\\n     */\\n    public function mark_cancelled($queue_id, $reason) {\\n        global $wpdb;\\n        $table = $wpdb->prefix . self::QUEUE_TABLE;\\n\\n        $wpdb->update(\\n            $table,\\n            array(\\n                'status'    => 'cancelled',\\n                'error_log' => wp_strip_all_tags($reason),\\n                'sent_at'   => current_time('mysql', true), // Mark \\\"done\\\" time\\n            ),\\n            array('id' => intval($queue_id)),\\n            array('%s', '%s', '%s'),\\n            array('%d')\\n        );\\n    }\\n\\n    /**\\n     * Retry failed items (all or selected).\\n     *\\n     * @param array $ids Optional array of IDs to retry.\\n     * @return void\\n     */\\n    public function retry_failed_items($ids = array()) {\\n        global $wpdb;\\n        $table = $wpdb->prefix . self::QUEUE_TABLE;\\n\\n        $now = current_time('mysql', true);\\n\\n        if (empty($ids)) {\\n            // Retry ALL failed items\\n            $wpdb->query($wpdb->prepare(\\n                \\\"UPDATE {$table}\\n                 SET status = 'pending',\\n                     attempts = 0,\\n                     scheduled_at = %s\\n                 WHERE status = 'failed'\\\",\\n                $now\\n            ));\\n            return;\\n        }\\n\\n        // Validate IDs are integers\\n        $ids = array_map('intval', $ids);\\n        $ids = array_filter($ids); // Remove 0s\\n\\n        if (empty($ids)) return;\\n\\n        // Secure IN clause\\n        $placeholders = implode(',', array_fill(0, count($ids), '%d'));\\n        \\n        $sql = \\\"UPDATE {$table}\\n                SET status = 'pending',\\n                    attempts = 0,\\n                    scheduled_at = %s\\n                WHERE id IN ({$placeholders})\\\";\\n\\n        // Merge params: [scheduled_at, id1, id2, ...]\\n        $params = array_merge(array($now), $ids);\\n        \\n        $wpdb->query($wpdb->prepare($sql, $params));\\n    }\\n\\n    /**\\n     * Move a permanently failed item to dead letter queue.\\n     *\\n     * @param int    $queue_id\\n     * @param string $reason\\n     * @return bool\\n     */\\n    public function move_to_dead_letter($queue_id, $reason) {\\n        global $wpdb;\\n\\n        $queue_id = intval($queue_id);\\n        $table_queue = $wpdb->prefix . self::QUEUE_TABLE;\\n        $table_dlq   = $wpdb->prefix . self::DLQ_TABLE;\\n\\n        $item = $wpdb->get_row($wpdb->prepare(\\\"SELECT * FROM {$table_queue} WHERE id = %d\\\", $queue_id));\\n        if (!$item) {\\n            return false;\\n        }\\n\\n        $inserted = $wpdb->insert(\\n            $table_dlq,\\n            array(\\n                'original_id'   => intval($item->id),\\n                'subscriber_id' => intval($item->subscriber_id),\\n                'template'      => sanitize_key($item->template),\\n                'subject'       => sanitize_text_field($item->subject),\\n                'error_log'     => wp_strip_all_tags($reason),\\n                'attempts'      => intval($item->attempts),\\n                'created_at'    => $item->created_at,\\n                'moved_at'      => current_time('mysql', true),\\n            ),\\n            array('%d', '%d', '%s', '%s', '%s', '%d', '%s', '%s')\\n        );\\n\\n        if ($inserted) {\\n            // Remove original item\\n            $wpdb->delete($table_queue, array('id' => $queue_id), array('%d'));\\n            do_action('rts_email_dead_lettered', $queue_id, $reason);\\n            return true;\\n        }\\n\\n        return false;\\n    }\\n\\n    /**\\n     * Cleanup old queue items with transaction safety (best-effort).\\n     *\\n     * @return void\\n     */\\n    public function cleanup_old_queue_items() {\\n        global $wpdb;\\n        $table = $wpdb->prefix . self::QUEUE_TABLE;\\n\\n        // Clean Sent items > 90 days\\n        $wpdb->query($wpdb->prepare(\\n            \\\"DELETE FROM {$table} WHERE status = 'sent' AND sent_at < %s\\\",\\n            gmdate('Y-m-d H:i:s', strtotime('-90 days'))\\n        ));\\n\\n        // Clean Cancelled items > 30 days\\n        $wpdb->query($wpdb->prepare(\\n            \\\"DELETE FROM {$table} WHERE status = 'cancelled' AND created_at < %s\\\",\\n            gmdate('Y-m-d H:i:s', strtotime('-30 days'))\\n        ));\\n        \\n        // Recover stuck processing items (crashed/timeout)\\n        $cutoff = gmdate('Y-m-d H:i:s', strtotime('-1 hour'));\\n        \\n        $stuck_count = $wpdb->get_var($wpdb->prepare(\\n            \\\"SELECT COUNT(*) FROM {$table} WHERE status = 'processing' AND created_at < %s\\\",\\n            $cutoff\\n        ));\\n\\n        if ($stuck_count > 0) {\\n            error_log(sprintf('RTS Email Queue: Recovering %d stuck processing items.', $stuck_count));\\n            $wpdb->query($wpdb->prepare(\\n                \\\"UPDATE {$table} SET status = 'pending' WHERE status = 'processing' AND created_at < %s\\\",\\n                $cutoff\\n            ));\\n        }\\n    }\\n\\n    /**\\n     * Pause the queue processing.\\n     */\\n    public function pause_queue() {\\n        update_option('rts_email_queue_paused', time());\\n    }\\n\\n    /**\\n     * Resume the queue processing.\\n     */\\n    public function resume_queue() {\\n        delete_option('rts_email_queue_paused');\\n    }\\n\\n    /**\\n     * Check if queue is paused.\\n     * @return bool\\n     */\\n    public function is_paused() {\\n        return (bool) get_option('rts_email_queue_paused', false);\\n    }\\n\\n    /**\\n     * Bulk cancel items for a specific subscriber.\\n     * Useful when a user unsubscribes or is deleted.\\n     *\\n     * @param int $subscriber_id\\n     * @return int|false Number of rows affected or false on error.\\n     */\\n    public function bulk_cancel_by_subscriber($subscriber_id) {\\n        global $wpdb;\\n        $table = $wpdb->prefix . self::QUEUE_TABLE;\\n        \\n        return $wpdb->update(\\n            $table,\\n            array('status' => 'cancelled'),\\n            array('subscriber_id' => intval($subscriber_id), 'status' => 'pending'),\\n            array('%s'),\\n            array('%d', '%s')\\n        );\\n    }\\n\\n    /**\\n     * Get statistics broken down by template and status.\\n     * * @return array\\n     */\\n    public function get_template_stats() {\\n        global $wpdb;\\n        $table = $wpdb->prefix . self::QUEUE_TABLE;\\n        \\n        return $wpdb->get_results(\\n            \\\"SELECT template, status, COUNT(*) as count \\n             FROM {$table} \\n             GROUP BY template, status \\n             ORDER BY template, status\\\"\\n        );\\n    }\\n\\n    /**\\n     * Queue health stats.\\n     *\\n     * @return array\\n     */\\n    public function get_queue_health() {\\n        global $wpdb;\\n        $table = $wpdb->prefix . self::QUEUE_TABLE;\\n\\n        return array(\\n            'total_pending'     => intval($wpdb->get_var(\\\"SELECT COUNT(*) FROM {$table} WHERE status='pending'\\\")),\\n            'stuck_items'       => intval($wpdb->get_var(\\\"SELECT COUNT(*) FROM {$table} WHERE status='processing' AND created_at < DATE_SUB(NOW(), INTERVAL 1 HOUR)\\\")),\\n            'avg_wait_minutes'  => floatval($wpdb->get_var(\\\"SELECT AVG(TIMESTAMPDIFF(MINUTE, created_at, NOW())) FROM {$table} WHERE status='pending'\\\")),\\n            'hourly_throughput' => intval($wpdb->get_var(\\\"SELECT COUNT(*) FROM {$table} WHERE status='sent' AND sent_at > DATE_SUB(NOW(), INTERVAL 1 HOUR)\\\")),\\n            'is_paused'         => $this->is_paused(),\\n        );\\n    }\\n}\"\n        },\n        {\n            \"path\": \"subscribers/includes/class-email-renderer.php\",\n            \"size\": 14766,\n            \"ext\": \"php\",\n            \"content\": \"<?php\\n/**\\n * RTS Email Renderer - Digital Letter Design\\n *\\n * Renders branded HTML emails styled as handwritten \\\"digital letters\\\"\\n * with a dark container, centered paper card, and footer with social links.\\n *\\n * @package    RTS_Subscriber_System\\n * @subpackage Email\\n * @version    3.0.0\\n */\\n\\nif (!defined('ABSPATH')) {\\n    exit;\\n}\\n\\nclass RTS_Email_Renderer {\\n\\n    private $logo_url = 'https://reasonstostay.inkfire.co.uk/wp-content/uploads/2026/01/Screenshot-2026-01-27-at-00.30.21.png';\\n\\n    /**\\n     * Social links configuration.\\n     */\\n    private $socials = array(\\n        'facebook'  => 'https://www.facebook.com/ben.west.56884',\\n        'instagram' => 'https://www.instagram.com/iambenwest/?hl=en',\\n        'linkedin'  => 'https://www.linkedin.com/in/benwest2/?originalSubdomain=uk',\\n        'linktree'  => 'https://linktr.ee/iambenwest',\\n    );\\n\\n    /**\\n     * Render a complete email.\\n     *\\n     * @param string $template_name Template file name (without extension).\\n     * @param array  $data          Replacement variables.\\n     * @return string Complete HTML email.\\n     */\\n    public function render($template_name, $data = array()) {\\n        $content = $this->get_template_content($template_name);\\n\\n        $full_html = $this->get_header() . $content . $this->get_footer($data);\\n\\n        foreach ($data as $key => $value) {\\n            if (is_string($value)) {\\n                $full_html = str_replace('{{' . $key . '}}', $value, $full_html);\\n            }\\n        }\\n\\n        return $full_html;\\n    }\\n\\n    /**\\n     * Build the email header: dark wrapper + paper card + logo header.\\n     */\\n    private function get_header() {\\n        ob_start();\\n        ?>\\n<!DOCTYPE html>\\n<html lang=\\\"en\\\" xmlns=\\\"http://www.w3.org/1999/xhtml\\\" xmlns:v=\\\"urn:schemas-microsoft-com:vml\\\" xmlns:o=\\\"urn:schemas-microsoft-com:office:office\\\">\\n<head>\\n    <meta charset=\\\"UTF-8\\\">\\n    <meta name=\\\"viewport\\\" content=\\\"width=device-width, initial-scale=1.0\\\">\\n    <meta http-equiv=\\\"X-UA-Compatible\\\" content=\\\"IE=edge\\\">\\n    <title>Reasons to Stay</title>\\n    <!--[if mso]>\\n    <style type=\\\"text/css\\\">\\n        table { border-collapse: collapse; }\\n        .paper-card { width: 600px !important; }\\n    </style>\\n    <![endif]-->\\n    <link href=\\\"https://fonts.googleapis.com/css2?family=Special+Elite&display=swap\\\" rel=\\\"stylesheet\\\">\\n    <style type=\\\"text/css\\\">\\n        /* Reset */\\n        body, table, td, a { -webkit-text-size-adjust: 100%; -ms-text-size-adjust: 100%; }\\n        table, td { mso-table-lspace: 0pt; mso-table-rspace: 0pt; }\\n        img { -ms-interpolation-mode: bicubic; border: 0; height: auto; line-height: 100%; outline: none; text-decoration: none; }\\n        body { margin: 0 !important; padding: 0 !important; width: 100% !important; background-color: #F8F1E9; }\\n\\n        /* Outer wrapper (cream) */\\n        .email-wrapper { background-color: #F8F1E9; width: 100%; padding: 25px; }\\n\\n        /* Paper card */\\n        .paper-card {\\n            max-width: 600px;\\n            margin: 0 auto;\\n            background-color: #F8F1E9;\\n            border-radius: 4px;\\n        }\\n\\n        /* Header row */\\n        .header-table { width: 100%; }\\n        .header-table td { padding: 28px 32px; vertical-align: middle; }\\n        /* Logo is wordmark, not icon: let it breathe and scale down on mobile */\\n        .header-logo img { max-width: 240px; width: 100%; height: auto; display: block; }\\n        .header-text {\\n            font-family: Georgia, 'Times New Roman', serif;\\n            font-size: 12px;\\n            font-style: italic;\\n            color: #6b7280;\\n            line-height: 1.5;\\n            text-align: right;\\n        }\\n\\n        /* Body content */\\n        .letter-body {\\n            padding: 10px 36px 36px 36px;\\n            font-family: 'Special Elite', 'Courier New', monospace;\\n            font-size: 16px;\\n            line-height: 1.6;\\n            color: #1a1a1a;\\n            text-align: left;\\n        }\\n\\n        .letter-body p { margin: 0 0 16px 0; }\\n        .letter-body a { color: #0f172a; text-decoration: underline; }\\n\\n        /* CTA button */\\n        .cta-button {\\n            display: inline-block;\\n            padding: 12px 28px;\\n            background-color: #0f172a;\\n            color: #ffffff !important;\\n            text-decoration: none;\\n            border-radius: 4px;\\n            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;\\n            font-weight: bold;\\n            font-size: 14px;\\n            margin-top: 10px;\\n        }\\n\\n        /* Footer */\\n        .footer-wrapper { background-color: #1e293b; padding: 36px 32px; text-align: center; }\\n        .footer-text {\\n            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;\\n            font-size: 12px;\\n            line-height: 1.7;\\n            color: #94a3b8;\\n            max-width: 520px;\\n            margin: 0 auto;\\n        }\\n        .footer-text a { color: #FCA311; text-decoration: underline; }\\n\\n        .social-icons { margin: 24px 0; }\\n        .social-icon {\\n            display: inline-block;\\n            width: 32px;\\n            height: 32px;\\n            margin: 0 6px;\\n            vertical-align: middle;\\n        }\\n\\n        .footer-links {\\n            margin-top: 20px;\\n            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;\\n            font-size: 11px;\\n            color: #64748b;\\n        }\\n        .footer-links a { color: #94a3b8; text-decoration: underline; }\\n\\n        /* Responsive */\\n        @media only screen and (max-width: 620px) {\\n            .paper-card { width: 100% !important; border-radius: 0 !important; }\\n            .letter-body { padding: 10px 20px 28px 20px !important; font-size: 15px !important; }\\n            .header-table td { padding: 20px !important; }\\n            .footer-wrapper { padding: 28px 20px !important; }\\n            .header-text { font-size: 11px !important; }\\n            .email-wrapper { padding: 16px !important; }\\n        }\\n    </style>\\n</head>\\n<body style=\\\"margin:0;padding:0;background-color:#F8F1E9;\\\">\\n    <div class=\\\"email-wrapper\\\" style=\\\"background-color:#F8F1E9;width:100%;padding:25px;\\\">\\n        <!--[if mso]>\\n        <table role=\\\"presentation\\\" width=\\\"600\\\" align=\\\"center\\\" cellpadding=\\\"0\\\" cellspacing=\\\"0\\\" border=\\\"0\\\" style=\\\"background-color:#F8F1E9;\\\">\\n        <tr><td>\\n        <![endif]-->\\n        <div class=\\\"paper-card\\\" style=\\\"max-width:600px;margin:0 auto;background-color:#F8F1E9;border-radius:4px;overflow:hidden;\\\">\\n\\n            <!-- Header -->\\n            <table class=\\\"header-table\\\" role=\\\"presentation\\\" cellpadding=\\\"0\\\" cellspacing=\\\"0\\\" border=\\\"0\\\" width=\\\"100%\\\">\\n                <tr>\\n                    <td class=\\\"header-logo\\\" style=\\\"padding:28px 32px;vertical-align:middle;width:50%;\\\">\\n                        <img src=\\\"<?php echo esc_url($this->logo_url); ?>\\\" alt=\\\"Reasons to Stay\\\" style=\\\"max-width:240px;width:100%;height:auto;display:block;\\\" />\\n                    </td>\\n                    <td class=\\\"header-text\\\" style=\\\"padding:28px 32px;vertical-align:middle;width:50%;font-family:Georgia,'Times New Roman',serif;font-size:12px;font-style:italic;color:#6b7280;line-height:1.5;text-align:right;\\\">\\n                        This letter was written by someone in the world that cares. It was delivered to you at random.\\n                    </td>\\n                </tr>\\n            </table>\\n\\n            <!-- Body -->\\n            <div class=\\\"letter-body\\\" style=\\\"padding:10px 36px 36px 36px;font-family:'Special Elite','Courier New',monospace;font-size:16px;line-height:1.6;color:#1a1a1a;text-align:left;\\\">\\n        <?php\\n        return ob_get_clean();\\n    }\\n\\n    /**\\n     * Build the email footer: mission statement, social icons, legal links.\\n     */\\n    private function get_footer($data) {\\n        $unsubscribe_url = isset($data['unsubscribe_url']) ? $data['unsubscribe_url'] : '#';\\n        $manage_url      = isset($data['manage_url']) ? $data['manage_url'] : '';\\n        ob_start();\\n        ?>\\n            </div><!-- /.letter-body -->\\n\\n            <!-- Footer -->\\n            <div class=\\\"footer-wrapper\\\" style=\\\"background-color:#1e293b;padding:36px 32px;text-align:center;\\\">\\n\\n                <div class=\\\"footer-text\\\" style=\\\"font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,Helvetica,Arial,sans-serif;font-size:12px;line-height:1.7;color:#94a3b8;max-width:520px;margin:0 auto;\\\">\\n                    <strong style=\\\"color:#f8fafc;\\\">Reasons to Stay</strong> is a suicide prevention project reaching people at difficult moments through anonymous letters written by volunteers. Each letter on this site was written by a real person and delivered to you at random when you visited this page. This space exists as a reminder that we are not alone, even when it feels that way. There is someone, somewhere who wrote you a letter because they care.\\n                    <br><br>\\n                    If you&rsquo;d like to, you can <a href=\\\"https://reasonstostay.inkfire.co.uk\\\" style=\\\"color:#FCA311;text-decoration:underline;\\\">write your own letter</a> to a stranger, offering warmth, hope and connection to someone when they need it most.\\n                    <br><br>\\n                    This project was designed in memory of <strong style=\\\"color:#f8fafc;\\\">Sam West</strong>, who took his own life in 2018. If you&rsquo;re struggling right now, reaching out to a support service or someone you trust could really help. <a href=\\\"https://reasonstostay.inkfire.co.uk/resources\\\" style=\\\"color:#FCA311;text-decoration:underline;\\\">Find resources here</a>.\\n                    <br><br>\\n                    <span style=\\\"color:#64748b;\\\">Created by Ben West. Press: <a href=\\\"mailto:info@benwest.org.uk\\\" style=\\\"color:#FCA311;text-decoration:underline;\\\">info@benwest.org.uk</a></span>\\n                </div>\\n\\n                <!-- Social Icons -->\\n                <div class=\\\"social-icons\\\" style=\\\"margin:24px 0;text-align:center;\\\">\\n                    <?php echo $this->render_social_icon('Facebook', $this->socials['facebook'], 'M24 12.073c0-6.627-5.373-12-12-12s-12 5.373-12 12c0 5.99 4.388 10.954 10.125 11.854v-8.385H7.078v-3.47h3.047V9.43c0-3.007 1.792-4.669 4.533-4.669 1.312 0 2.686.235 2.686.235v2.953H15.83c-1.491 0-1.956.925-1.956 1.874v2.25h3.328l-.532 3.47h-2.796v8.385C19.612 23.027 24 18.062 24 12.073z'); ?>\\n                    <?php echo $this->render_social_icon('Instagram', $this->socials['instagram'], 'M12 2.163c3.204 0 3.584.012 4.85.07 3.252.148 4.771 1.691 4.919 4.919.058 1.265.069 1.645.069 4.849 0 3.205-.012 3.584-.069 4.849-.149 3.225-1.664 4.771-4.919 4.919-1.266.058-1.644.07-4.85.07-3.204 0-3.584-.012-4.849-.07-3.26-.149-4.771-1.699-4.919-4.92-.058-1.265-.07-1.644-.07-4.849 0-3.204.013-3.583.07-4.849.149-3.227 1.664-4.771 4.919-4.919 1.266-.057 1.645-.069 4.849-.069zM12 0C8.741 0 8.333.014 7.053.072 2.695.272.273 2.69.073 7.052.014 8.333 0 8.741 0 12c0 3.259.014 3.668.072 4.948.2 4.358 2.618 6.78 6.98 6.98C8.333 23.986 8.741 24 12 24c3.259 0 3.668-.014 4.948-.072 4.354-.2 6.782-2.618 6.979-6.98.059-1.28.073-1.689.073-4.948 0-3.259-.014-3.667-.072-4.947-.196-4.354-2.617-6.78-6.979-6.98C15.668.014 15.259 0 12 0zm0 5.838a6.162 6.162 0 100 12.324 6.162 6.162 0 000-12.324zM12 16a4 4 0 110-8 4 4 0 010 8zm6.406-11.845a1.44 1.44 0 100 2.881 1.44 1.44 0 000-2.881z'); ?>\\n                    <?php echo $this->render_social_icon('LinkedIn', $this->socials['linkedin'], 'M20.447 20.452h-3.554v-5.569c0-1.328-.027-3.037-1.852-3.037-1.853 0-2.136 1.445-2.136 2.939v5.667H9.351V9h3.414v1.561h.046c.477-.9 1.637-1.85 3.37-1.85 3.601 0 4.267 2.37 4.267 5.455v6.286zM5.337 7.433a2.062 2.062 0 01-2.063-2.065 2.064 2.064 0 112.063 2.065zm1.782 13.019H3.555V9h3.564v11.452zM22.225 0H1.771C.792 0 0 .774 0 1.729v20.542C0 23.227.792 24 1.771 24h20.451C23.2 24 24 23.227 24 22.271V1.729C24 .774 23.2 0 22.222 0h.003z'); ?>\\n                    <?php echo $this->render_social_icon('Linktree', $this->socials['linktree'], 'M7.953 15.066l-.038-4.079 4.063-.002.002-3.933L6.039 1.11 8.207 0l3.799 3.612L15.801 0l2.168 1.11-5.939 5.942.002 3.933 4.063.002-.038 4.079-2.18-.003-3.871-3.674-3.871 3.674-2.18.003zm4.053 2.727h-.001l-3.888 3.696-2.168-1.109 4.007-3.981h.001l2.048 1.394zm0 0l2.048-1.394h.001l4.007 3.981-2.168 1.109-3.888-3.696z'); ?>\\n                </div>\\n\\n                <!-- Links -->\\n                <div class=\\\"footer-links\\\" style=\\\"margin-top:20px;font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,sans-serif;font-size:11px;color:#64748b;\\\">\\n                    <a href=\\\"<?php echo esc_url($unsubscribe_url); ?>\\\" style=\\\"color:#94a3b8;text-decoration:underline;\\\">Unsubscribe</a>\\n                    <?php if ($manage_url) : ?>\\n                        &nbsp;&middot;&nbsp;\\n                        <a href=\\\"<?php echo esc_url($manage_url); ?>\\\" style=\\\"color:#94a3b8;text-decoration:underline;\\\">Manage Preferences</a>\\n                    <?php endif; ?>\\n                    &nbsp;&middot;&nbsp;\\n                    <a href=\\\"<?php echo esc_url(home_url('/privacy-policy')); ?>\\\" style=\\\"color:#94a3b8;text-decoration:underline;\\\">Privacy Policy</a>\\n                    <br>\\n                    &copy; <?php echo esc_html(date('Y')); ?> Reasons to Stay. All rights reserved.\\n                </div>\\n\\n            </div><!-- /.footer-wrapper -->\\n\\n        </div><!-- /.paper-card -->\\n        <!--[if mso]>\\n        </td></tr></table>\\n        <![endif]-->\\n    </div><!-- /.email-wrapper -->\\n</body>\\n</html>\\n        <?php\\n        return ob_get_clean();\\n    }\\n\\n    /**\\n     * Render a single SVG social icon as an inline link.\\n     *\\n     * @param string $label Accessible label.\\n     * @param string $url   Link destination.\\n     * @param string $path  SVG path data (24x24 viewBox).\\n     * @return string\\n     */\\n    private function render_social_icon($label, $url, $path) {\\n        $gold = '#FCA311';\\n        return sprintf(\\n            '<a href=\\\"%s\\\" target=\\\"_blank\\\" rel=\\\"noopener noreferrer\\\" title=\\\"%s\\\" style=\\\"display:inline-block;margin:0 6px;vertical-align:middle;text-decoration:none;\\\">\\n                <svg xmlns=\\\"http://www.w3.org/2000/svg\\\" width=\\\"28\\\" height=\\\"28\\\" viewBox=\\\"0 0 24 24\\\" fill=\\\"%s\\\" style=\\\"display:block;\\\">\\n                    <path d=\\\"%s\\\"/>\\n                </svg>\\n            </a>',\\n            esc_url($url),\\n            esc_attr($label),\\n            esc_attr($gold),\\n            esc_attr($path)\\n        );\\n    }\\n\\n    /**\\n     * Load a template file from the templates directory.\\n     *\\n     * @param string $template_name\\n     * @return string\\n     */\\n    private function get_template_content($template_name) {\\n        $file = plugin_dir_path(dirname(__FILE__)) . 'templates/' . $template_name . '.php';\\n        if (file_exists($file)) {\\n            ob_start();\\n            include $file;\\n            return ob_get_clean();\\n        }\\n        return '';\\n    }\\n}\\n\"\n        },\n        {\n            \"path\": \"subscribers/includes/class-email-templates.php\",\n            \"size\": 10989,\n            \"ext\": \"php\",\n            \"content\": \"<?php\\n/**\\n * RTS Email Templates\\n *\\n * Renders HTML email bodies with safe escaping.\\n *\\n * @package    RTS_Subscriber_System\\n * @subpackage Templates\\n * @version    1.0.2\\n */\\n\\nif (!defined('ABSPATH')) {\\n    exit;\\n}\\n\\nclass RTS_Email_Templates {\\n\\n    /**\\n     * Render a template.\\n     *\\n     * @param string $template      The template slug (e.g., 'welcome').\\n     * @param int    $subscriber_id The subscriber post ID.\\n     * @param array  $letters       Array of WP_Post objects for digest templates.\\n     * @param array  $context       Optional key/value pairs for custom variable replacement.\\n     * @return array {subject, body}\\n     */\\n    public function render($template, $subscriber_id, $letters = array(), $context = array()) {\\n        $template = sanitize_key($template);\\n\\n        // 0. Validate Template\\n        $valid_templates = array(\\n            'welcome', \\n            'verification', \\n            'daily_digest', \\n            'weekly_digest', \\n            'monthly_digest', \\n            'reconsent', \\n            'newsletter_custom',\\n            'all_caught_up'\\n        );\\n\\n        if (!in_array($template, $valid_templates, true)) {\\n            // Return safe fallback or error state to prevent PHP warnings in caller\\n            return array(\\n                'subject' => '[' . get_bloginfo('name') . '] Error',\\n                'body'    => '<p>Invalid email template requested.</p>'\\n            );\\n        }\\n\\n        // 1. Validate Subscriber & Fetch Data\\n        if (!$subscriber_id || get_post_type($subscriber_id) !== 'rts_subscriber') {\\n             return array(\\n                'subject' => '[' . get_bloginfo('name') . '] Error',\\n                'body'    => '<p>Invalid subscriber record.</p>'\\n            );\\n        }\\n\\n        $token = get_post_meta($subscriber_id, '_rts_subscriber_token', true);\\n        \\n        $manage_url      = $this->manage_url($token);\\n        $unsubscribe_url = $this->unsubscribe_url($token);\\n        $verify_url      = $this->verification_url($subscriber_id);\\n\\n        // 2. Initialize Standard Replacements\\n        $replacements = array(\\n            '{site_name}'        => esc_html(get_bloginfo('name')),\\n            '{manage_url}'       => esc_url($manage_url),\\n            '{unsubscribe_url}'  => esc_url($unsubscribe_url),\\n            '{verification_url}' => esc_url($verify_url),\\n            '{letters}'          => $this->render_letters($letters),\\n        );\\n\\n        // 3. Merge Context Replacements\\n        if (is_array($context) && !empty($context)) {\\n            foreach ($context as $k => $v) {\\n                // Ensure key format is wrapped in braces\\n                $key = '{' . trim($k, '{}') . '}';\\n                // Add or overwrite standard replacements\\n                $replacements[$key] = is_scalar($v) ? (string) $v : '';\\n            }\\n        }\\n\\n        // 4. Retrieve Template Content (Option or Default)\\n        $subject_opt = get_option('rts_email_subject_' . $template, '');\\n        $body_opt    = get_option('rts_email_body_' . $template, '');\\n\\n        if (!$subject_opt) {\\n            $subject_opt = $this->default_subject($template);\\n        }\\n        if (!$body_opt) {\\n            $body_opt = $this->default_body($template);\\n        }\\n\\n        // 5. Apply Replacements\\n        $subject = strtr($subject_opt, $replacements);\\n        $body    = strtr($body_opt, $replacements);\\n\\n        // 6. Security: Ensure safe HTML output\\n        $body = wp_kses_post($body);\\n\\n        return array(\\n            'subject' => $subject,\\n            'body'    => $this->wrap_email($body, $template, $manage_url, $unsubscribe_url),\\n        );\\n    }\\n\\n    private function default_subject($template) {\\n        $site = get_bloginfo('name');\\n        switch ($template) {\\n            case 'welcome':\\n                return \\\"Welcome to {$site}\\\";\\n            case 'verification':\\n                return \\\"Confirm your subscription to {$site}\\\";\\n            case 'daily_digest':\\n                return \\\"{$site} - Your daily letter\\\";\\n            case 'weekly_digest':\\n                return \\\"{$site} - Your weekly letters\\\";\\n            case 'monthly_digest':\\n                return \\\"{$site} - Your monthly letters\\\";\\n            case 'reconsent':\\n                return 'Please confirm what you want to receive from {site_name}';\\n            case 'newsletter_custom':\\n                return '{newsletter_subject}';\\n            case 'all_caught_up':\\n                return \\\"{$site} - All caught up\\\";\\n            default:\\n                return \\\"{$site} Updates\\\";\\n        }\\n    }\\n\\n    private function default_body($template) {\\n        $site = esc_html(get_bloginfo('name'));\\n        switch ($template) {\\n            case 'welcome':\\n                return '<h2>You\\\\'re subscribed </h2>'\\n                    . '<p>Thanks for signing up to ' . $site . '. You can manage your preferences here: '\\n                    . '<a href=\\\"{manage_url}\\\">{manage_url}</a>.</p>'\\n                    . '<p>If you ever want to unsubscribe, you can do that here: '\\n                    . '<a href=\\\"{unsubscribe_url}\\\">{unsubscribe_url}</a>.</p>';\\n            case 'verification':\\n                return '<h2>One last step</h2>'\\n                    . '<p>Please confirm your subscription by clicking this link:</p>'\\n                    . '<p><a href=\\\"{verification_url}\\\">Confirm my subscription</a></p>'\\n                    . '<p>If you didn\\\\'t request this, you can ignore this email.</p>';\\n            case 'daily_digest':\\n            case 'weekly_digest':\\n            case 'monthly_digest':\\n                return '<h2>Your letters</h2>'\\n                    . '{letters}'\\n                    . '<p>Manage your email frequency here: <a href=\\\"{manage_url}\\\">{manage_url}</a>.</p>'\\n                    . '<p><a href=\\\"{unsubscribe_url}\\\">Unsubscribe</a></p>';\\n            case 'reconsent':\\n                return '<p>Hello,</p><p>We\\\\'ve recently moved our subscriber system and we want to make sure we only email you what you\\\\'ve asked for.</p><p><strong>Please confirm your preferences here:</strong></p><p><a href=\\\"{manage_url}\\\" style=\\\"display:inline-block;padding:12px 18px;border-radius:10px;background:#179AD6;color:#fff;text-decoration:none;\\\">Manage my email preferences</a></p><p>If you take no action, we\\\\'ll pause emails until you confirm.</p>';\\n            case 'newsletter_custom':\\n                return '{newsletter_body}<p style=\\\"font-size:12px;opacity:0.8;\\\">Manage preferences: <a href=\\\"{manage_url}\\\">manage</a> | Unsubscribe: <a href=\\\"{unsubscribe_url}\\\">unsubscribe</a></p>';\\n            \\ncase 'all_caught_up':\\n    return '<h2>You\\\\'re all caught up</h2>'\\n        . '<p>We\\\\'ve already sent you every email-ready letter we have right now. We\\\\'ll email you as soon as there\\\\'s something new.</p>';\\ndefault:\\n                return \\\"<p>Updates from {$site}.</p>\\\";\\n        }\\n    }\\n\\n    private function wrap_email($body, $template, $manage_url, $unsubscribe_url) {\\n        // Colors configurable via options\\n        $bg    = get_option('rts_email_bg_color', '#ffffff');\\n        $text  = get_option('rts_email_text_color', '#111111');\\n        $muted = get_option('rts_email_muted_color', '#666666');\\n        $link  = get_option('rts_email_link_color', '#DF157C');\\n\\n        $html = '<!doctype html><html><head><meta charset=\\\"utf-8\\\"><meta name=\\\"viewport\\\" content=\\\"width=device-width, initial-scale=1\\\">';\\n        $html .= '<title>' . esc_html(get_bloginfo('name')) . '</title></head>';\\n        $html .= '<body style=\\\"margin:0;padding:0;background:' . esc_attr($bg) . ';color:' . esc_attr($text) . ';font-family:Arial, sans-serif;\\\">';\\n        $html .= '<div style=\\\"max-width:640px;margin:0 auto;padding:24px;\\\">';\\n        $html .= '<div style=\\\"border:1px solid #eee;border-radius:18px;padding:24px;\\\">';\\n        $html .= $body;\\n\\n        // Only add footer for templates that don't already have links in their default body.\\n        // Also exclude 'verification' as it is pre-subscription and shouldn't offer unsubscribe options.\\n        $excluded_templates = array(\\n            'welcome',\\n            'verification',\\n            'reconsent',\\n            'daily_digest',\\n            'weekly_digest',\\n            'monthly_digest',\\n            'newsletter_custom',\\n        );\\n\\n        if (!in_array($template, $excluded_templates, true)) {\\n            $html .= '<hr style=\\\"border:none;border-top:1px solid #eee;margin:24px 0;\\\">';\\n            $html .= '<p style=\\\"margin:0;color:' . esc_attr($muted) . ';font-size:13px;line-height:1.5;\\\">';\\n            $html .= 'Manage: <a style=\\\"color:' . esc_attr($link) . ';\\\" href=\\\"' . esc_url($manage_url) . '\\\">preferences</a>  ';\\n            $html .= '<a style=\\\"color:' . esc_attr($link) . ';\\\" href=\\\"' . esc_url($unsubscribe_url) . '\\\">unsubscribe</a>';\\n            $html .= '</p>';\\n        }\\n\\n        $html .= '</div></div></body></html>';\\n\\n        return $html;\\n    }\\n\\n    private function render_letters($letters) {\\n        if (empty($letters)) {\\n            return '<p>No letters available right now. Please check back soon.</p>';\\n        }\\n\\n        $out = '<div>';\\n        foreach ($letters as $post) {\\n            if (!$post instanceof WP_Post) {\\n                continue;\\n            }\\n\\n            $title     = get_the_title($post);\\n            $permalink = get_permalink($post);\\n            // Uses manual excerpt if available, otherwise safely trims content stripping tags to prevent HTML breakage in email clients.\\n            $content   = has_excerpt($post) ? get_the_excerpt($post) : wp_trim_words(wp_strip_all_tags($post->post_content), 55);\\n\\n            $out .= '<div style=\\\"padding:16px;border:1px solid #eee;border-radius:16px;margin:0 0 12px 0;\\\">';\\n            $out .= '<h3 style=\\\"margin:0 0 8px 0;font-size:16px;line-height:1.3;\\\">' . esc_html($title) . '</h3>';\\n            $out .= '<p style=\\\"margin:0 0 10px 0;color:#444;line-height:1.5;\\\">' . esc_html($content) . '</p>';\\n            $out .= '<p style=\\\"margin:0;\\\"><a href=\\\"' . esc_url($permalink) . '\\\">Read this letter</a></p>';\\n            $out .= '</div>';\\n        }\\n        $out .= '</div>';\\n\\n        return $out;\\n    }\\n\\n    private function manage_url($token) {\\n        if (!$token) return home_url('/');\\n        $sig = hash_hmac('sha256', $token . '|manage', wp_salt('auth'));\\n        return add_query_arg(array('rts_manage' => $token, 'sig' => $sig), home_url('/'));\\n    }\\n\\n    private function unsubscribe_url($token) {\\n        if (!$token) return home_url('/');\\n        $sig = hash_hmac('sha256', $token . '|unsubscribe|' . date('Y-m-d'), wp_salt('auth'));\\n        return add_query_arg(array('rts_unsubscribe' => $token, 'sig' => $sig), home_url('/'));\\n    }\\n\\n    private function verification_url($subscriber_id) {\\n        $token = get_post_meta($subscriber_id, '_rts_subscriber_verification_token', true);\\n        if (!$token) return home_url('/');\\n        $sig = hash_hmac('sha256', $token . '|verify|' . date('Y-m-d'), wp_salt('auth'));\\n        return add_query_arg(array('rts_verify' => $token, 'sig' => $sig), home_url('/'));\\n    }\\n}\"\n        },\n        {\n            \"path\": \"subscribers/includes/class-newsletter-cpt.php\",\n            \"size\": 24693,\n            \"ext\": \"php\",\n            \"content\": \"<?php\\n/**\\n * Newsletter Custom Post Type\\n *\\n * Manages the rts_newsletter CPT, batch sending, progress tracking,\\n * and metabox UI with a 2-column layout (Main vs Sidebar).\\n *\\n * @package    RTS_Subscriber_System\\n * @subpackage Newsletter\\n * @version    3.0.0\\n */\\n\\nif (!defined('ABSPATH')) {\\n    exit;\\n}\\n\\nclass RTS_Newsletter_CPT {\\n\\n    const POST_TYPE  = 'rts_newsletter';\\n    const BATCH_SIZE = 200;\\n\\n    public function __construct() {\\n        add_action('init', array($this, 'register_post_type'));\\n        add_action('add_meta_boxes', array($this, 'add_meta_boxes'));\\n        add_action('save_post_' . self::POST_TYPE, array($this, 'save_meta'), 10, 2);\\n        add_action('wp_ajax_rts_newsletter_test_send', array($this, 'ajax_test_send'));\\n        add_action('wp_ajax_rts_newsletter_send_all', array($this, 'ajax_send_all'));\\n        add_action('wp_ajax_rts_newsletter_progress', array($this, 'ajax_get_progress'));\\n        add_action('wp_ajax_rts_insert_random_letter', array($this, 'ajax_insert_random_letter'));\\n        add_action('rts_queue_newsletter_batch', array($this, 'process_queued_batch'));\\n        add_action('admin_enqueue_scripts', array($this, 'enqueue_admin_assets'));\\n    }\\n\\n    /**\\n     * Register the rts_newsletter custom post type.\\n     */\\n    public function register_post_type() {\\n        register_post_type(self::POST_TYPE, array(\\n            'labels' => array(\\n                'name'               => 'Newsletters',\\n                'singular_name'      => 'Newsletter',\\n                'add_new'            => 'Create Newsletter',\\n                'add_new_item'       => 'Create New Newsletter',\\n                'edit_item'          => 'Edit Newsletter',\\n                'new_item'           => 'New Newsletter',\\n                'view_item'          => 'View Newsletter',\\n                'search_items'       => 'Search Newsletters',\\n                'not_found'          => 'No newsletters found',\\n                'not_found_in_trash' => 'No newsletters found in trash',\\n            ),\\n            'public'             => false,\\n            'show_ui'            => true,\\n            'show_in_menu'       => 'edit.php?post_type=rts_subscriber',\\n            'capability_type'    => 'post',\\n            'capabilities'       => array(\\n                'edit_post'          => 'manage_options',\\n                'read_post'          => 'manage_options',\\n                'delete_post'        => 'manage_options',\\n                'edit_posts'         => 'manage_options',\\n                'edit_others_posts'  => 'manage_options',\\n                'publish_posts'      => 'manage_options',\\n                'read_private_posts' => 'manage_options',\\n            ),\\n            'supports'           => array('title', 'editor'),\\n            'menu_icon'          => 'dashicons-megaphone',\\n            'has_archive'        => false,\\n            'publicly_queryable' => false,\\n            'rewrite'            => false,\\n        ));\\n    }\\n\\n    /**\\n     * Enqueue CSS/JS on newsletter screens.\\n     */\\n    public function enqueue_admin_assets($hook) {\\n        global $post_type;\\n        if ($post_type !== self::POST_TYPE) {\\n            return;\\n        }\\n\\n        // Styling is handled globally by the theme's RTS admin stylesheet.\\n\\n        wp_register_script('rts-newsletter-admin', false, array('jquery'), null, true);\\n        wp_enqueue_script('rts-newsletter-admin');\\n\\n        wp_localize_script('rts-newsletter-admin', 'rtsNL', array(\\n            'ajax_url'    => admin_url('admin-ajax.php'),\\n            'nonce'       => wp_create_nonce('rts_newsletter_action'),\\n            'admin_email' => get_option('admin_email'),\\n        ));\\n\\n        wp_add_inline_script('rts-newsletter-admin', $this->get_inline_js());\\n    }\\n\\n    /**\\n     * Inline JS for sidebar buttons.\\n     */\\n    private function get_inline_js() {\\n        return \\\"\\n        jQuery(function($) {\\n            // Insert random letter\\n            $(document).on('click', '#rts-insert-letter', function(e) {\\n                e.preventDefault();\\n                var btn = $(this);\\n                btn.prop('disabled', true).text('Fetching...');\\n                $.post(rtsNL.ajax_url, {\\n                    action: 'rts_insert_random_letter',\\n                    nonce: rtsNL.nonce\\n                }, function(resp) {\\n                    btn.prop('disabled', false).text('Insert Random Letter');\\n                    if(resp.success && resp.data.content) {\\n                        if(typeof tinymce !== 'undefined' && tinymce.get('content')) {\\n                            tinymce.get('content').execCommand('mceInsertContent', false, resp.data.content);\\n                        } else {\\n                            var ta = document.getElementById('content');\\n                            if(ta) ta.value += resp.data.content;\\n                        }\\n                    } else {\\n                        alert(resp.data && resp.data.message ? resp.data.message : 'No letters available.');\\n                    }\\n                });\\n            });\\n\\n            // Insert social icons\\n            $(document).on('click', '#rts-insert-socials', function(e) {\\n                e.preventDefault();\\n                var html = '<p style=\\\\\\\"text-align:center;\\\\\\\">' +\\n                    '<a href=\\\\\\\"https://www.facebook.com/ben.west.56884\\\\\\\">Facebook</a> | ' +\\n                    '<a href=\\\\\\\"https://www.instagram.com/iambenwest/\\\\\\\">Instagram</a> | ' +\\n                    '<a href=\\\\\\\"https://www.linkedin.com/in/benwest2/\\\\\\\">LinkedIn</a> | ' +\\n                    '<a href=\\\\\\\"https://linktr.ee/iambenwest\\\\\\\">Linktree</a>' +\\n                    '</p>';\\n                if(typeof tinymce !== 'undefined' && tinymce.get('content')) {\\n                    tinymce.get('content').execCommand('mceInsertContent', false, html);\\n                } else {\\n                    var ta = document.getElementById('content');\\n                    if(ta) ta.value += html;\\n                }\\n            });\\n\\n            // Test send\\n            $(document).on('click', '#rts-test-send-btn', function(e) {\\n                e.preventDefault();\\n                var email = $('#rts-test-email').val() || rtsNL.admin_email;\\n                var postId = $('#post_ID').val();\\n                var btn = $(this);\\n                var msg = $('#rts-test-result');\\n\\n                btn.prop('disabled', true).text('Sending...');\\n                msg.html('');\\n\\n                $.post(rtsNL.ajax_url, {\\n                    action: 'rts_newsletter_test_send',\\n                    nonce: rtsNL.nonce,\\n                    post_id: postId,\\n                    email: email\\n                }, function(resp) {\\n                    btn.prop('disabled', false).text('Send Test');\\n                    if(resp.success) {\\n                        msg.html('<div class=\\\\\\\"rts-nl-note rts-nl-note--success\\\\\\\">Test sent to ' + email + '</div>');\\n                    } else {\\n                        msg.html('<div class=\\\\\\\"rts-nl-note rts-nl-note--danger\\\\\\\">' + (resp.data.message || 'Send failed.') + '</div>');\\n                    }\\n                });\\n            });\\n\\n            // Send to all\\n            $(document).on('click', '#rts-send-all-btn', function(e) {\\n                e.preventDefault();\\n                if(!confirm('Send this newsletter to ALL active subscribers?')) return;\\n                var postId = $('#post_ID').val();\\n                var btn = $(this);\\n                var prog = $('#rts-send-progress');\\n\\n                btn.prop('disabled', true);\\n                prog.html('<div class=\\\\\\\"rts-nl-note rts-nl-note--warn\\\\\\\">Queuing emails...</div>');\\n\\n                $.post(rtsNL.ajax_url, {\\n                    action: 'rts_newsletter_send_all',\\n                    nonce: rtsNL.nonce,\\n                    post_id: postId\\n                }, function(resp) {\\n                    if(resp.success) {\\n                        prog.html('<div class=\\\\\\\"rts-nl-note rts-nl-note--success\\\\\\\">Queued ' + resp.data.total + ' emails for delivery.</div>');\\n                        rtsNL_pollProgress(postId);\\n                    } else {\\n                        btn.prop('disabled', false);\\n                        prog.html('<div class=\\\\\\\"rts-nl-note rts-nl-note--danger\\\\\\\">' + (resp.data.message || 'Queue failed.') + '</div>');\\n                    }\\n                });\\n            });\\n\\n            function rtsNL_pollProgress(postId) {\\n                $.post(rtsNL.ajax_url, {\\n                    action: 'rts_newsletter_progress',\\n                    nonce: rtsNL.nonce,\\n                    post_id: postId\\n                }, function(resp) {\\n                    if(!resp.success) return;\\n                    var d = resp.data;\\n                    var pct = d.percent || 0;\\n                    var html = '<div style=\\\\\\\"margin-bottom:10px;\\\\\\\">' +\\n                        '<div style=\\\\\\\"height:8px;background:#020617;border:1px solid #334155;border-radius:999px;overflow:hidden;\\\\\\\">' +\\n                        '<div style=\\\\\\\"height:100%;width:' + pct + '%;background:#FCA311;transition:width 0.3s;\\\\\\\"></div></div></div>' +\\n                        '<span style=\\\\\\\"font-size:12px;color:#94a3b8;\\\\\\\">' + pct + '% complete (' + d.queued + '/' + d.total + ')</span>';\\n                    $('#rts-send-progress').html(html);\\n                    if(pct < 100) setTimeout(function(){ rtsNL_pollProgress(postId); }, 3000);\\n                    else {\\n                        $('#rts-send-all-btn').prop('disabled', false);\\n                        $('#rts-send-progress').html('<div class=\\\\\\\"rts-nl-note rts-nl-note--success\\\\\\\">All emails delivered.</div>');\\n                    }\\n                });\\n            }\\n        });\\n        \\\";\\n    }\\n\\n    /**\\n     * Add metaboxes: Schedule, Helpers, Test, Send.\\n     */\\n    public function add_meta_boxes() {\\n        // Sidebar: Schedule\\n        add_meta_box(\\n            'rts_newsletter_schedule',\\n            'Schedule',\\n            array($this, 'render_schedule_metabox'),\\n            self::POST_TYPE,\\n            'side',\\n            'high'\\n        );\\n\\n        // Sidebar: Helpers\\n        add_meta_box(\\n            'rts_newsletter_helpers',\\n            'Content Helpers',\\n            array($this, 'render_helpers_metabox'),\\n            self::POST_TYPE,\\n            'side',\\n            'default'\\n        );\\n\\n        // Sidebar: Test & Send\\n        add_meta_box(\\n            'rts_newsletter_send',\\n            'Test & Send',\\n            array($this, 'render_send_metabox'),\\n            self::POST_TYPE,\\n            'side',\\n            'default'\\n        );\\n    }\\n\\n    /**\\n     * Render the Schedule metabox.\\n     */\\n    public function render_schedule_metabox($post) {\\n        wp_nonce_field('rts_newsletter_meta', '_rts_newsletter_nonce');\\n        $date = get_post_meta($post->ID, '_rts_newsletter_send_date', true);\\n        $time = get_post_meta($post->ID, '_rts_newsletter_send_time', true);\\n        ?>\\n        <div class=\\\"rts-nl-card\\\">\\n            <span class=\\\"rts-nl-card__title\\\">Send Date</span>\\n            <div class=\\\"rts-nl-field\\\">\\n                <label class=\\\"rts-nl-label\\\">Date</label>\\n                <input type=\\\"date\\\" name=\\\"_rts_newsletter_send_date\\\" value=\\\"<?php echo esc_attr($date); ?>\\\" class=\\\"rts-nl-input\\\">\\n            </div>\\n            <div class=\\\"rts-nl-field\\\">\\n                <label class=\\\"rts-nl-label\\\">Time (24h)</label>\\n                <input type=\\\"time\\\" name=\\\"_rts_newsletter_send_time\\\" value=\\\"<?php echo esc_attr($time ?: '09:00'); ?>\\\" class=\\\"rts-nl-input\\\">\\n            </div>\\n            <p class=\\\"rts-nl-help\\\">Leave blank to send immediately when published.</p>\\n        </div>\\n        <?php\\n    }\\n\\n    /**\\n     * Render the Helpers metabox.\\n     */\\n    public function render_helpers_metabox($post) {\\n        ?>\\n        <div class=\\\"rts-nl-card\\\">\\n            <span class=\\\"rts-nl-card__title\\\">Quick Insert</span>\\n            <button type=\\\"button\\\" id=\\\"rts-insert-letter\\\" class=\\\"rts-button secondary\\\" style=\\\"width:100%;margin-bottom:10px;justify-content:center;\\\">\\n                <span class=\\\"dashicons dashicons-welcome-write-blog\\\"></span> Insert Random Letter\\n            </button>\\n            <button type=\\\"button\\\" id=\\\"rts-insert-socials\\\" class=\\\"rts-button secondary\\\" style=\\\"width:100%;justify-content:center;\\\">\\n                <span class=\\\"dashicons dashicons-share\\\"></span> Insert Socials\\n            </button>\\n            <p class=\\\"rts-nl-help\\\" style=\\\"margin-top:10px;\\\">Inserts content at cursor position in the editor.</p>\\n        </div>\\n        <?php\\n    }\\n\\n    /**\\n     * Render the Test & Send metabox.\\n     */\\n    public function render_send_metabox($post) {\\n        $status = get_post_meta($post->ID, '_rts_newsletter_send_status', true);\\n        ?>\\n        <div class=\\\"rts-nl-card\\\">\\n            <div style=\\\"margin:0 0 10px 0;color:rgba(255,255,255,0.84);line-height:1.5;\\\">\\n                Recipients are filtered automatically: Active + Verified + Newsletters ticked<?php echo get_option('rts_email_reconsent_required') ? ' + consent confirmed' : ''; ?>.<br>\\n                The send count you see is the number of eligible subscribers after those rules are applied.\\n            </div>\\n\\n            <span class=\\\"rts-nl-card__title\\\">Test Email</span>\\n            <div class=\\\"rts-nl-field\\\">\\n                <input type=\\\"email\\\" id=\\\"rts-test-email\\\" class=\\\"rts-nl-input\\\"\\n                       placeholder=\\\"<?php echo esc_attr(get_option('admin_email')); ?>\\\"\\n                       value=\\\"<?php echo esc_attr(get_option('admin_email')); ?>\\\">\\n            </div>\\n            <button type=\\\"button\\\" id=\\\"rts-test-send-btn\\\" class=\\\"rts-button\\\" style=\\\"width:100%;justify-content:center;\\\">\\n                <span class=\\\"dashicons dashicons-email\\\"></span> Send Test\\n            </button>\\n            <div id=\\\"rts-test-result\\\" style=\\\"margin-top:10px;\\\"></div>\\n        </div>\\n\\n        <hr class=\\\"rts-nl-sep\\\">\\n\\n        <div class=\\\"rts-nl-card\\\">\\n            <span class=\\\"rts-nl-card__title\\\">Send to All Subscribers</span>\\n            <?php if ($status === 'sent') : ?>\\n                <div class=\\\"rts-nl-note rts-nl-note--success\\\">\\n                    This newsletter has been sent.\\n                    <div class=\\\"rts-nl-note__meta\\\">\\n                        Sent: <?php echo esc_html(get_post_meta($post->ID, '_rts_newsletter_sent_at', true)); ?>\\n                    </div>\\n                </div>\\n            <?php elseif ($status === 'sending') : ?>\\n                <div class=\\\"rts-nl-note rts-nl-note--warn\\\">\\n                    Send in progress...\\n                </div>\\n                <div id=\\\"rts-send-progress\\\"></div>\\n            <?php else : ?>\\n                <button type=\\\"button\\\" id=\\\"rts-send-all-btn\\\" class=\\\"rts-button primary\\\" style=\\\"width:100%;justify-content:center;\\\">\\n                    <span class=\\\"dashicons dashicons-megaphone\\\"></span> Send Newsletter\\n                </button>\\n                <div id=\\\"rts-send-progress\\\" style=\\\"margin-top:10px;\\\"></div>\\n                <p class=\\\"rts-nl-help\\\" style=\\\"margin-top:10px;\\\">Sends to all active, verified subscribers who opted into newsletters.</p>\\n            <?php endif; ?>\\n        </div>\\n        <?php\\n    }\\n\\n    /**\\n     * Save metabox data.\\n     */\\n    public function save_meta($post_id, $post) {\\n        if (!isset($_POST['_rts_newsletter_nonce'])) return;\\n        if (!wp_verify_nonce($_POST['_rts_newsletter_nonce'], 'rts_newsletter_meta')) return;\\n        if (defined('DOING_AUTOSAVE') && DOING_AUTOSAVE) return;\\n        if (!current_user_can('manage_options')) return;\\n\\n        if (isset($_POST['_rts_newsletter_send_date'])) {\\n            update_post_meta($post_id, '_rts_newsletter_send_date', sanitize_text_field($_POST['_rts_newsletter_send_date']));\\n        }\\n        if (isset($_POST['_rts_newsletter_send_time'])) {\\n            update_post_meta($post_id, '_rts_newsletter_send_time', sanitize_text_field($_POST['_rts_newsletter_send_time']));\\n        }\\n    }\\n\\n    /**\\n     * AJAX: Send test email.\\n     */\\n    public function ajax_test_send() {\\n        check_ajax_referer('rts_newsletter_action', 'nonce');\\n        if (!current_user_can('manage_options')) {\\n            wp_send_json_error(array('message' => 'Unauthorized'));\\n        }\\n\\n        $post_id = absint($_POST['post_id'] ?? 0);\\n        $email   = sanitize_email($_POST['email'] ?? '');\\n\\n        if (!$post_id || !$email) {\\n            wp_send_json_error(array('message' => 'Missing post ID or email'));\\n        }\\n\\n        $post = get_post($post_id);\\n        if (!$post || $post->post_type !== self::POST_TYPE) {\\n            wp_send_json_error(array('message' => 'Invalid newsletter'));\\n        }\\n\\n        $subject = '[TEST] ' . $post->post_title;\\n        $body    = wpautop($post->post_content);\\n\\n        $sent = wp_mail($email, $subject, $body, array('Content-Type: text/html; charset=UTF-8'));\\n\\n        if ($sent) {\\n            wp_send_json_success(array('message' => 'Sent to ' . $email));\\n        }\\n        wp_send_json_error(array('message' => 'Failed to send test email.'));\\n    }\\n\\n    /**\\n     * AJAX: Queue newsletter for all subscribers.\\n     */\\n    public function ajax_send_all() {\\n        check_ajax_referer('rts_newsletter_action', 'nonce');\\n        if (!current_user_can('manage_options')) {\\n            wp_send_json_error(array('message' => 'Unauthorized'));\\n        }\\n\\n        $post_id = absint($_POST['post_id'] ?? 0);\\n        if (!$post_id) {\\n            wp_send_json_error(array('message' => 'Missing post ID'));\\n        }\\n\\n        $total = $this->count_total_subscribers($post_id);\\n        if ($total === 0) {\\n            wp_send_json_error(array('message' => 'No eligible subscribers found.'));\\n        }\\n\\n        update_post_meta($post_id, '_rts_newsletter_send_status', 'sending');\\n        update_post_meta($post_id, '_rts_newsletter_total_recipients', $total);\\n        update_post_meta($post_id, '_rts_newsletter_queued_count', 0);\\n\\n        if (!wp_next_scheduled('rts_queue_newsletter_batch', array($post_id))) {\\n            wp_schedule_single_event(time(), 'rts_queue_newsletter_batch', array($post_id));\\n        }\\n\\n        wp_send_json_success(array('total' => $total, 'message' => \\\"Queued for $total subscribers\\\"));\\n    }\\n\\n    /**\\n     * AJAX: Get send progress.\\n     */\\n    public function ajax_get_progress() {\\n        check_ajax_referer('rts_newsletter_action', 'nonce');\\n\\n        $post_id = absint($_POST['post_id'] ?? 0);\\n        $progress = $this->get_send_progress($post_id);\\n        wp_send_json_success($progress);\\n    }\\n\\n    /**\\n     * AJAX: Insert random letter content.\\n     */\\n    public function ajax_insert_random_letter() {\\n        check_ajax_referer('rts_newsletter_action', 'nonce');\\n        if (!current_user_can('manage_options')) {\\n            wp_send_json_error(array('message' => 'Unauthorized'));\\n        }\\n\\n        $letters = get_posts(array(\\n            'post_type'      => 'letter',\\n            'post_status'    => 'publish',\\n            'posts_per_page' => 1,\\n            'orderby'        => 'rand',\\n            'meta_query'     => array(\\n                array(\\n                    'key'     => '_rts_email_ready',\\n                    'value'   => 'true',\\n                    'compare' => '=',\\n                ),\\n            ),\\n        ));\\n\\n        if (empty($letters)) {\\n            $letters = get_posts(array(\\n                'post_type'      => 'letter',\\n                'post_status'    => 'publish',\\n                'posts_per_page' => 1,\\n                'orderby'        => 'rand',\\n            ));\\n        }\\n\\n        if (empty($letters)) {\\n            wp_send_json_error(array('message' => 'No published letters found.'));\\n        }\\n\\n        $letter = $letters[0];\\n        $content = '<blockquote style=\\\"font-family:\\\\'Special Elite\\\\',\\\\'Courier New\\\\',monospace;line-height:1.6;\\\">';\\n        $content .= wpautop($letter->post_content);\\n        $content .= '</blockquote>';\\n\\n        wp_send_json_success(array('content' => $content, 'title' => $letter->post_title));\\n    }\\n\\n    /**\\n     * WP-Cron: Process a batch of queued newsletter emails.\\n     */\\n    public function process_queued_batch($post_id) {\\n        $post = get_post($post_id);\\n        if (!$post || $post->post_type !== self::POST_TYPE) {\\n            return;\\n        }\\n\\n        $status = get_post_meta($post_id, '_rts_newsletter_send_status', true);\\n        if ($status !== 'sending') {\\n            return;\\n        }\\n\\n        $offset = (int) get_post_meta($post_id, '_rts_newsletter_queued_count', true);\\n\\n        $subscribers = get_posts(array(\\n            'post_type'      => 'rts_subscriber',\\n            'post_status'    => 'publish',\\n            'posts_per_page' => self::BATCH_SIZE,\\n            'offset'         => $offset,\\n            'orderby'        => 'ID',\\n            'order'          => 'ASC',\\n            'fields'         => 'ids',\\n            'meta_query'     => array(\\n                'relation' => 'AND',\\n                array('key' => '_rts_subscriber_status', 'value' => 'active', 'compare' => '='),\\n                array('key' => '_rts_pref_newsletters', 'value' => '1', 'compare' => '='),\\n                array('key' => '_rts_subscriber_verified', 'value' => '1', 'compare' => '='),\\n            ),\\n        ));\\n\\n        if (empty($subscribers)) {\\n            update_post_meta($post_id, '_rts_newsletter_send_status', 'sent');\\n            update_post_meta($post_id, '_rts_newsletter_sent_at', current_time('mysql'));\\n            return;\\n        }\\n\\n        global $wpdb;\\n        $queue_table = $wpdb->prefix . 'rts_email_queue';\\n        $now_gmt     = gmdate('Y-m-d H:i:s');\\n\\n        foreach ($subscribers as $subscriber_id) {\\n            $email = get_post_meta($subscriber_id, '_rts_email', true);\\n            if (!$email || !is_email($email)) {\\n                $email = get_the_title($subscriber_id);\\n            }\\n            if (!$email || !is_email($email)) {\\n                continue;\\n            }\\n\\n            $wpdb->insert($queue_table, array(\\n                'subscriber_id' => $subscriber_id,\\n                'email'         => $email,\\n                'template'      => 'newsletter',\\n                'newsletter_id' => $post_id,\\n                'subject'       => $post->post_title,\\n                'body'          => wpautop($post->post_content),\\n                'status'        => 'pending',\\n                'scheduled_at'  => $now_gmt,\\n                'created_at'    => $now_gmt,\\n            ));\\n        }\\n\\n        $new_offset = $offset + count($subscribers);\\n        update_post_meta($post_id, '_rts_newsletter_queued_count', $new_offset);\\n\\n        if (count($subscribers) >= self::BATCH_SIZE) {\\n            wp_schedule_single_event(time() + 5, 'rts_queue_newsletter_batch', array($post_id));\\n        } else {\\n            update_post_meta($post_id, '_rts_newsletter_send_status', 'sent');\\n            update_post_meta($post_id, '_rts_newsletter_sent_at', current_time('mysql'));\\n        }\\n    }\\n\\n    /**\\n     * Get send progress for a newsletter.\\n     */\\n    private function get_send_progress($post_id) {\\n        $total  = (int) get_post_meta($post_id, '_rts_newsletter_total_recipients', true);\\n        $queued = (int) get_post_meta($post_id, '_rts_newsletter_queued_count', true);\\n\\n        $remaining_batches = $total > 0 ? max(0, ceil(($total - $queued) / self::BATCH_SIZE)) : 0;\\n\\n        return array(\\n            'percent' => $total > 0 ? round(($queued / $total) * 100) : 0,\\n            'queued' => $queued,\\n            'total' => $total,\\n            'remaining_batches' => $remaining_batches,\\n            'estimated_time' => $remaining_batches * 5\\n        );\\n    }\\n\\n    /**\\n     * Count total subscribers matching criteria for a specific newsletter.\\n     */\\n    private function count_total_subscribers($newsletter_id) {\\n        $args = array(\\n            'post_type'              => 'rts_subscriber',\\n            'post_status'            => 'publish',\\n            'fields'                 => 'ids',\\n            'no_found_rows'          => false,\\n            'posts_per_page'         => 1,\\n            'update_post_meta_cache' => false,\\n            'update_post_term_cache' => false,\\n            'meta_query'             => array(\\n                'relation' => 'AND',\\n                array('key' => '_rts_subscriber_status', 'value' => 'active', 'compare' => '='),\\n                array('key' => '_rts_pref_newsletters', 'value' => '1', 'compare' => '='),\\n                array('key' => '_rts_subscriber_verified', 'value' => '1', 'compare' => '=')\\n            ),\\n        );\\n\\n        if (get_option('rts_email_reconsent_required')) {\\n            $args['meta_query'][] = array('key' => '_rts_subscriber_consent_confirmed', 'compare' => 'EXISTS');\\n        }\\n\\n        $args = apply_filters('rts_newsletter_subscriber_query', $args, $newsletter_id);\\n\\n        $query = new WP_Query($args);\\n        return $query->found_posts;\\n    }\\n}\\n\"\n        },\n        {\n            \"path\": \"subscribers/includes/class-smtp-settings.php\",\n            \"size\": 20733,\n            \"ext\": \"php\",\n            \"content\": \"<?php\\n/**\\n * RTS SMTP Configuration\\n *\\n * Handles SMTP settings, password encryption, and WordPress mail integration.\\n * Settings UI is grouped into .rts-card containers:\\n *   - Sender Identity\\n *   - Social Links\\n *   - Branding\\n *\\n * @package    RTS_Subscriber_System\\n * @subpackage SMTP\\n * @version    3.0.0\\n */\\n\\nif (!defined('ABSPATH')) {\\n    exit;\\n}\\n\\nclass RTS_SMTP_Settings {\\n\\n    const OPTION_GROUP = 'rts_smtp_settings_group';\\n    const PAGE_SLUG    = 'rts-smtp-settings';\\n\\n    public function __construct() {\\n        if (is_admin()) {\\n            add_action('admin_menu', array($this, 'add_admin_menu'));\\n            add_action('admin_init', array($this, 'register_settings'));\\n            add_action('admin_init', array($this, 'maybe_redirect_legacy_smtp_page'), 1);\\n            add_action('wp_ajax_rts_test_smtp', array($this, 'ajax_test_smtp'));\\n            add_action('admin_enqueue_scripts', array($this, 'enqueue_scripts'));\\n            add_filter('plugin_action_links_' . plugin_basename(__FILE__), array($this, 'add_settings_link'));\\n\\n            // Back-compat safety: some older builds used 'rts_smtp_settings' as the option_page\\n            // group",
  "context_truncated": true,
  "context_format": "json",
  "agent_md": "# AI Coding Agent Instructions for Foundation AI Bridge\n\n## Project Overview\n**Foundation AI Bridge** is a WordPress plugin that generates optimized, context-aware codebases for AI analysis and continued development.\nCurrent version: **6.6.1**.\n\nScan target: **Hello-Elementor-Child-RTS-v5.2.27**.\n\n## Key Technologies\n- PHP 7.4+\n- WordPress (Admin UI, AJAX, REST)\n- JSON/Markdown output formats\n- Secure capability + nonce patterns\n\n## Architecture Overview\n### Entry Points\n- Identify the main bootstrap file and initialization hooks in the scan output.\n\n### Structure Snapshot\n- Scanned files: 50\n- Detected classes: 44\n- Detected hooks: 50\n\n### Public AJAX Endpoints\n- `rts_import_progress` (found in subscribers/includes/class-csv-importer.php)\n- `rts_cancel_import` (found in subscribers/includes/class-csv-importer.php)\n- `rts_newsletter_test_send` (found in subscribers/includes/class-newsletter-cpt.php)\n- `rts_newsletter_send_all` (found in subscribers/includes/class-newsletter-cpt.php)\n- `rts_newsletter_progress` (found in subscribers/includes/class-newsletter-cpt.php)\n- `rts_insert_random_letter` (found in subscribers/includes/class-newsletter-cpt.php)\n- `rts_test_smtp` (found in subscribers/includes/class-smtp-settings.php)\n- `rts_handle_subscription` (found in subscribers/class-rts-subscriber-system.php)\n- `nopriv_rts_handle_subscription` (found in subscribers/class-rts-subscriber-system.php)\n- `rts_track_share` (found in inc/rts-moderation-engine.php)\n- `nopriv_rts_track_share` (found in inc/rts-moderation-engine.php)\n- `rts_record_feedback_ajax` (found in inc/rts-moderation-learning.php)\n- `rts_random_letter` (found in inc/rts-rest-api.php)\n- `nopriv_rts_random_letter` (found in inc/rts-rest-api.php)\n- `nopriv_rts_submit_letter` (found in inc/shortcodes.php)\n- `rts_submit_letter` (found in inc/shortcodes.php)\n\n## Data Storage Map\nThis section lists persistent storage keys and where they are read/written.\n\n\nSchema/defaults: not inferred by static scan unless explicitly declared near the option key (best practice: document defaults in a constants/config class).\n\n## Permission and Security Rules\nThis section lists detected nonce and capability checks for admin actions/endpoints.\n\n## Output Contract (AICB Generator)\nWhen interacting with AICB generation endpoints, assume the following stable payload contract.\n\naicb_generate_context success payload (wp_send_json_success):\n- success: true\n- data.scan_id: string\n- data.summary: object (file_count, total_size_raw, total_size, class_count, function_count, hook_count, est_tokens, complexity_score)\n- data.context_format: 'json'|'md'\n- data.context_truncated: bool\n- data.context: string (valid JSON text only when not truncated)\n- data.context_preview: string (present when truncated)\n\naicb_generate_context error payload (wp_send_json_error):\n- success: false\n- data.message: string\n- data.code: string|int (optional)\n\n## Scan Completeness Signals\nA scan is considered *complete* when required sections are present and internally consistent.\n\nRequired sections: `summary`, `structure`, `index`\nMissing required sections: none\n\nScan modes may omit or stub file contents for performance. Structural/index data should still be present for a complete scan.\n\n## Critical Patterns & Conventions\n1. Preserve capability checks and nonces for any admin actions.\n2. Prefer additive changes that match existing structure and naming conventions.\n3. Avoid breaking backwards compatibility (especially option keys, hooks, and public endpoints).\n4. If the filesystem is restricted, ensure file-write features degrade gracefully.\n\n## Development Workflows\n### When adding new features\nFollow the plugins existing architectural pattern (traits/classes) and keep:\n- Security first (caps + nonce)\n- Performance in mind (avoid scanning huge files raw when possible)\n- Predictable output (stable keys + predictable sections)\n\n### How to navigate this codebase\nStart from entry points, then locate:\n- Hook registrations (admin menu, ajax, rest)\n- Storage layers (options, files, caches)\n- Output formatting + download/export logic\n\n## Interpretation Guide\nUse this quick map to understand how the scan output is organised:\n- Structure: what exists (files, classes, functions).\n- Index: where functionality is registered (hooks, AJAX, REST, shortcodes).\n- Behaviour Index: patterns that may affect runtime behaviour, security, or performance.\n\n## Key Hooks Detected\n- `admin_post_rts_toggle_pause_sending`\n- `admin_menu`\n- `admin_init`\n- `admin_notices`\n- `admin_post_rts_save_template`\n- `admin_post_rts_test_template`\n- `admin_post_rts_add_subscriber`\n- `admin_enqueue_scripts`\n- `after_switch_theme`\n- `init`\n- `rts_cron_health_check`\n- `admin_post_rts_send_reconsent`\n- `rts_send_reconsent_batch`\n- `wp_ajax_rts_handle_subscription`\n- `wp_ajax_nopriv_rts_handle_subscription`\n- `rts_automated_drip`\n- `updated_post_meta`\n- `added_post_meta`\n- `wp_enqueue_scripts`\n- `cron_schedules`\n- `publish_letter`\n- `site_status_tests`\n- `save_post_rts_subscriber`\n- `delete_post`\n- `admin_post_rts_import_csv`\n- `admin_post_rts_export_csv`\n- `wp_ajax_rts_import_progress`\n- `wp_ajax_rts_cancel_import`\n- `rts_process_import_chunk`\n- `rts_cleanup_import_sessions`\n- (+20 more)\n\n\n## Important Notes for AI Agents\n1. Do not invent endpoints, hooks, or option keys. Use what exists in the scan output.\n2. Prefer small, reversible commits. Avoid sweeping refactors unless explicitly requested.\n3. If a file appears truncated, request chunk summaries or use skeletonized output.\n4. Always consider WordPress hosting constraints (file permissions, object caching, memory limits).\n\n## File Index (Top 40)\n- `subscribers/includes/class-analytics.php`\n- `subscribers/includes/class-csv-importer.php`\n- `subscribers/includes/class-email-engine.php`\n- `subscribers/includes/class-email-queue.php`\n- `subscribers/includes/class-email-renderer.php`\n- `subscribers/includes/class-email-templates.php`\n- `subscribers/includes/class-newsletter-cpt.php`\n- `subscribers/includes/class-smtp-settings.php`\n- `subscribers/includes/class-subscriber-cpt.php`\n- `subscribers/includes/class-subscription-form.php`\n- `subscribers/includes/class-unsubscribe.php`\n- `subscribers/admin/class-admin-menu.php`\n- `subscribers/admin/class-subscriber-list.php`\n- `subscribers/class-database-installer.php`\n- `subscribers/class-rts-subscriber-system.php`\n- `inc/admin-preview.php`\n- `inc/ally-widget.php`\n- `inc/cpt-letters-complete.php`\n- `inc/feedback-system.php`\n- `inc/rts-admin-manual.php`\n- `inc/rts-bulk-jobs.php`\n- `inc/rts-content-refiner.php`\n- `inc/rts-context-aware-safety.php`\n- `inc/rts-embed-shortcodes.php`\n- `inc/rts-google-translate.php`\n- `inc/rts-learning-dashboard.php`\n- `inc/rts-learning-engine.php`\n- `inc/rts-moderation-engine.php`\n- `inc/rts-moderation-learning.php`\n- `inc/rts-multilingual.php`\n- `inc/rts-quick-exit.php`\n- `inc/rts-rest-api.php`\n- `inc/rts-streaming-importer.php`\n- `inc/rts-workflow-admin.php`\n- `inc/rts-workflow-badges.php`\n- `inc/rts-workflow.php`\n- `inc/rts-zombie-queue-hard-reset.php`\n- `inc/security.php`\n- `inc/shortcodes.php`\n- `assets/js/rts-dashboard.js`\n- (+10 more)\n\n## Scan Completeness Signals\nA scan is considered *complete* when the following high-level sections are present (even if some are empty due to scan mode limits):\n- `summary` (target label, mode, timestamps where available)\n- `structure` (classes/functions/hooks indices)\n- `index` (semantic index: ajax/rest/shortcodes/options/settings/assets/etc.)\n- `behaviour_index` (runtime registries and risk flags where available)\n- `integrations` (detected third-party integrations, if any)\n- `files` (file index; full contents may be omitted or chunked in lighter modes)\n\n### Mode Expectations\n- Minimal/Fast modes may omit full file contents and deep behaviour parsing, but must still provide `structure`, `index`, and a file list.\n- Balanced modes should include behaviour parsing and key registries (AJAX/REST/cron/shortcodes/admin).\n- Deep/Max modes should include as much file content as allowed (or chunked), plus comprehensive indices.\n\n## Data Storage Map (How state persists)\nUse this to avoid breaking existing installs. Identify *exact* option keys and their schemas.\n\n### Detected option usage (best-effort)\n\n### Settings registration (schema hints)\n- (No `register_setting()` usage detected. If this is a theme, settings may live in theme mods or customizer.)\n\n### What AI must infer from code (do not guess)\nFor each persistent key, confirm:\n- Schema shape (array/object/string)\n- Default values and merge strategy\n- Autoload flag (yes/no)\n- Migration version gates (if any)\n\n## Permission & Security Rules\nAI must preserve security checks. For any admin-facing action, identify the capability and nonce rules directly from code.\n\n### Required checks to locate\n- Capability checks: `current_user_can(...)` (map capability per action)\n- Nonce checks: `check_ajax_referer(...)` / `wp_verify_nonce(...)` (record action + field name)\n- Admin-only endpoints: `wp_ajax_...` (and whether a `wp_ajax_nopriv_...` exists)\n\n### Detected AJAX actions (entry points)\n- `rts_import_progress` (in `subscribers/includes/class-csv-importer.php`)\n- `rts_cancel_import` (in `subscribers/includes/class-csv-importer.php`)\n- `rts_newsletter_test_send` (in `subscribers/includes/class-newsletter-cpt.php`)\n- `rts_newsletter_send_all` (in `subscribers/includes/class-newsletter-cpt.php`)\n- `rts_newsletter_progress` (in `subscribers/includes/class-newsletter-cpt.php`)\n- `rts_insert_random_letter` (in `subscribers/includes/class-newsletter-cpt.php`)\n- `rts_test_smtp` (in `subscribers/includes/class-smtp-settings.php`)\n- `rts_handle_subscription` (in `subscribers/class-rts-subscriber-system.php`)\n- `nopriv_rts_handle_subscription` (in `subscribers/class-rts-subscriber-system.php`)\n- `rts_track_share` (in `inc/rts-moderation-engine.php`)\n- `nopriv_rts_track_share` (in `inc/rts-moderation-engine.php`)\n- `rts_record_feedback_ajax` (in `inc/rts-moderation-learning.php`)\n- `rts_random_letter` (in `inc/rts-rest-api.php`)\n- `nopriv_rts_random_letter` (in `inc/rts-rest-api.php`)\n- `nopriv_rts_submit_letter` (in `inc/shortcodes.php`)\n- `rts_submit_letter` (in `inc/shortcodes.php`)\n\n### Admin-only determination\nIf an action is only registered via `wp_ajax_` and there is no `wp_ajax_nopriv_` handler, treat it as authenticated-only.\n\n## Output Contract (API schema your UI expects)\nWhen generating or consuming context packs, do not break response keys. The UI depends on stable contracts.\n\n### `aicb_generate_context` success payload\nThe server returns JSON (via `wp_send_json_success`) with these keys:\n- `scan_id` (string)\n- `summary` (object: file_count, total_size, total_size_raw, class_count, function_count, hook_count, complexity_score, est_tokens)\n- `context` (string; may be empty if `context_truncated=true`)\n- `context_preview` (string preview; not guaranteed JSON-safe)\n- `context_truncated` (boolean)\n- `context_format` (string: json|md|text)\n- `agent_md` (string; may be truncated in preview)\n- `meta`, `stats`, `target` (objects)\n\n### Truncation rules\n- If clipboard output exceeds the server cap, `context` becomes an empty string and `context_truncated=true`.\n- Use `summary` for dashboard stats; do not `JSON.parse(context)` when `context_truncated=true`.\n\n### Error payload\nOn failure (`wp_send_json_error`), expect a structured error object. Preserve `message`, and any diagnostic keys, but do not assume shape beyond standard WP AJAX error responses.\n\n### Download routes\nDownload endpoints should return raw file content (MD/JSON) and must not embed HTML. Prefer stable filenames and ensure content is generated from stored payloads.\n\n## Extend Here\nAdd scan modules in `includes/Traits/ScanningEngine.php` (behaviour index + integrations) and `includes/Traits/AiOptimization.php` (semantic index).\nAdd output formats and download handlers in `includes/Traits/ContextLibrary.php` and `includes/Core/BridgeCore.php`.\nWizard UI lives in `assets/js/wizard-app.js` and must not depend on parsing large clipboard JSON for dashboard stats.\n",
  "meta": {
    "scan_id": "scan_698bf5369fb690.96417011",
    "model": "gemini-3.0-pro",
    "detail_level": "deep",
    "generated_at": "2026-02-11T03:19:18+00:00"
  },
  "stats": {
    "file_count": 50,
    "total_size": "1.38 MB",
    "total_size_raw": 1450481,
    "class_count": 44,
    "function_count": 612,
    "hook_count": 147,
    "complexity_score": "High",
    "est_tokens": 362620,
    "cache_hits": 0,
    "cache_misses": 44,
    "cache_hit_rate": 0,
    "files": 50,
    "bytes": 1450481
  },
  "target": {
    "type": "theme",
    "slug": "Hello-Elementor-Child-RTS-v5.2.27",
    "name": "Hello-Elementor-Child-RTS-v5.2.27",
    "path": "/home/u363235284/domains/inkfire.co.uk/public_html/reasonstostay/wp-content/themes/Hello-Elementor-Child-RTS-v5.2.27"
  }
}